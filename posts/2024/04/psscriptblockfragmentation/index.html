<!doctype html><html lang=en dir=ltr><head><title>*PowerView* is evil, but *PowerVi* and *ew* are legit, right? - Missing signature-based detections due to PowerShell Script Block Logging Fragmentation :: lolcads tech blog</title>
<meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="PowerView is evil, but PowerVi and ew are legit, right? - Missing signature-based detections due to PowerShell Script Block Logging Fragmentation Update [15/08/2024]: In a short discussion on X the source code of the PowerShell Script Block Fragmentation was linked . Looking at the comment in the code, it becomes clear that the size of a script block fragment is intentionally set to a random value in order to deny attackers the easy possibility to split their scripts as they wish."><meta name=keywords content=","><meta name=robots content="noodp"><link rel=manifest href=/manifest.json><meta property="og:url" content="https://lolcads.github.io/posts/2024/04/psscriptblockfragmentation/"><meta property="og:site_name" content="lolcads tech blog"><meta property="og:title" content="*PowerView* is evil, but *PowerVi* and *ew* are legit, right? - Missing signature-based detections due to PowerShell Script Block Logging Fragmentation"><meta property="og:description" content="[Sigma](https://github.com/SigmaHQ/sigma) offers more than 3000 rules for signature-based threat detection. 140 of these rules aim to detect suspicious/malicious PowerShell scripts by looking into PowerShell script block logs. Fragmentation of script blocks during Script Block Logging results in varying number of alerts when loading the same script multiple times. On the one hand, there is a trend of more alerts being generated when the script is split into more fragments (which is fine), but on the other hand, the fragmentation of scripts into blocks may result in missed detections. "><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-04-15T11:01:40+02:00"><meta property="article:modified_time" content="2024-04-15T11:01:40+02:00"><meta property="article:tag" content="SIEM"><meta property="article:tag" content="ThreatDetection"><meta property="article:tag" content="Sigma"><meta property="article:tag" content="PowerShell"><meta property="article:tag" content="ScriptBlockLogging"><meta property="article:tag" content="Forensics"><meta name=twitter:card content="summary"><meta name=twitter:title content="*PowerView* is evil, but *PowerVi* and *ew* are legit, right? - Missing signature-based detections due to PowerShell Script Block Logging Fragmentation"><meta name=twitter:description content="[Sigma](https://github.com/SigmaHQ/sigma) offers more than 3000 rules for signature-based threat detection. 140 of these rules aim to detect suspicious/malicious PowerShell scripts by looking into PowerShell script block logs. Fragmentation of script blocks during Script Block Logging results in varying number of alerts when loading the same script multiple times. On the one hand, there is a trend of more alerts being generated when the script is split into more fragments (which is fine), but on the other hand, the fragmentation of scripts into blocks may result in missed detections. "><link rel=canonical href=https://lolcads.github.io/posts/2024/04/psscriptblockfragmentation/><link rel="shortcut icon" href=/favicon.ico><link rel=stylesheet href=/css/index.min.5d96433bd17079764d5a8866addd6d7848ea8295977a06688f43c5be97af544e.css></head><body class="flex flex-col min-h-screen w-full bg-slate-50 dark:bg-gray-800"><header class="flex flex-none justify-center z-10"><div class="flex flex-row gap justify-between w-full max-w-4xl lg:max-w-5xl h-12 mt-3"><div class="flex-none ml-2 md:ml-0"><a href=/><img class="h-12 w-12 rounded-full object-cover bg-gray-100" src=/logo.png alt=logo></a></div><div class=flex-1></div><div class=flex-none><nav class="h-full static"><button id=navbar-menu-toggle type=button class="inline-flex items-center p-2 text-sm text-slate-800 dark:text-slate-200 rounded-lg md:hidden" aria-controls=navbar-menu aria-expanded=false>
<span class=sr-only>Open main menu</span>
<i class="w-8 h-8"><svg class="icon icon-tabler icon-tabler-menu-2" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 6h16"/><path d="M4 12h16"/><path d="M4 18h16"/></svg></i></button><div class="absolute md:static top-16 left-0 right-0 z-50 hidden w-full md:block md:w-auto" id=navbar-menu><ul class="flex flex-col mx-2 md:mx-0 md:flex-row md:border-0 rounded-sm md:rounded-full px-3 text-base font-medium text-slate-800 dark:text-slate-200 shadow-lg bg-white dark:bg-gray-600 shadow-slate-800/5 dark:shadow-slate-200/5 ring-1 ring-slate-900/5 dark:ring-slate-100/5"><li id=post><a class="block px-3 py-3 hover:text-emerald-600 text-emerald-600" href=/posts/ title=Blog>Blog</a></li><li id=about><a class="block px-3 py-3 hover:text-emerald-600" href=/about/ title=About>About</a></li><li id=contact><a class="block px-3 py-3 hover:text-emerald-600" href=/contact/ title=Contact>Contact</a></li></ul></div></nav></div><div class="flex-none mx-1"></div><div class="flex-none md:hidden"><a href=/search/ class="inline-flex items-center p-2 text-sm text-slate-800 dark:text-slate-200 rounded-lg" aria-controls=navbar-menu aria-expanded=false><span class=sr-only>Search</span>
<i class="w-8 h-8"><svg class="icon icon-tabler icon-tabler-search" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M10 10m-7 0a7 7 0 1014 0A7 7 0 103 10"/><path d="M21 21l-6-6"/></svg></i></a></div><div class="darkmode-toggle flex flex-none mr-2 md:mr-0"><label for=darkmode-toggle class="flex items-center px-3 cursor-pointer rounded-full bg-gray-100 dark:bg-gray-600" title="Toggle dark mode"><input name=darkmode-toggle id=darkmode-toggle type=checkbox class="sr-only peer" aria-label="Toggle dark mode"><div class="group flex flex-row gap-1 justify-center h-8 px-1 rounded-full bg-white dark:bg-gray-700"><i class="h-6 w-6 flex-none rounded-full bg-yellow-400 place-self-center peer-checked:group-[]:invisible"><svg class="icon icon-tabler icon-tabler-brightness-down" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 12m-3 0a3 3 0 106 0 3 3 0 10-6 0"/><path d="M12 5v.01"/><path d="M17 7v.01"/><path d="M19 12v.01"/><path d="M17 17v.01"/><path d="M12 19v.01"/><path d="M7 17v.01"/><path d="M5 12v.01"/><path d="M7 7v.01"/></svg>
</i><i class="h-6 w-6 flex-none rounded-full place-self-center invisible peer-checked:group-[]:visible"><svg class="icon icon-tabler icon-tabler-moon-stars" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 3c.132.0.263.0.393.0a7.5 7.5.0 007.92 12.446A9 9 0 1112 2.992z"/><path d="M17 4a2 2 0 002 2 2 2 0 00-2 2 2 2 0 00-2-2 2 2 0 002-2"/><path d="M19 11h2m-1-1v2"/></svg></i></div></label></div></div></header><main class="flex flex-auto justify-center"><div class="w-full max-w-4xl lg:max-w-5xl"><div class="flex flex-col mt-6 mx-2 md:mx-0 rounded-lg overflow-hidden shadow-md bg-white dark:bg-gray-700"><div><a href=/posts/2024/04/psscriptblockfragmentation/></a></div><div class="flex flex-col gap-y-3 p-6"><h1 class="text-4xl font-semibold text-slate-800 dark:text-slate-100"><a href=/posts/2024/04/psscriptblockfragmentation/><em>PowerView</em> is evil, but <em>PowerVi</em> and <em>ew</em> are legit, right? - Missing signature-based detections due to PowerShell Script Block Logging Fragmentation</a></h1><h2 class="my-4 text-large text-slate-600 dark:text-slate-300"><a href=https://github.com/SigmaHQ/sigma target=_blank rel=noopener>Sigma</a>
offers more than 3000 rules for signature-based threat detection. 140 of these rules aim to detect suspicious/malicious PowerShell scripts by looking into PowerShell script block logs. Fragmentation of script blocks during Script Block Logging results in varying number of alerts when loading the same script multiple times. On the one hand, there is a trend of more alerts being generated when the script is split into more fragments (which is fine), but on the other hand, the fragmentation of scripts into blocks may result in missed detections.</h2><ul class="flex flex-row flex-wrap text-slate-500 dark:text-slate-300"><li><a href=/tags/siem/ class="flex flex-row text-sm mr-2 py-1"><i class="h-5 w-5 flex-none"><svg class="icon icon-tabler icon-tabler-hash" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 9h14"/><path d="M5 15h14"/><path d="M11 4 7 20"/><path d="M17 4l-4 16"/></svg>
</i><span class=ml-0>SIEM</span></a></li><li><a href=/tags/threatdetection/ class="flex flex-row text-sm mr-2 py-1"><i class="h-5 w-5 flex-none"><svg class="icon icon-tabler icon-tabler-hash" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 9h14"/><path d="M5 15h14"/><path d="M11 4 7 20"/><path d="M17 4l-4 16"/></svg>
</i><span class=ml-0>ThreatDetection</span></a></li><li><a href=/tags/sigma/ class="flex flex-row text-sm mr-2 py-1"><i class="h-5 w-5 flex-none"><svg class="icon icon-tabler icon-tabler-hash" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 9h14"/><path d="M5 15h14"/><path d="M11 4 7 20"/><path d="M17 4l-4 16"/></svg>
</i><span class=ml-0>Sigma</span></a></li><li><a href=/tags/powershell/ class="flex flex-row text-sm mr-2 py-1"><i class="h-5 w-5 flex-none"><svg class="icon icon-tabler icon-tabler-hash" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 9h14"/><path d="M5 15h14"/><path d="M11 4 7 20"/><path d="M17 4l-4 16"/></svg>
</i><span class=ml-0>PowerShell</span></a></li><li><a href=/tags/scriptblocklogging/ class="flex flex-row text-sm mr-2 py-1"><i class="h-5 w-5 flex-none"><svg class="icon icon-tabler icon-tabler-hash" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 9h14"/><path d="M5 15h14"/><path d="M11 4 7 20"/><path d="M17 4l-4 16"/></svg>
</i><span class=ml-0>ScriptBlockLogging</span></a></li><li><a href=/tags/forensics/ class="flex flex-row text-sm mr-2 py-1"><i class="h-5 w-5 flex-none"><svg class="icon icon-tabler icon-tabler-hash" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 9h14"/><path d="M5 15h14"/><path d="M11 4 7 20"/><path d="M17 4l-4 16"/></svg>
</i><span class=ml-0>Forensics</span></a></li></ul><div class="flex flex-col gap-y-1 md:flex-row md:gap-y-0 md:gap-x-4 text-slate-500 dark:text-slate-300"><div class="flex flex-row text-base gap-x-1"><i class="h-6 w-6 flex-none"><svg class="icon icon-tabler icon-tabler-calendar" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 7a2 2 0 012-2h12a2 2 0 012 2v12a2 2 0 01-2 2H6a2 2 0 01-2-2V7z"/><path d="M16 3v4"/><path d="M8 3v4"/><path d="M4 11h16"/><path d="M11 15h1"/><path d="M12 15v3"/></svg>
</i><time datetime=2024-04-15T11:01:40+02:00>2024-04-15</time></div><div class="flex flex-row text-base gap-x-1"><i class="h-6 w-6 flex-none"><svg class="icon icon-tabler icon-tabler-hourglass-high" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M6.5 7h11"/><path d="M6 20v-2a6 6 0 1112 0v2a1 1 0 01-1 1H7a1 1 0 01-1-1z"/><path d="M6 4v2a6 6 0 1012 0V4a1 1 0 00-1-1H7A1 1 0 006 4z"/></svg>
</i><span>8 minutes to read</span></div></div><section class="prose prose-slate dark:prose-invert w-full max-w-4xl lg:max-w-5xl mt-6"><h2>Table of Contents</h2><aside><nav id=TableOfContents><ul><li><a href=#update-15082024>Update [15/08/2024]:</a></li><li><a href=#introduction>Introduction</a></li><li><a href=#the-uncertainty-of-script-block-logging>The Uncertainty of Script Block Logging</a></li><li><a href=#more-script-blocks---more-alerts>More script blocks -> More alerts?</a></li><li><a href=#more-script-blocks---less-alerts>More script blocks -> Less alerts??</a></li><li><a href=#the-case-of-split-powerview>The case of split &ldquo;<em>PowerVi/ew</em>&rdquo;</a></li><li><a href=#losing-alerts>Losing alerts</a></li><li><a href=#conclusion>Conclusion</a></li></ul></nav></aside></section><article class="mt-6 w-full max-w-4xl lg:max-w-5xl prose prose-slate dark:prose-invert prose-quoteless post-content"><h1 id=powerview-is-evil-but-powervi-and-ew-are-legit-right---missing-signature-based-detections-due-to-powershell-script-block-logging-fragmentation><em>PowerView</em> is evil, but <em>PowerVi</em> and <em>ew</em> are legit, right? - Missing signature-based detections due to PowerShell Script Block Logging Fragmentation</h1><h2 id=update-15082024>Update [15/08/2024]:</h2><p>In a <a href=https://x.com/nas_bench/status/1806253324456403316 target=_blank rel=noopener>short discussion on X</a>
the source code of the PowerShell Script Block Fragmentation was <a href=https://github.com/PowerShell/PowerShell/blob/7ec8e4ed8f47e81e70de5353500f8a01d5fe396c/src/System.Management.Automation/engine/runtime/CompiledScriptBlock.cs#L1451-L1454 target=_blank rel=noopener>linked</a>
.
Looking at the comment in the code, it becomes clear that the size of a script block fragment is intentionally set to a random value in order to deny attackers the easy possibility to split their scripts as they wish.
If a script block is larger than 20000 (Unicode) characters, it is split into fragments with sizes 10000 plus a random value between 0 and 10000 - resulting in script block sizes from 10000 to 20000 characters.
Further research is needed to answer the question if and how the fragmentation of PowerShell script blocks can still be exploited.</p><p><strong>TL;DR:</strong> Sigma rules and similar signature-based threat detection measures may miss malicious PowerShell scripts due to unpredictable fragmentation of script block logs.</p><h2 id=introduction>Introduction</h2><p><a href=https://github.com/SigmaHQ/sigma target=_blank rel=noopener>Sigma</a>
offers more than 3000 rules for signature-based threat detection. 140 of these rules aim to detect suspicious/malicious PowerShell scripts by looking into PowerShell script block logs. Fragmentation of script blocks during Script Block Logging results in varying number of alerts when loading the same script multiple times. On the one hand, there is a trend of more alerts being generated when the script is split into more fragments (which is fine), but on the other hand, the fragmentation of scripts into blocks may result in missed detections.</p><p>I know this is a lot, but bear with me as I tell you the whole story. If you are only interested in the juicy part, you can skip to &lsquo;The case of split &ldquo;PowerVi/ew&rdquo;&rsquo;.</p><h2 id=the-uncertainty-of-script-block-logging>The Uncertainty of Script Block Logging</h2><p><a href=https://devblogs.microsoft.com/powershell/powershell-the-blue-team/ target=_blank rel=noopener>It is known</a>
that when loading a very large script, PowerShell breaks it into multiple parts before logging them - sometimes resulting in dozens of fragments. To illustrate this behavior, we loaded the well-known <a href=https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1 target=_blank rel=noopener>PowerView</a>
script a total of 10 times (on the same machine and configuration) and recorded into how many block fragments it was broken. The results are shown in the table below.</p><table><thead><tr><th>Run</th><th>1</th><th>2</th><th>3</th><th>4</th><th>5</th><th>6</th><th>7</th><th>8</th><th>9</th><th>10</th></tr></thead><tbody><tr><td># Blocks</td><td>54</td><td>76</td><td>57</td><td>49</td><td>64</td><td>57</td><td>55</td><td>69</td><td>39</td><td>47</td></tr></tbody></table><p>We can see that the number of blocks ranges from 39 to 76, which is quite a significant difference.</p><h2 id=more-script-blocks---more-alerts>More script blocks -> More alerts?</h2><p>Now, when using Sigma rules that operate on single logged ScriptBlockTexts, the number of generated alerts might differ because the number of logged blocks differs. More specific, the number of generated alerts usually increases with increasing number of blocks, because the malicious/suspicious strings were found in more blocks. Using &ldquo;all rules&rdquo; from Sigma release <a href=https://github.com/SigmaHQ/sigma/releases/tag/r2024-03-11 target=_blank rel=noopener>r2024-03-11</a>
and the 10 recorded PowerView loadings, the following number of alerts were generated using <a href=https://github.com/WithSecureLabs/chainsaw target=_blank rel=noopener>Chainsaw</a>
(sorted by number of blocks).</p><table><thead><tr><th>Blocks</th><th>39</th><th>47</th><th>49</th><th>54</th><th>55</th><th>57</th><th>57</th><th>64</th><th>69</th><th>76</th></tr></thead><tbody><tr><td>Alarms</td><td>79</td><td>91</td><td>94</td><td>103</td><td>99</td><td>106</td><td>107</td><td>110</td><td>119</td><td>126</td></tr><tr><td>&mldr; raised on &mldr; blocks</td><td>39</td><td>46</td><td>48</td><td>53</td><td>53</td><td>56</td><td>56</td><td>60</td><td>65</td><td>70</td></tr></tbody></table><p>Here, we see that the number of alarms usually increases with the number of blocks - that is the expected behavior. The only run that does not match this trend is the one that generated 55 script blocks. Here, less alerts are generated than in the run generating 54 script blocks. Although this behavior leads to inconsistency, it can be considered &ldquo;not too bad&rdquo; since in some cases more alerts are generated than in other cases, but overall we still catch everything, right?</p><h2 id=more-script-blocks---less-alerts>More script blocks -> Less alerts??</h2><p>To investigate how the number of blocks influences the number of generated alerts, we further looked into the generated alarms. Below, the number of generated alerts for each triggered rule is listed for each of the 10 runs.</p><table><thead><tr><th>Rule / Run#Blocks</th><th>9#39</th><th>10#47</th><th>4#49</th><th>1#54</th><th>7#55</th><th>3#57</th><th>6#57</th><th>5#64</th><th>8#69</th><th>2#76</th><th>AVG</th></tr></thead><tbody><tr><td>Total</td><td>79</td><td>91</td><td>94</td><td>103</td><td>99</td><td>106</td><td>107</td><td>110</td><td>119</td><td>126</td><td>103.4</td></tr><tr><td>Execute Invoke-command on Remote Host</td><td>5</td><td>6</td><td>6</td><td>6</td><td>6</td><td>7</td><td>6 [2]</td><td>7</td><td>7</td><td>7</td><td>6.3</td></tr><tr><td>Malicious PowerShell Commandlets - ScriptBlock</td><td>35</td><td>42</td><td>43</td><td>49</td><td>46</td><td>51</td><td>51</td><td>53</td><td>58</td><td>61</td><td>48.9</td></tr><tr><td>Malicious PowerShell Keywords</td><td>3</td><td>2</td><td>2</td><td>2</td><td>2</td><td>2</td><td>3</td><td>2</td><td>3</td><td>2</td><td>2.3</td></tr><tr><td>Manipulation of User Computer or Group Security Principals Across AD</td><td>4</td><td>4</td><td>4</td><td>6 [3]</td><td>4</td><td>4</td><td>4</td><td>4</td><td>4</td><td>&lt;5></td><td>4.3</td></tr><tr><td>Potential In-Memory Execution Using Reflection.Assembly</td><td>1</td><td>1</td><td>1</td><td>1</td><td>1</td><td>1</td><td>1</td><td>1</td><td>1</td><td>1</td><td>1</td></tr><tr><td>Potential Suspicious PowerShell Keywords</td><td>1 [1]</td><td>2</td><td>2</td><td>2</td><td>2</td><td>2</td><td>2</td><td>2</td><td>2</td><td>2</td><td>1.9</td></tr><tr><td>PowerView PowerShell Cmdlets - ScriptBlock</td><td>27</td><td>30</td><td>32</td><td>34</td><td>35</td><td>35</td><td>36</td><td>38</td><td>40</td><td>45</td><td>35.2</td></tr><tr><td>Request A Single Ticket via PowerShell</td><td>1</td><td>1</td><td>1</td><td>1</td><td>1</td><td>1</td><td>1</td><td>1</td><td>&lt;2> +1 because of script block cut-off</td><td>1</td><td>1.1</td></tr><tr><td>Usage Of Web Request Commands And Cmdlets - ScriptBlock</td><td>1</td><td>1</td><td>1</td><td>1</td><td>1</td><td>1</td><td>1</td><td>1</td><td>1</td><td>1</td><td>1</td></tr></tbody></table><p>First, let&rsquo;s look at some results that were expected.</p><p>[1] Potential Suspicious PowerShell Keywords: When having only 39 script block fragments, only 1 alarm is generated because all the &ldquo;suspicious&rdquo; strings fitted into the first block - because it is larger compared to the other cases.</p><p>[2] Execute Invoke-command on Remote Host: Goes from 5 to 7 raised alerts - increasing with the number of blocks because the search strings are found in more blocks. Only run 6 with 57 blocks is an outlier, producing less alerts than run 3 with the <em>same amount</em> of 57 blocks. This is getting suspicious..</p><p>[3] Manipulation of User Computer or Group Security Principals Across AD: In all but two runs exactly 4 alarms are generated. The run that raised 5 alarms was the one with the largest number of blocks - so this behavior is expected - but the one with the most alarms (6) only created 54 blocks. Further investigation showed that this is the result of the &ldquo;random&rdquo; script fragmentation, where all 6 &ldquo;suspicious&rdquo; strings were found in 6 different blocks, where in the other runs multiple strings where found in a single block resulting in less alerts.</p><p>Okay, so these results are kind of expected and not too bad. So we should be fine, right?</p><p>Well, when investigating the results of the rule <a href=https://github.com/SigmaHQ/sigma/blob/4319f5807ff4eb8035ecf1a8f86ab3bdc1ab8960/rules/windows/powershell/powershell_script/posh_ps_malicious_commandlets.yml target=_blank rel=noopener>Malicious PowerShell Commandlets - ScriptBlock</a>
, a case came true that we thought was extremely unlikely.</p><h2 id=the-case-of-split-powerview>The case of split &ldquo;<em>PowerVi/ew</em>&rdquo;</h2><p>Among others, the rule <a href=https://github.com/SigmaHQ/sigma/blob/4319f5807ff4eb8035ecf1a8f86ab3bdc1ab8960/rules/windows/powershell/powershell_script/posh_ps_malicious_commandlets.yml target=_blank rel=noopener>Malicious PowerShell Commandlets - ScriptBlock</a>
, detects the string &ldquo;PowerView&rdquo; inside script blocks. Now, comparing two different runs, run3 with 57 blocks generated 51 alerts and run2 with 76 blocks generated 61 alerts for this rule. So more blocks -> more alerts, this is fine. But, looking deeper into the script blocks and generated alerts, we noticed something at the end of script block 38 of 57 of run 3.</p><pre tabindex=0><code>Add-Member Noteproperty &#39;Comment&#39; $Info.lgrpi1_comment\n
$LocalGroup.PSObject.TypeNames.Insert(0, &#39;PowerVi
</code></pre><hr><p>And the beginning of script block 39 of 57:</p><pre tabindex=0><code>ew.LocalGroup.API&#39;)\n
</code></pre><p>So, in this case the PowerView script was fragmented in such a way, that a string that should have been detected was no longer detected, i.e., &ldquo;PowerView&rdquo; was split into &ldquo;PowerVi&rdquo; and &ldquo;ew&rdquo;. (To be fair, script block 38 still raised an alarm because the string &ldquo;PowerView&rdquo; occures in it multiple times, but still this example illustrates the problem at hand.)</p><h2 id=losing-alerts>Losing alerts</h2><p>This shows, that depending on the fragmentation of script blocks, we can indeed lose alerts and miss contents of scripts that should be detected, e.g., by strings split into two parts in two different blocks. But there are other cases: Rules like <a href=https://github.com/SigmaHQ/sigma/blob/49adcf9a00247ed6c3daacba03b589470f6716d0/rules/windows/powershell/powershell_script/posh_ps_invoke_command_remote.yml target=_blank rel=noopener>Execute Invoke-command on Remote Host</a>
detect multiple strings in a single script block (<code>ScriptBlockText|contains|all</code>). Now, when one of those strings is randomly put into a different block, the rule no longer triggers. Although this case should be more likely than the case of &ldquo;search strings split in two&rdquo;, the 10 simulations did not result in such a case since the number of alerts for this specific rule is much smaller (only 5-7 alarms compared to 35-61 for &ldquo;Malicious PowerShell Commandlets - ScriptBlock&rdquo;).</p><h2 id=conclusion>Conclusion</h2><p>We learned that loading the PowerView script multiple times results in fragmentations of it ranging from 39 to 76 blocks. The alerts raised on these script blocks showed the trend of increasing number of alerts with increasing number of script blocks. Although this behavior adds uncertainty to the generation of alerts, it is of no critical nature. But, another example showed, that the fragmentation of scripts into blocks might result in suspicious/malicious strings being split into two blocks, resulting in a case where the search strings could not be found and the detection is completely missed. Furthermore, when searching for multiple strings in a single block, the fragmentation of scripts might result in these strings being split into two different blocks - where detection is also no longer possible.</p><p><strong>Is there a remedy?</strong> Maybe re-combining script fragments (<a href=https://news.sophos.com/en-us/2022/03/29/reconstructing-powershell-scripts-from-multiple-windows-event-logs/ target=_blank rel=noopener>like this</a>
) to run detection mechanisms on the reconstructed scripts?</p><p><strong>Sidenote:</strong> To add, this behavior might also be leveraged by malicious actors to avoid detection&mldr;</p><p>The described findings were observed on a Windows 10 host with PowerShell Version 5.1 and PowerShell logging configurations according to the <a href=https://www.cyber.gov.au/sites/default/files/2023-03/PROTECT%20-%20Windows%20Event%20Logging%20and%20Forwarding%20%28October%202021%29.pdf target=_blank rel=noopener>recommendations by the Australian Cyber Security Centre (ACSC)</a>
which include PowerShell Module and PowerShell Script Block Logging.</p></article></div></div></div></main><footer class="flex flex-none justify-center"><section class="flex flex-col md:flex-row mx-2 md:mx-0 gap-2 md:gap-0 justify-between w-full max-w-4xl lg:max-w-5xl py-6 text-slate-500 dark:text-slate-300"><div class="flex flex-row"></div><div class=grow></div><div class="flex flex-row"><i class="h-6 w-6 flex-none"><svg class="icon icon-tabler icon-tabler-copyright" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 12m-9 0a9 9 0 1018 0A9 9 0 103 12"/><path d="M14 9.75a3.016 3.016.0 00-4.163.173 2.993 2.993.0 000 4.154A3.016 3.016.0 0014 14.25"/></svg>
</i>2022 - 2024 lolcads</div><div class="flex flex-row"><span class="ml-0 pl-0 md:ml-2 md:pl-2 border-l-0 md:border-l border-slate-300 dark:border-slate-400">Powered by <a href=https://gohugo.io target=_blank rel=noopener class=underline>Hugo</a> <span class=text-red-600>&#9829;</span> <a href=https://github.com/tomowang/hugo-theme-tailwind target=_blank rel=noopener class=underline>Tailwind</a></span></div></section></footer><script src=/main.min.c6372b6836971865bd94bfde974748aca8415824a2facab6ccd66a87384bfacb.js></script><div class="hidden top-1 right-1" id=code-copy><i class="h-6 w-6 block"><svg class="icon icon-tabler icon-tabler-copy" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M7 7m0 2.667A2.667 2.667.0 019.667 7h8.666A2.667 2.667.0 0121 9.667v8.666A2.667 2.667.0 0118.333 21H9.667A2.667 2.667.0 017 18.333z"/><path d="M4.012 16.737A2.005 2.005.0 013 15V5c0-1.1.9-2 2-2h10c.75.0 1.158.385 1.5 1"/></svg></i></div><div class="hidden top-1 right-1" id=code-copy-done><i class="h-6 w-6 block"><svg class="icon icon-tabler icon-tabler-check" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 12l5 5L20 7"/></svg></i></div><script src=/code-copy.min.e7b2a74adef1ed474c335c8bd5e7832b2316b8842b0f9184d65286c5bd64f51a.js></script></body></html>