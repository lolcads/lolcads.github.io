<!doctype html><html lang=en dir=ltr><head><title>E²VA: Android Basics (Part 2) :: lolcads tech blog</title>
<meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Android Binary Exploitation In this post, we will examine security mechanisms that Android 12 employs in order to make binary exploitation a bit harder. Also, we will discuss how to get to certain information like shared - object files that are necessary for successful exploitation. The latter will be generalized to getting limited source code access to an app given a corresponding .apk file.
Environment Before diving into details, the technical setup has to be clarified."><meta name=keywords content="Android,Binary Exploitation,JNI,E²VA"><meta name=robots content="noodp"><link rel=manifest href=/manifest.json><meta property="og:url" content="https://lolcads.github.io/posts/2024/07/eva_1/"><meta property="og:site_name" content="lolcads tech blog"><meta property="og:title" content="E²VA: Android Basics (Part 2)"><meta property="og:description" content="Android Binary Exploitation In this post, we will examine security mechanisms that Android 12 employs in order to make binary exploitation a bit harder. Also, we will discuss how to get to certain information like shared - object files that are necessary for successful exploitation. The latter will be generalized to getting limited source code access to an app given a corresponding .apk file.
Environment Before diving into details, the technical setup has to be clarified."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-07-22T16:46:21+01:00"><meta property="article:modified_time" content="2024-07-22T16:46:21+01:00"><meta property="article:tag" content="Android"><meta property="article:tag" content="Binary Exploitation"><meta property="article:tag" content="JNI"><meta property="article:tag" content="E²VA"><meta name=twitter:card content="summary"><meta name=twitter:title content="E²VA: Android Basics (Part 2)"><meta name=twitter:description content="Android Binary Exploitation In this post, we will examine security mechanisms that Android 12 employs in order to make binary exploitation a bit harder. Also, we will discuss how to get to certain information like shared - object files that are necessary for successful exploitation. The latter will be generalized to getting limited source code access to an app given a corresponding .apk file.
Environment Before diving into details, the technical setup has to be clarified."><link rel=canonical href=https://lolcads.github.io/posts/2024/07/eva_1/><link rel="shortcut icon" href=/favicon.ico><link rel=stylesheet href=/css/index.min.5d96433bd17079764d5a8866addd6d7848ea8295977a06688f43c5be97af544e.css></head><body class="flex flex-col min-h-screen w-full bg-slate-50 dark:bg-gray-800"><header class="flex flex-none justify-center z-10"><div class="flex flex-row gap justify-between w-full max-w-4xl lg:max-w-5xl h-12 mt-3"><div class="flex-none ml-2 md:ml-0"><a href=/><img class="h-12 w-12 rounded-full object-cover bg-gray-100" src=/logo.png alt=logo></a></div><div class=flex-1></div><div class=flex-none><nav class="h-full static"><button id=navbar-menu-toggle type=button class="inline-flex items-center p-2 text-sm text-slate-800 dark:text-slate-200 rounded-lg md:hidden" aria-controls=navbar-menu aria-expanded=false>
<span class=sr-only>Open main menu</span>
<i class="w-8 h-8"><svg class="icon icon-tabler icon-tabler-menu-2" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 6h16"/><path d="M4 12h16"/><path d="M4 18h16"/></svg></i></button><div class="absolute md:static top-16 left-0 right-0 z-50 hidden w-full md:block md:w-auto" id=navbar-menu><ul class="flex flex-col mx-2 md:mx-0 md:flex-row md:border-0 rounded-sm md:rounded-full px-3 text-base font-medium text-slate-800 dark:text-slate-200 shadow-lg bg-white dark:bg-gray-600 shadow-slate-800/5 dark:shadow-slate-200/5 ring-1 ring-slate-900/5 dark:ring-slate-100/5"><li id=post><a class="block px-3 py-3 hover:text-emerald-600 text-emerald-600" href=/posts/ title=Blog>Blog</a></li><li id=about><a class="block px-3 py-3 hover:text-emerald-600" href=/about/ title=About>About</a></li><li id=contact><a class="block px-3 py-3 hover:text-emerald-600" href=/contact/ title=Contact>Contact</a></li></ul></div></nav></div><div class="flex-none mx-1"></div><div class="flex-none md:hidden"><a href=/search/ class="inline-flex items-center p-2 text-sm text-slate-800 dark:text-slate-200 rounded-lg" aria-controls=navbar-menu aria-expanded=false><span class=sr-only>Search</span>
<i class="w-8 h-8"><svg class="icon icon-tabler icon-tabler-search" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M10 10m-7 0a7 7 0 1014 0A7 7 0 103 10"/><path d="M21 21l-6-6"/></svg></i></a></div><div class="darkmode-toggle flex flex-none mr-2 md:mr-0"><label for=darkmode-toggle class="flex items-center px-3 cursor-pointer rounded-full bg-gray-100 dark:bg-gray-600" title="Toggle dark mode"><input name=darkmode-toggle id=darkmode-toggle type=checkbox class="sr-only peer" aria-label="Toggle dark mode"><div class="group flex flex-row gap-1 justify-center h-8 px-1 rounded-full bg-white dark:bg-gray-700"><i class="h-6 w-6 flex-none rounded-full bg-yellow-400 place-self-center peer-checked:group-[]:invisible"><svg class="icon icon-tabler icon-tabler-brightness-down" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 12m-3 0a3 3 0 106 0 3 3 0 10-6 0"/><path d="M12 5v.01"/><path d="M17 7v.01"/><path d="M19 12v.01"/><path d="M17 17v.01"/><path d="M12 19v.01"/><path d="M7 17v.01"/><path d="M5 12v.01"/><path d="M7 7v.01"/></svg>
</i><i class="h-6 w-6 flex-none rounded-full place-self-center invisible peer-checked:group-[]:visible"><svg class="icon icon-tabler icon-tabler-moon-stars" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 3c.132.0.263.0.393.0a7.5 7.5.0 007.92 12.446A9 9 0 1112 2.992z"/><path d="M17 4a2 2 0 002 2 2 2 0 00-2 2 2 2 0 00-2-2 2 2 0 002-2"/><path d="M19 11h2m-1-1v2"/></svg></i></div></label></div></div></header><main class="flex flex-auto justify-center"><div class="w-full max-w-4xl lg:max-w-5xl"><div class="flex flex-col mt-6 mx-2 md:mx-0 rounded-lg overflow-hidden shadow-md bg-white dark:bg-gray-700"><div><a href=/posts/2024/07/eva_1/></a></div><div class="flex flex-col gap-y-3 p-6"><h1 class="text-4xl font-semibold text-slate-800 dark:text-slate-100"><a href=/posts/2024/07/eva_1/>E²VA: Android Basics (Part 2)</a></h1><ul class="flex flex-row flex-wrap text-slate-500 dark:text-slate-300"><li><a href=/tags/android/ class="flex flex-row text-sm mr-2 py-1"><i class="h-5 w-5 flex-none"><svg class="icon icon-tabler icon-tabler-hash" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 9h14"/><path d="M5 15h14"/><path d="M11 4 7 20"/><path d="M17 4l-4 16"/></svg>
</i><span class=ml-0>Android</span></a></li><li><a href=/tags/binary-exploitation/ class="flex flex-row text-sm mr-2 py-1"><i class="h-5 w-5 flex-none"><svg class="icon icon-tabler icon-tabler-hash" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 9h14"/><path d="M5 15h14"/><path d="M11 4 7 20"/><path d="M17 4l-4 16"/></svg>
</i><span class=ml-0>Binary Exploitation</span></a></li><li><a href=/tags/jni/ class="flex flex-row text-sm mr-2 py-1"><i class="h-5 w-5 flex-none"><svg class="icon icon-tabler icon-tabler-hash" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 9h14"/><path d="M5 15h14"/><path d="M11 4 7 20"/><path d="M17 4l-4 16"/></svg>
</i><span class=ml-0>JNI</span></a></li><li><a href=/tags/eva/ class="flex flex-row text-sm mr-2 py-1"><i class="h-5 w-5 flex-none"><svg class="icon icon-tabler icon-tabler-hash" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 9h14"/><path d="M5 15h14"/><path d="M11 4 7 20"/><path d="M17 4l-4 16"/></svg>
</i><span class=ml-0>E²VA</span></a></li></ul><div class="flex flex-col gap-y-1 md:flex-row md:gap-y-0 md:gap-x-4 text-slate-500 dark:text-slate-300"><div class="flex flex-row text-base gap-x-1"><i class="h-6 w-6 flex-none"><svg class="icon icon-tabler icon-tabler-calendar" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 7a2 2 0 012-2h12a2 2 0 012 2v12a2 2 0 01-2 2H6a2 2 0 01-2-2V7z"/><path d="M16 3v4"/><path d="M8 3v4"/><path d="M4 11h16"/><path d="M11 15h1"/><path d="M12 15v3"/></svg>
</i><time datetime=2024-07-22T16:46:21+01:00>2024-07-22</time></div><div class="flex flex-row text-base gap-x-1"><i class="h-6 w-6 flex-none"><svg class="icon icon-tabler icon-tabler-hourglass-high" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M6.5 7h11"/><path d="M6 20v-2a6 6 0 1112 0v2a1 1 0 01-1 1H7a1 1 0 01-1-1z"/><path d="M6 4v2a6 6 0 1012 0V4a1 1 0 00-1-1H7A1 1 0 006 4z"/></svg>
</i><span>20 minutes to read</span></div></div><section class="prose prose-slate dark:prose-invert w-full max-w-4xl lg:max-w-5xl mt-6"><h2>Table of Contents</h2><aside><nav id=TableOfContents><ul><li><a href=#environment>Environment</a></li><li><a href=#overview-of-security-mechanisms-on-android>Overview of Security Mechanisms on Android</a><ul><li><a href=#permissions>Permissions</a></li><li><a href=#fortify>FORTIFY</a></li><li><a href=#on-defeating-pies>On defeating PIEs</a></li><li><a href=#full-relro>Full RELRO</a></li><li><a href=#non---executable-stack-and-heap>Non - executable Stack (and Heap)</a></li><li><a href=#canaries-and-cookies>Canaries and cookies</a></li></ul></li><li><a href=#getting-the-source>Getting the source</a><ul><li><a href=#finding-the-apk-file>Finding the <em>apk</em> file</a></li><li><a href=#unpacking-apk-files>Unpacking <em>apk</em> files</a></li><li><a href=#getting-java-code>Getting Java code</a></li><li><a href=#grabbing-system-libraries>Grabbing System Libraries</a></li><li><a href=#analysing-the-stack-trace>Analysing the Stack Trace</a></li><li><a href=#debugging-on-android>Debugging on Android</a></li></ul></li><li><a href=#summary>Summary</a></li></ul></nav></aside></section><article class="mt-6 w-full max-w-4xl lg:max-w-5xl prose prose-slate dark:prose-invert prose-quoteless post-content"><h1 id=android-binary-exploitation>Android Binary Exploitation</h1><p>In this post, we will examine security mechanisms that Android 12 employs in order to make binary exploitation a bit harder. Also, we will discuss how to get to certain information like shared - object files that are necessary for successful exploitation. The latter will be generalized to getting limited source code access to an app given a corresponding <code>.apk</code> file.</p><h2 id=environment>Environment</h2><p>Before diving into details, the technical setup has to be clarified. All of the following observations on security mechanisms were encountered on a x86_64 Pixel 3 emulator running Android 12 (build number is <a href=https://source.android.com/docs/setup/about/build-numbers#build-ids-defined target=_blank rel=noopener><code>SE1A.220203.002.A1</code></a>
). When referencing source code from <em>Android Open Source Project</em> (AOSP), it will be w.r.t. <a href=https://cs.android.com/android/platform/superproject/+/android-12.0.0_r31: target=_blank rel=noopener>Android 12.0.0_r31</a>
. The build variant for <em>damnvulnerableapp</em> is currently only <code>debug</code>. Also there is no GooglePlay enabled as we require root on the device for debugging purposes only.</p><p>In addition to that, standard compilation configurations of <a href=https://developer.android.com/studio target=_blank rel=noopener><em>Android Studio</em></a>
are used to construct the app and compile native code. The version of <em>Android Studio</em> is as follows:</p><ul><li>Android Studio Dolphin | 2021.3.1</li><li>Build #AI-213.7172.25.2113.9014738, built on August 31, 2022</li><li>Runtime version: 11.0.13+0-b1751.21-8125866 amd64</li><li>VM: OpenJDK 64-Bit Server VM by JetBrains s.r.o.</li><li>Linux 5.15.0-46-generic</li><li>GC: G1 Young Generation, G1 Old Generation</li><li>Memory: 2048M</li><li>Cores: 12</li><li>Registry:<ul><li>external.system.auto.import.disabled=true</li><li>debugger.watches.in.variables=false</li><li>ide.text.editor.with.preview.show.floating.toolbar=false</li></ul></li><li>Current Desktop: ubuntu:GNOME</li></ul><p>If your environment differs even in the slightest way, you might need different offsets, addresses etc. to get your exploits to work. Thus, if I presents exploit sketches, <strong>do not assume that they work out of the box!</strong></p><h2 id=overview-of-security-mechanisms-on-android>Overview of Security Mechanisms on Android</h2><p>Next, via a non - exhaustive list of security mechanisms we will dive into the details of how Android makes life of an attacker (a bit) harder. If possible, we will try to figure out a way to bypass each security mechanism through additional assumptions.</p><h3 id=permissions>Permissions</h3><p>As usual, an app has certain permissions to access specific data or perform specific actions. E.g. in order to create a connection to a remote host via <a href=https://docs.oracle.com/javase/7/docs/api/java/net/Socket.html target=_blank rel=noopener><code>java.net.Socket</code></a>
, an app has to declare the install - time permission <a href=https://developer.android.com/reference/android/Manifest.permission#INTERNET target=_blank rel=noopener><code>android.permission.INTERNET</code></a>
in its manifest. If a permission is not declared (install - time) or not granted (runtime), then the app will not be able to provide the functionality that needs the respective permission(s).</p><p>Continuing the example above, if we somehow manage to get abitrary code execution inside of an Android app, but the app does not declare <code>android.permission.INTERNET</code>, then we will not be able to create a socket connection to call back to our netcat - listener for a reverse shell.</p><p>Permissions can further be divided into</p><ol><li><a href=https://developer.android.com/guide/topics/permissions/overview#install-time target=_blank rel=noopener>Install - time permissions</a>
: System automatically grants these upon installation. These permissions can be further classified into<ol><li><a href=https://developer.android.com/guide/topics/permissions/overview#normal target=_blank rel=noopener>Normal permissions</a>
: Allow for access to data and actions beyond the app&rsquo;s sandbox.</li><li><a href=https://developer.android.com/guide/topics/permissions/overview#signature target=_blank rel=noopener>Signature permissions</a>
: Irrelevant for now!</li></ol></li><li><a href=https://developer.android.com/guide/topics/permissions/overview#runtime target=_blank rel=noopener>Runtime permissions</a>
: User will be shown a permission prompt that specifically asks for a potentially dangerous permission. These prompts will be presented only if the app is running/starting.</li><li><a href=https://developer.android.com/guide/topics/permissions/overview#special target=_blank rel=noopener>Special permissions</a>
: Irrelevant for now! We assume an app that is not even capable of specifying these permissions.</li></ol><p>Assuming source code access and thus access to <code>AndroidManifest.xml</code>, we can deduce which actions are allowed in our shellcode. Another (naive) assumption is to believe that an app is incapable of adding additional permissions without a user&rsquo;s consent via publicly known means (otherwise this would be a severe security issue). Of couse, our shellcode could try to present the user permission prompts that give us further tools to play with, but this is <strong>far from stealthy</strong>!</p><p>Summarizing, a shellcode is limited to the app&rsquo;s permissions. Theoretically it is possible for shellcode to request runtime permissions &mldr; at runtime. It would be interesting to see whether it is possible to request install - time permissions at runtime.</p><h3 id=fortify>FORTIFY</h3><p>This mechanism adds additional compile - time and/or runtime checks to the C standard library. These are mainly memory - related checks, e.g.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=display:flex><span><span style=color:#66d9ef>struct</span> Foo {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> val;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>struct</span> Foo <span style=color:#f92672>*</span>next;
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>initFoo</span>(<span style=color:#66d9ef>struct</span> Foo <span style=color:#f92672>*</span>f) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>memset</span>(<span style=color:#f92672>&amp;</span>f, <span style=color:#ae81ff>0</span>, <span style=color:#66d9ef>sizeof</span>(<span style=color:#66d9ef>struct</span> Foo));
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>will not work, because <em>FORTIFY</em> is able to detect the 8 - byte overflow at compile - time (example taken from <a href=https://android-developers.googleblog.com/2017/04/fortify-in-android.html target=_blank rel=noopener>here</a>
).</p><p>At compile - time, <em>FORTIFY</em> will block compilation, if it is able to detect a bad call to a standard library function like e.g. <code>memset</code>. If <em>FORTIFY</em> is missing information or is very certain that a call is safe, then <em>FORTIFY</em> will be not be part of the process image. Finally, if there is a call, but <em>FORTIFY</em> is not sure whether the call is safe or not, it will redirect the call to a special <em>FORTIFY</em>&rsquo;ed version of the called function, which applies additional checks to ensure correct usage of the function.</p><p>Lets consider an Android - related example of the function <a href="https://cs.android.com/android/platform/superproject/+/android-12.0.0_r31:bionic/libc/include/bits/fortify/string.h;l=122;bpv=0;bpt=1" target=_blank rel=noopener><code>memset</code></a>
:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=display:flex><span>__BIONIC_FORTIFY_INLINE
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span><span style=color:#f92672>*</span> <span style=color:#a6e22e>memset</span>(<span style=color:#66d9ef>void</span><span style=color:#f92672>*</span> <span style=color:#66d9ef>const</span> s __pass_object_size0, <span style=color:#66d9ef>int</span> c, <span style=color:#66d9ef>size_t</span> n) __overloadable
</span></span><span style=display:flex><span>        <span style=color:#75715e>/* If you&#39;re a user who wants this warning to go away: use `(&amp;memset)(foo, bar, baz)`. */</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>__clang_warning_if</span>(c <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span>n, <span style=color:#e6db74>&#34;&#39;memset&#39; will set 0 bytes</span>; maybe the arguments got flipped<span style=color:#f92672>?</span><span style=color:#e6db74>&#34;) {</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#if __ANDROID_API__ &gt;= 17 &amp;&amp; __BIONIC_FORTIFY_RUNTIME_CHECKS_ENABLED
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>__builtin___memset_chk</span>(s, c, n, <span style=color:#a6e22e>__bos0</span>(s));
</span></span><span style=display:flex><span><span style=color:#75715e>#else
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>__builtin_memset</span>(s, c, n);
</span></span><span style=display:flex><span><span style=color:#75715e>#endif
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><p>As these are builtins, they are implemented by the compiler and thus pretty hard to track down (if you are interested, consider code that looks like a <a href="https://cs.android.com/android/platform/superproject/+/android-12.0.0_r31:external/clang/lib/Sema/SemaChecking.cpp;l=974" target=_blank rel=noopener>compile - time check</a>
and a <a href="https://cs.android.com/android/platform/superproject/+/android-12.0.0_r31:external/clang/lib/CodeGen/CGBuiltin.cpp;l=1052" target=_blank rel=noopener>runtime - check</a>
; no guarantees that these references are what is actually being called!).</p><p>Sooo&mldr;how to break it? Apparently, if <em>FORTIFY</em> is lacking information, it will just give up. The developers gave a pretty nice <a href=https://android-developers.googleblog.com/2017/04/fortify-in-android.html target=_blank rel=noopener>example</a>
for <em>FORTIFY</em>&rsquo;s limitations:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=display:flex><span><span style=color:#a6e22e>__attribute__</span>((noinline)) <span style=color:#75715e>// Tell the compiler to never inline this function.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>inline</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>intToStr</span>(<span style=color:#66d9ef>int</span> i, <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>asStr) { <span style=color:#a6e22e>sprintf</span>(asStr, <span style=color:#e6db74>&#34;%d&#34;</span>, i); }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>intToDupedStr</span>(<span style=color:#66d9ef>int</span> i) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>int</span> MAX_INT_STR_SIZE <span style=color:#f92672>=</span> <span style=color:#66d9ef>sizeof</span>(<span style=color:#e6db74>&#34;2147483648&#34;</span>); <span style=color:#75715e>// MAX_INT_STR_SIZE = 11 = 10 + 1
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>char</span> buf[MAX_INT_STR_SIZE];
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>intToStr</span>(i, buf);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>strdup</span>(buf);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Setting <code>i = -2147483648</code> (which is <code>0x80000000</code>, because of 2&rsquo;s - complement for 4 - byte values) would result in an off - by - one bug, because <code>buf</code> is a buffer of <code>11</code> elements, the last of which is supposed to be a null - terminator. Because <code>sprintf</code> will also put a <code>-</code> sign into <code>buf</code>, the null - terminator will be moved back by one and therefore overwrite the least - significant byte of the next qword on the stack. If <code>rbp</code> was modified, then this would most likely crash the entire program. <em>FORTIFY</em> does <strong>not</strong> catch this bug, because from the perspective of <code>intToStr</code>, <em>FORTIFY</em> cannot &ldquo;see&rdquo; the allocation of <code>buf</code>. Neither can <em>FORTIFY</em> determine for sure the size of a <code>char*</code>, which could be of arbitrary length, nor can it determine where <code>buf</code> is pointing to (<code>stack</code>, <code>heap</code>, <code>.bss</code>, <code>.data</code>, &mldr;).</p><p>Observe that <em>FORTIFY</em> makes it significantly harder for developers to write vulnerable code. Still, if developers decide to implement their own versions of e.g. <code>memcpy</code> this fully bypasses <em>FORTIFY</em>. Also, as can be seen in the above example, there are settings, in which <em>FORTIFY</em> cannot help, i.e. e.g. if the allocation of a buffer takes place in a different function and this buffer is passed as a <code>type*</code>.</p><h3 id=on-defeating-pies>On defeating PIEs</h3><p>When building native apps on Android via <em>Android Studio</em>, we will almost always use <a href=https://cmake.org/cmake/help/latest/command/add_library.html target=_blank rel=noopener>cmake&rsquo;s <code>add_library</code></a>
with the <code>SHARED</code> flag. This will encapsulate the native code into a <a href=https://developer.android.com/studio/projects/configure-cmake#create_script target=_blank rel=noopener><code>lib&lt;somename>.so</code></a>
file, which is actually a shared - object file (<a href=http://www.sco.com/developers/gabi/latest/contents.html target=_blank rel=noopener>ELF</a>
). According to <a href=https://cmake.org/cmake/help/latest/command/add_library.html target=_blank rel=noopener>documentation</a>
, for such <code>SHARED</code> libraries the property <code>POSITION_INDEPENDENT_CODE</code> is automatically set to <code>ON</code>, thus resulting in Position - Independent - Executables (PIEs; To be precise with terminology, the shared - object file contains Position - Independent - Code (PIC). From <em>ELF&rsquo;s</em> perspective, not every shared - object file is an executable and vice versa).</p><p>When calling <code>System.loadLibrary("xyz")</code>, we can trace down the call hierarchy to versions of <a href="https://cs.android.com/android/platform/superproject/+/android-12.0.0_r31:art/runtime/jni/java_vm_ext.cc;l=1003;bpv=0;bpt=0" target=_blank rel=noopener><code>dlopen</code></a>
, which is implemented in the <a href="https://cs.android.com/android/platform/superproject/+/android-12.0.0_r31:bionic/linker/linker.cpp;l=2063;bpv=0;bpt=1" target=_blank rel=noopener>linker</a>
. Finally, <a href="https://cs.android.com/android/platform/superproject/+/android-12.0.0_r31:bionic/linker/linker_phdr.cpp;l=561" target=_blank rel=noopener><code>ReserveWithAlignmentPadding</code></a>
will be called, which returns a <a href="https://cs.android.com/android/platform/superproject/+/android-12.0.0_r31:bionic/linker/linker_phdr.cpp;l=623" target=_blank rel=noopener>randomized base address</a>
. This confirms that when loading native shared - object files, they will have <a href=https://guyinatuxedo.github.io/5.1-mitigation_aslr_pie/index.html target=_blank rel=noopener>ASLR</a>
enabled by default.</p><p>Defeating ASLR is thus key to handling binary exploitation in PIEs. This can be archieved in numerous ways. The following is a non - exhaustive list of possible ways to break ASLR:</p><ol><li>Leaking an address from e.g. a code region. It seems that the random shift used for the stack (and heap etc.) and a loaded shared - object file differ. This follows from the <a href="https://cs.android.com/android/platform/superproject/+/android-12.0.0_r31:bionic/linker/linker_phdr.cpp;l=623" target=_blank rel=noopener>randomized base address</a>
, which is different on each execution of <code>ReserveWithAlignmentPadding</code>.</li><li>Abusing a side channel that allows for brute - forcing / leaking bytes of an address one by one instead of being forced into brute - forcing / leaking the entire address at once.</li><li>From <a href="https://cs.android.com/android/platform/superproject/+/android-12.0.0_r31:bionic/linker/linker_phdr.cpp;l=626" target=_blank rel=noopener><code>ReserveWithAlignmentPadding</code></a>
, by probing for accessible memory mappings. Depending on the app, we might be able to even distinguish different kinds of errors / signals when accessing / returning to invalid memory. However, for memory probing to work the process should not crash upon signals like <code>SIGSEG</code> or <code>SIGILL</code>, which is very rare.</li></ol><h3 id=full-relro>Full RELRO</h3><p>With the above security mechanisms in place, it would still be &ldquo;easy&rdquo; to abuse a leak combined with a <em>Write - What - Where</em> condition, as e.g. <code>.got</code> is still writable. E.g. overwriting a <code>.got</code> entry of <code>strlen</code> that is given a string of our choice could result in a redirection to <code>system</code> (for a more detailed discussion, see <a href=https://systemoverlord.com/2017/03/19/got-and-plt-for-pwning.html target=_blank rel=noopener>this blog post</a>
). This is, among other things, prevented by full / partial <em>Relocations Read - Only</em>, i.e. full / partial <em>RELRO</em>, which can be <a href=https://source.android.com/docs/security/enhancements/enhancements41 target=_blank rel=noopener>enabled</a>
on Android. Full <em>RELRO</em> marks certain memory regions, like e.g. <code>.got</code>, as read - only after program startup. It seems that it is enabled by default, when creating a new native android app in Android Studio.</p><p>Now the question arises, how this mitigation can be circumvented. This again depends on the app. Lets consider the non - exhaustive list:</p><ol><li>Given a <em>Write - What - Where</em> condition and knowledge on all addresses:<ol><li>Try to find and overwrite a global variable (located in <code>.bss</code> or <code>.data</code>) that impacts the control flow, e.g. a function pointer.</li><li>Overwrite the return address on the stack to return to a <a href=https://ctf101.org/binary-exploitation/return-oriented-programming/ target=_blank rel=noopener>ROP - chain</a>
located &ldquo;somewhere else&rdquo;.</li></ol></li><li>Given access to <code>mprotect</code>:<ol><li>Call <code>mprotect</code> on <code>.got</code> to make it writable again.</li></ol></li></ol><h3 id=non---executable-stack-and-heap>Non - executable Stack (and Heap)</h3><p>As has been the case for decades, the <a href=https://source.android.com/docs/security/enhancements/enhancements41 target=_blank rel=noopener>stack and heap is marked as non - executable</a>
by default. Thus, calling your classical NOP - sledge for help won&rsquo;t do any good.</p><p>(Un-)fortunately, the stack and heap can be used to store gadgets for a ROP - chain.</p><h3 id=canaries-and-cookies>Canaries and cookies</h3><p>Depending on how a native function is implemented and compiled, it can be given a stack canary. This canary aims to protect the stack frame, i.e. the return address and stored <code>rbp</code>, from potential buffer overflows on the stack. In our case, this canary is an 8 - byte random value that is very hard to predict. Doing the math reveals that we have a <code>1/(2^64)</code> chance to hit the correct canary. This is why we often assume that there is some kind of leak that (partially) reveals the canary (bytes). Naturally, two approaches come to mind when thinking of &ldquo;leaking an 8 byte random value&rdquo;:</p><ol><li><p>Reading it directly from the stack. Trivially, this will reveal the value.</p></li><li><p>Brute - forcing it via a side channel. The side channel could be e.g. an oracle that either says</p><ul><li>&ldquo;Canary is correct&rdquo;, i.e. process keeps running</li><li>&ldquo;Canary is incorrect&rdquo;, i.e. process crashes.</li></ul><p>If we overwrite just the least - significant byte of the canary, this byte will be in either of the above categories. If the process does not crash, we can continue with the next canary byte until all 8 bytes are leaked.</p></li></ol><p>So, why would the latter approach work? The canary will be consisting of 8 random bytes for each process start, right? Right? No! Not going into the <a href=https://link.springer.com/article/10.1007/s10207-018-00425-8 target=_blank rel=noopener>details</a>
, the underlying syscall <code>fork</code>, which is used to spawn <em>damnvulnerableapp</em> and its subprocess that is running the vulnerable module, will be called from the same parent process (zygote) over and over again, i.e. for <strong>each</strong> app. Therefore, apps contain large duplicated memory regions, canary included.</p><h2 id=getting-the-source>Getting the source</h2><p>And now for something completely different. Well, technically speaking it is not <em>that</em> different, because packing the source code could be considered a form of obfuscation, which again could be considered a security precaution. Now we will take the perspective of an attacker that tries to get access to the source code of an app while only having access to an app&rsquo;s <code>apk</code> file.</p><h3 id=finding-the-apk-file>Finding the <em>apk</em> file</h3><p>There are numerous ways to get an <code>apk</code> file of an app, among which the following seem to be the easiest ones:</p><ol><li>Use <em>Android Studio</em> to build the app and search for the <code>apk</code> file in the directory tree of the app. This implies source code access and therefore makes analyzing an <code>apk</code> file obsolete, but it is a way.</li><li>Assuming root access on an Android device / emulator, user - installed apps can be found at e.g. <code>/data/app/</code>. There can be a corresponding <code>.apk</code> file to grab for further static analysis (this might depend on the Android version).</li></ol><h3 id=unpacking-apk-files>Unpacking <em>apk</em> files</h3><p>Assuming we grabbed ourselves an <code>apk</code> file, we can start analyzing it:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ file base.apk
</span></span><span style=display:flex><span>base.apk: Zip archive data, at least v?<span style=color:#f92672>[</span>0<span style=color:#f92672>]</span> to extract
</span></span><span style=display:flex><span>$ unzip base.apk -d ./base
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>$ ls base
</span></span><span style=display:flex><span>AndroidManifest.xml  classes10.dex  classes11.dex  classes2.dex  classes3.dex  classes4.dex  classes5.dex  classes6.dex  classes7.dex  classes8.dex  classes9.dex  classes.dex  lib  META-INF  res  resources.arsc
</span></span></code></pre></div><p>Going from here we can easily access the native libraries that are part of the app:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ ls base/lib/x86_64
</span></span><span style=display:flex><span>libDoubleFreeModule.so  libEasyStackBufferOverflowModule.so  libHeapOverflowModule.so  libOffByOneModule.so  libStackBufferOverflowModule.so  libUseAfterFreeExecModule.so  libUseAfterFreeWriteModule.so
</span></span></code></pre></div><p>These shared - object files can later be used for finding gadgets and so on. Further they can be analyzed / decompiled via e.g. <a href=https://ghidra-sre.org/ target=_blank rel=noopener><em>Ghidra</em></a>
. The decompiled code of <code>logMessage#libOffByOneModule.so</code> could look like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-C data-lang=C><span style=display:flex><span>undefined8
</span></span><span style=display:flex><span><span style=color:#a6e22e>Java_com_damnvulnerableapp_vulnerable_modules_OffByOneModule_logMessage</span>
</span></span><span style=display:flex><span>		(<span style=color:#66d9ef>long</span> <span style=color:#f92672>*</span>param_1,undefined8 param_2,undefined8 param_3)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>int</span> iVar1;
</span></span><span style=display:flex><span>	undefined4 uVar2;
</span></span><span style=display:flex><span>	undefined8 uVar3;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>pvVar4;
</span></span><span style=display:flex><span>	undefined8 uVar5;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>long</span> in_FS_OFFSET;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>int</span> local_cc;
</span></span><span style=display:flex><span>	undefined8 local_a0;
</span></span><span style=display:flex><span>	timespec local_28;
</span></span><span style=display:flex><span>	undefined local_11;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>long</span> local_10;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	local_10 <span style=color:#f92672>=</span> <span style=color:#f92672>*</span>(<span style=color:#66d9ef>long</span> <span style=color:#f92672>*</span>)(in_FS_OFFSET <span style=color:#f92672>+</span> <span style=color:#ae81ff>0x28</span>);
</span></span><span style=display:flex><span>	uVar3 <span style=color:#f92672>=</span> (<span style=color:#f92672>**</span>(code <span style=color:#f92672>**</span>)(<span style=color:#f92672>*</span>param_1 <span style=color:#f92672>+</span> <span style=color:#ae81ff>0x5c0</span>))(param_1,param_3,<span style=color:#f92672>&amp;</span>local_11);
</span></span><span style=display:flex><span>	DAT_00103028 <span style=color:#f92672>=</span> DAT_00103028 <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>	DAT_00103020 <span style=color:#f92672>=</span> <span style=color:#a6e22e>realloc</span>(DAT_00103020,DAT_00103028 <span style=color:#f92672>*</span> <span style=color:#ae81ff>0x108</span>);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (DAT_00103020 <span style=color:#f92672>==</span> (<span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>)<span style=color:#ae81ff>0x0</span>) {
</span></span><span style=display:flex><span>		local_a0 <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>		pvVar4 <span style=color:#f92672>=</span> (<span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>)((<span style=color:#66d9ef>long</span>)DAT_00103020 <span style=color:#f92672>+</span> (DAT_00103028 <span style=color:#f92672>+</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>) <span style=color:#f92672>*</span> <span style=color:#ae81ff>0x108</span>);
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>__memset_chk</span>(pvVar4,<span style=color:#ae81ff>0</span>,<span style=color:#ae81ff>0x108</span>,<span style=color:#ae81ff>0xffffffffffffffff</span>);
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>__memcpy_chk</span>((<span style=color:#66d9ef>long</span>)pvVar4 <span style=color:#f92672>+</span> <span style=color:#ae81ff>0x100</span>,<span style=color:#f92672>&amp;</span>PTR_FUN_00103010,<span style=color:#ae81ff>8</span>,<span style=color:#ae81ff>0xffffffffffffffff</span>);
</span></span><span style=display:flex><span>		local_cc <span style=color:#f92672>=</span> (<span style=color:#f92672>**</span>(code <span style=color:#f92672>**</span>)(<span style=color:#f92672>*</span>param_1 <span style=color:#f92672>+</span> <span style=color:#ae81ff>0x558</span>))(param_1,param_3);
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> (<span style=color:#ae81ff>0x100</span> <span style=color:#f92672>&lt;</span> local_cc <span style=color:#f92672>+</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>			local_cc <span style=color:#f92672>=</span> <span style=color:#ae81ff>0xff</span>;
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>__memcpy_chk</span>(pvVar4,uVar3,(<span style=color:#66d9ef>long</span>)local_cc,<span style=color:#ae81ff>0xffffffffffffffff</span>);
</span></span><span style=display:flex><span>		iVar1 <span style=color:#f92672>=</span> <span style=color:#a6e22e>clock_gettime</span>(<span style=color:#ae81ff>0</span>,<span style=color:#f92672>&amp;</span>local_28);
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> (iVar1 <span style=color:#f92672>!=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>			local_28.tv_nsec <span style=color:#f92672>=</span> local_28.tv_nsec <span style=color:#f92672>+</span> <span style=color:#ae81ff>10</span>;
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		uVar5 <span style=color:#f92672>=</span> (<span style=color:#f92672>**</span>(code <span style=color:#f92672>**</span>)((<span style=color:#66d9ef>long</span>)pvVar4 <span style=color:#f92672>+</span> <span style=color:#ae81ff>0x100</span>))(pvVar4,(<span style=color:#66d9ef>long</span>)local_cc);
</span></span><span style=display:flex><span>		uVar2 <span style=color:#f92672>=</span> <span style=color:#a6e22e>__strlen_chk</span>(uVar5,<span style=color:#ae81ff>0xffffffffffffffff</span>);
</span></span><span style=display:flex><span>		local_a0 <span style=color:#f92672>=</span> (<span style=color:#f92672>**</span>(code <span style=color:#f92672>**</span>)(<span style=color:#f92672>*</span>param_1 <span style=color:#f92672>+</span> <span style=color:#ae81ff>0x580</span>))(param_1,uVar2);
</span></span><span style=display:flex><span>		(<span style=color:#f92672>**</span>(code <span style=color:#f92672>**</span>)(<span style=color:#f92672>*</span>param_1 <span style=color:#f92672>+</span> <span style=color:#ae81ff>0x680</span>))(param_1,local_a0,<span style=color:#ae81ff>0</span>,uVar2,uVar5);
</span></span><span style=display:flex><span>		(<span style=color:#f92672>**</span>(code <span style=color:#f92672>**</span>)(<span style=color:#f92672>*</span>param_1 <span style=color:#f92672>+</span> <span style=color:#ae81ff>0x600</span>))(param_1,param_3,uVar3,<span style=color:#ae81ff>2</span>);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (<span style=color:#f92672>*</span>(<span style=color:#66d9ef>long</span> <span style=color:#f92672>*</span>)(in_FS_OFFSET <span style=color:#f92672>+</span> <span style=color:#ae81ff>0x28</span>) <span style=color:#f92672>==</span> local_10) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> local_a0;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>				<span style=color:#75715e>/* WARNING: Subroutine does not return */</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>__stack_chk_fail</span>();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>In order to not being forced into manually setting up the jni type definitions, see either <a href=https://github.com/extremecoders-re/ghidra-jni target=_blank rel=noopener><code>jni_all.h</code></a>
or <a href=https://gist.github.com/jcalabres/bf8d530b3f18c30ca6f66388357b1d91 target=_blank rel=noopener><code>jni_all.h</code></a>
. When in the <em>CodeBrowser</em>, try running <em>File -> Parse C Source&mldr;</em>, add the corresponding file to &ldquo;Source files to parse&rdquo;, choose the correct base profile (&ldquo;parse configuration&rdquo;) and set the parse options to e.g. <a href=https://github.com/extremecoders-re/ghidra-jni#how-to-load-in-ghidra target=_blank rel=noopener>this</a>
.</p><p>To be more precise, first download any of the above mentioned <code>jni_all.h</code> files. Then open <em>File -> Parse C Source&mldr;</em>. You should be prompted with the following window:<div class=not-prose><figure><img src=/2024/07/eva_1_ghidra_parse_c_source.png alt="Parse C Source Window" loading=lazy></figure></div></p><p>Next, choose an existing profile as a base profile. E.g. choose <code>generic_clib_32.prf</code> and click on the <em>Save profile to new name</em> button (upper right corner). Then choose a name that you recognize:<div class=not-prose><figure><img src=/2024/07/eva_1_ghidra_save_new_profile.png alt="Save New Profile" loading=lazy></figure></div></p><p>After giving the new profile a nice name, we need to adjust the parse options. E.g. you can copy them over from <a href=https://github.com/extremecoders-re/ghidra-jni#how-to-load-in-ghidra target=_blank rel=noopener>here</a>
. <strong>Do not overwrite -I options</strong>:<div class=not-prose><figure><img src=/2024/07/eva_1_ghidra_parse_options.png alt="Parse Options" loading=lazy></figure></div></p><p>Finally, add <code>jni_all.h</code> to the <em>Source files to parse</em> panel by clicking on the green plus sign to the right. This should open <em>files</em>. Navigate to <code>jni_all.h</code> and open it. You should see a new entry if you scrolled all the way down. Now click the <em>Save profile</em> button at the top and then <em>Parse to program</em> at the bottom. If you now retype a variable, e.g. the first argument of a JNI function to <code>JNIEnv*</code>, you will see actual function names like <code>NewByteArray</code> etc.</p><p>Now we are just missing the Java code that calls this native function&mldr;</p><h3 id=getting-java-code>Getting Java code</h3><p>In order to obtain the Java code of an app, an attacker could utilize a tool like <a href=https://github.com/skylot/jadx target=_blank rel=noopener><em>jadx</em></a>
. This basically reconstructs the project structure we see in <em>Android Studio</em>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ jadx-gui ./base.apk
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><p>This decompiles a large portion of the app. Continuing the example of the <em>OffByOneModule</em>, we can get the following decompiled code for the <code>OffByOneModule</code> class:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Java data-lang=Java><span style=display:flex><span><span style=color:#f92672>package</span> com.damnvulnerableapp.vulnerable.modules;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> com.damnvulnerableapp.common.exceptions.VulnerableModuleException;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/* loaded from: classes10.dex */</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>OffByOneModule</span> <span style=color:#66d9ef>extends</span> VulnerableModule {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>native</span> <span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> <span style=color:#a6e22e>logMessage</span>(<span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> bArr);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>static</span> {
</span></span><span style=display:flex><span>        System.<span style=color:#a6e22e>loadLibrary</span>(<span style=color:#e6db74>&#34;OffByOneModule&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>OffByOneModule</span>() {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>super</span>(<span style=color:#66d9ef>new</span> OffByOneModuleConfiguration());
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>@Override</span> <span style=color:#75715e>// com.damnvulnerableapp.vulnerable.modules.VulnerableModule</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span>() <span style=color:#66d9ef>throws</span> VulnerableModuleException {
</span></span><span style=display:flex><span>        output(<span style=color:#e6db74>&#34;Welcome to the most secure message logger in the world!&#34;</span>.<span style=color:#a6e22e>getBytes</span>());
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>while</span> (<span style=color:#66d9ef>true</span>) {
</span></span><span style=display:flex><span>            output(<span style=color:#e6db74>&#34;Enter a message to log: &#34;</span>.<span style=color:#a6e22e>getBytes</span>());
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>byte</span><span style=color:#f92672>[]</span> message <span style=color:#f92672>=</span> input();
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (message <span style=color:#f92672>==</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>                output(<span style=color:#e6db74>&#34;Failed to receive the message to log...Better safe than sorry!&#34;</span>.<span style=color:#a6e22e>getBytes</span>());
</span></span><span style=display:flex><span>            } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>new</span> String(message).<span style=color:#a6e22e>equals</span>(<span style=color:#e6db74>&#34;EXIT&#34;</span>)) {
</span></span><span style=display:flex><span>                output(<span style=color:#e6db74>&#34;Your logged message(s) were stored successfully.&#34;</span>.<span style=color:#a6e22e>getBytes</span>());
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>            } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>                output(logMessage(message));
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=grabbing-system-libraries>Grabbing System Libraries</h3><p>Often there are libraries, of which we have a leaked pointer. Having such a pointer is nice and all, but it will not help, if we do not have access to the corresponding shared - object file. Lets try to get access to <code>libart.so</code>, the android runtime that runs the Java code we wrote for the app. Among other things, it handles native calls via trampoline functions like <a href="https://cs.android.com/android/platform/superproject/+/android-12.0.0_r31:art/runtime/arch/x86_64/quick_entrypoints_x86_64.S;l=1536" target=_blank rel=noopener><code>art_quick_generic_jni_trampoline</code></a>
.</p><p>In order to find <code>libart.so</code>, again assuming root access, running the <em>damnvulnerableapp</em> reveals the binary that underlies the process:</p><pre tabindex=0><code># ps -e | grep damn
u0_a107       4122   357 13798620 114268 do_epoll_wait      0 S com.damnvulnerableapp
# file /proc/4122/exe
/proc/4122/exe: symbolic link to /system/bin/app_process64
# readelf -d /system/bin/app_process64
...
 0x0000000000000001 (NEEDED)             Shared library: [libandroid_runtime.so]
 0x0000000000000001 (NEEDED)             Shared library: [libbinder.so]
 0x0000000000000001 (NEEDED)             Shared library: [libcutils.so]
 0x0000000000000001 (NEEDED)             Shared library: [libhidlbase.so]
 0x0000000000000001 (NEEDED)             Shared library: [liblog.so]
 0x0000000000000001 (NEEDED)             Shared library: [libnativeloader.so]
 0x0000000000000001 (NEEDED)             Shared library: [libsigchain.so]
 0x0000000000000001 (NEEDED)             Shared library: [libutils.so]
 0x0000000000000001 (NEEDED)             Shared library: [libwilhelm.so]
 0x0000000000000001 (NEEDED)             Shared library: [libc++.so]
 0x0000000000000001 (NEEDED)             Shared library: [libc.so]
 0x0000000000000001 (NEEDED)             Shared library: [libm.so]
 0x0000000000000001 (NEEDED)             Shared library: [libdl.so]
...
</code></pre><p>This means that <code>libart.so</code> will be loaded later on, i.e. not at startup. Further analysis reveals:</p><pre tabindex=0><code># cat /proc/4122/maps | grep libart.so
730c03400000-730c0357b000 r--p 00000000 fe:0f 57                         /apex/com.android.art/lib64/libart.so
730c0377a000-730c03e0b000 r-xp 0017a000 fe:0f 57                         /apex/com.android.art/lib64/libart.so
730c0400a000-730c0401d000 r--p 0080a000 fe:0f 57                         /apex/com.android.art/lib64/libart.so
730c0421c000-730c04220000 rw-p 0081c000 fe:0f 57                         /apex/com.android.art/lib64/libart.so
# exit
$ adb pull /apex/com.android.art/lib64/libart.so ./libart.so
</code></pre><p>After the above commands, <code>libart.so</code> should be in our current working directory, ready to be analyzed via <em>Ghidra</em>, <a href=https://man7.org/linux/man-pages/man1/objdump.1.html target=_blank rel=noopener><em>objdump</em></a>
(which will most likely not work, because <em>objdump</em> does not recognize the architecture) or <a href=https://man7.org/linux/man-pages/man1/readelf.1.html target=_blank rel=noopener><em>readelf</em></a>
.</p><p>There may be two unexpected aspects:</p><ol><li>Even if you do <strong>not</strong> have root access on the emulator, it is possible to run <code>adb pull &lt;from remote> &lt;to local></code>. We only used root to access <code>/proc/4122/maps</code> etc.</li><li>The name of the binary that underlies <em>damnvulnerableapp</em> is <code>/system/bin/app_process64</code>. To that end, observe that Java apps are <a href=https://link.springer.com/article/10.1007/s10207-018-00425-8 target=_blank rel=noopener>forked from the zygote process</a>
. The zygote process, among other things, initializes the JVM to allow for faster app starts.</li></ol><h3 id=analysing-the-stack-trace>Analysing the Stack Trace</h3><p>There is one more thing to consider. When given a leak, e.g. an address from the stack, then it is important to (partially) understand what values are located on the stack. To that end, one may write a small native app via <em>Android Studio</em>, set a breakpoint on the native function and run the app. This could result in the following stack trace:</p><pre tabindex=0><code>Java_com_damnvulnerableapp_vulnerable_modules_EasyStackBufferOverflowModule_vulnerableToUpper EasyStackBufferOverflowModule.c:32
art_quick_generic_jni_trampoline 0x000071636dba032c
art_quick_invoke_stub 0x000071636db95015
art::ArtMethod::Invoke(art::Thread *, unsigned int *, unsigned int, art::JValue *, const char *) 0x000071636dc1d9fb
art::interpreter::ArtInterpreterToCompiledCodeBridge(art::Thread *, art::ArtMethod *, art::ShadowFrame *, unsigned short, art::JValue *) 0x000071636dda335d
art::interpreter::DoCall&lt;…&gt;(art::ArtMethod *, art::Thread *, art::ShadowFrame &amp;, const art::Instruction *, unsigned short, art::JValue *) 0x000071636dd9d16d
art::interpreter::ExecuteSwitchImplCpp&lt;…&gt;(art::interpreter::SwitchImplContext *) 0x000071636dbac1d0
ExecuteSwitchImplAsm 0x000071636dba23d6
art::interpreter::ExecuteSwitch(art::Thread *, const art::CodeItemDataAccessor &amp;, art::ShadowFrame &amp;, art::JValue, bool) 0x000071636dd9ca6e
art::interpreter::Execute(art::Thread *, const art::CodeItemDataAccessor &amp;, art::ShadowFrame &amp;, art::JValue, bool, bool) 0x000071636dd94ae1
art::interpreter::ArtInterpreterToInterpreterBridge(art::Thread *, const art::CodeItemDataAccessor &amp;, art::ShadowFrame *, art::JValue *) 0x000071636dd9c55c
art::interpreter::DoCall&lt;…&gt;(art::ArtMethod *, art::Thread *, art::ShadowFrame &amp;, const art::Instruction *, unsigned short, art::JValue *) 0x000071636dd9d14e
MterpInvokeVirtual 0x000071636e16e306
mterp_op_invoke_virtual 0x000071636db7e71a
art::interpreter::Execute(art::Thread *, const art::CodeItemDataAccessor &amp;, art::ShadowFrame &amp;, art::JValue, bool, bool) 0x000071636dd94b43
art::interpreter::ArtInterpreterToInterpreterBridge(art::Thread *, const art::CodeItemDataAccessor &amp;, art::ShadowFrame *, art::JValue *) 0x000071636dd9c55c
art::interpreter::DoCall&lt;…&gt;(art::ArtMethod *, art::Thread *, art::ShadowFrame &amp;, const art::Instruction *, unsigned short, art::JValue *) 0x000071636dd9d14e
MterpInvokeVirtual 0x000071636e16e306
mterp_op_invoke_virtual 0x000071636db7e71a
art::interpreter::Execute(art::Thread *, const art::CodeItemDataAccessor &amp;, art::ShadowFrame &amp;, art::JValue, bool, bool) 0x000071636dd94b43
art::interpreter::ArtInterpreterToInterpreterBridge(art::Thread *, const art::CodeItemDataAccessor &amp;, art::ShadowFrame *, art::JValue *) 0x000071636dd9c55c
art::interpreter::DoCall&lt;…&gt;(art::ArtMethod *, art::Thread *, art::ShadowFrame &amp;, const art::Instruction *, unsigned short, art::JValue *) 0x000071636dd9d14e
MterpInvokeInterface 0x000071636e175bfd
mterp_op_invoke_interface 0x000071636db7e91a
art::interpreter::Execute(art::Thread *, const art::CodeItemDataAccessor &amp;, art::ShadowFrame &amp;, art::JValue, bool, bool) 0x000071636dd94b43
artQuickToInterpreterBridge 0x000071636e159a70
art_quick_to_interpreter_bridge 0x000071636dba04bd
&lt;unknown&gt; 0x000071636dba07c0
</code></pre><p>This is a stack - trace of a module that will be exploited in a later post. The most important address is the return address of <code>Java_com_damnvulnerableapp_vulnerable_modules_EasyStackBufferOverflowModule_vulnerableToUpper</code>, i.e the address into <code>art_quick_generic_jni_trampoline: 0x000071636dba032c</code>. Depending on whether the native method is e.g. declared as <code>static</code> or not, <a href="https://cs.android.com/android/platform/superproject/+/android-12.0.0_r31:art/runtime/art_method.cc;l=369" target=_blank rel=noopener>different stubs</a>
are called, which may result in different return addresses. Thus it might be beneficial to produce a small sample app with the same setup as the target app, especially w.r.t. access modifiers etc. of the native method, to get an idea of the stack - trace.</p><h3 id=debugging-on-android>Debugging on Android</h3><p>Another very important aspect of binary exploitation is <em>debugging</em>. There are a lot of good resources out there (like <a href=https://simoneaonzo.it/gdb-android/ target=_blank rel=noopener>1</a>
, <a href=https://wladimir-tm4pda.github.io/porting/debugging_gdb.html target=_blank rel=noopener>2</a>
). One possible debugger is <a href=https://man7.org/linux/man-pages/man1/gdb.1.html target=_blank rel=noopener><em>GDB</em></a>
. As <em>GDB</em> by itself is pretty hard to use, I will use an extensions in this series, called <a href=https://github.com/hugsy/gef target=_blank rel=noopener><em>GEF</em></a>
. A prerequisite is that we have root access on the device/emulator.</p><h4 id=starting-an-app-from-terminal>Starting an app from terminal</h4><p>In order to debug an app, the app needs to run. In this case, as we are using a &ldquo;special&rdquo; app, we just need to run it without waiting for a debugger to attach. Running an app can be done as follows:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ adb shell <span style=color:#e6db74>&#34;am start -n com.damnvulnerableapp/com.damnvulnerableapp.managerservice.ManagerActivity&#34;</span>
</span></span></code></pre></div><p>Here we assume that the app of choice is the <em>DamnVulnerableApp</em>, which is the main focus of this series.</p><p>From here onwards, the manager will run in the background and wait for incoming connections. Once a connection is established, the messages will be used to tell the manager what to do, like spawning a vulnerable module.</p><h4 id=starting-an-exploit-script>Starting an exploit script</h4><p>Assuming that connecting to a socket server is not a great challenge, right after the connection has been established and a vulnerable module selected, the exploit script should wait for the debugger to attach. This can be achieved like demonstrated in the following:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># Need tcp forward, i.e. &#39;adb forward tcp:8080 tcp:8080&#39;</span>
</span></span><span style=display:flex><span>client <span style=color:#f92672>=</span> PwnClient(<span style=color:#e6db74>&#39;127.0.0.1&#39;</span>, <span style=color:#ae81ff>8080</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>client<span style=color:#f92672>.</span>select(<span style=color:#e6db74>&#39;EasyStackBufferOverflowModule&#39;</span>)
</span></span><span style=display:flex><span>print(client<span style=color:#f92672>.</span>fetch())
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>input(<span style=color:#e6db74>&#39;Press &lt;enter&gt; to continue...&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#f92672>...</span>
</span></span></code></pre></div><p>This is not <em>the clean way</em>, but it works just fine.</p><h4 id=attaching-gdb>Attaching gdb</h4><p>Notice that selecting a module should spawn a new process that encapsulates the vulnerable module. Now we need a <em>gdbserver</em>, which is part of the <a href=https://developer.android.com/ndk target=_blank rel=noopener><em>Android NDK</em></a>
. Uploading the <em>gdbserver</em> to e.g. <code>/data/local/tmp/gdbserver</code> will enable us to attach to running processes. The command history could look like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ adb push gdbserver /data/local/tmp/gdbserver
</span></span><span style=display:flex><span>$ adb shell <span style=color:#e6db74>&#34;chmod 777 /data/local/tmp/gdbserver&#34;</span>
</span></span><span style=display:flex><span>$ adb forward tcp:1337 tcp:1337
</span></span><span style=display:flex><span>$ adb shell <span style=color:#e6db74>&#34;/data/local/tmp/gdbserver :1337 --attach </span><span style=color:#66d9ef>$(</span>pidof com.damnvulnerableapp:VulnerableActivity<span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>Listening on port <span style=color:#ae81ff>1337</span>
</span></span></code></pre></div><p>We will make <em>gdb</em> connect to port <code>1337</code> for debugging. After the last command, the process will block until a debugger connects. Before that, we should provide gdb with all necessary symbol information that is helpful for debugging. Namely (inspired from <a href=https://simoneaonzo.it/gdb-android/ target=_blank rel=noopener>here</a>
):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ mkdir ~/dbgtmp
</span></span><span style=display:flex><span>$ adb pull /system/lib64 ~/dbgtmp
</span></span><span style=display:flex><span>$ mkdir ~/dbgtmp/tmp
</span></span><span style=display:flex><span>$ adb pull /apex/com.android.art/lib64 ~/dbgtmp/tmp
</span></span><span style=display:flex><span>$ mv ~/dbgtmp/tmp/* ~/dbgtmp/lib64
</span></span><span style=display:flex><span>$ cp ~/path/to/unpacked/apk/lib/x86_64/* ~/dbgtmp/lib64
</span></span></code></pre></div><p>Then, in <em>gdb/gef</em> (taken from <a href=https://wladimir-tm4pda.github.io/porting/debugging_gdb.html target=_blank rel=noopener>here</a>
and <a href=https://simoneaonzo.it/gdb-android/ target=_blank rel=noopener>here</a>
):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>gef➤  set solib-absolute-prefix ~/dbgtmp/
</span></span><span style=display:flex><span>gef➤  set solib-search-path ~/dbgtmp/lib64/
</span></span><span style=display:flex><span>gef➤  gef-remote :1337
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> Connected to <span style=color:#e6db74>&#39;:1337&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> Remote information loaded to temporary path <span style=color:#e6db74>&#39;/tmp/gef/6695&#39;</span>
</span></span><span style=display:flex><span>gef➤  sharedlibrary
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><p>The last command will take <strong>ages</strong> to run, but its worth as we get access to almost all symbols we need (there is most likely a better way to do this). Basically we just need to do this once with all the libraries, then identify the libraries we are interested in and create a directory next to <code>lib64</code> on our local machine that only contains this interesting subset of the shared - object files. This will speed up loading time by a lot!</p><h2 id=summary>Summary</h2><p>We have seen some security mechanisms that will make the life of an attacker harder. Depending on the assumptions, like e.g. leaking an address, some mechanisms can be rendered useless. Also, we are now able to get limited source code access and debug Android apps using <code>gdb</code>. This will allow us to exploit the available modules in <em>damnvulnerableapp</em>.</p></article></div></div></div></main><footer class="flex flex-none justify-center"><section class="flex flex-col md:flex-row mx-2 md:mx-0 gap-2 md:gap-0 justify-between w-full max-w-4xl lg:max-w-5xl py-6 text-slate-500 dark:text-slate-300"><div class="flex flex-row"></div><div class=grow></div><div class="flex flex-row"><i class="h-6 w-6 flex-none"><svg class="icon icon-tabler icon-tabler-copyright" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 12m-9 0a9 9 0 1018 0A9 9 0 103 12"/><path d="M14 9.75a3.016 3.016.0 00-4.163.173 2.993 2.993.0 000 4.154A3.016 3.016.0 0014 14.25"/></svg>
</i>2022 - 2024 lolcads</div><div class="flex flex-row"><span class="ml-0 pl-0 md:ml-2 md:pl-2 border-l-0 md:border-l border-slate-300 dark:border-slate-400">Powered by <a href=https://gohugo.io target=_blank rel=noopener class=underline>Hugo</a> <span class=text-red-600>&#9829;</span> <a href=https://github.com/tomowang/hugo-theme-tailwind target=_blank rel=noopener class=underline>Tailwind</a></span></div></section></footer><script src=/main.min.c6372b6836971865bd94bfde974748aca8415824a2facab6ccd66a87384bfacb.js></script><div class="hidden top-1 right-1" id=code-copy><i class="h-6 w-6 block"><svg class="icon icon-tabler icon-tabler-copy" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M7 7m0 2.667A2.667 2.667.0 019.667 7h8.666A2.667 2.667.0 0121 9.667v8.666A2.667 2.667.0 0118.333 21H9.667A2.667 2.667.0 017 18.333z"/><path d="M4.012 16.737A2.005 2.005.0 013 15V5c0-1.1.9-2 2-2h10c.75.0 1.158.385 1.5 1"/></svg></i></div><div class="hidden top-1 right-1" id=code-copy-done><i class="h-6 w-6 block"><svg class="icon icon-tabler icon-tabler-check" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 12l5 5L20 7"/></svg></i></div><script src=/code-copy.min.e7b2a74adef1ed474c335c8bd5e7832b2316b8842b0f9184d65286c5bd64f51a.js></script></body></html>