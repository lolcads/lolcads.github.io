<!doctype html><html lang=en dir=ltr><head><title>friTap - Decrypting TLS on the fly :: lolcads tech blog</title>
<meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Encryption - a curse and a blessing at the same time Digital communication in today&rsquo;s world has a particularly high status in our society. Financial transactions are conducted via online banking, private communication is increasingly limited to digital messenger services, and even health data is experiencing a shift to digital form. Due to the growth of such sensitive digital data, the need for secure transmission of such data has become increasingly important over the past decades."><meta name=keywords content="frida,network,TLS,TLS decryption"><meta name=robots content="noodp"><link rel=manifest href=/manifest.json><meta property="og:url" content="https://lolcads.github.io/posts/2022/08/fritap/"><meta property="og:site_name" content="lolcads tech blog"><meta property="og:title" content="friTap - Decrypting TLS on the fly"><meta property="og:description" content="Encryption - a curse and a blessing at the same time Digital communication in today’s world has a particularly high status in our society. Financial transactions are conducted via online banking, private communication is increasingly limited to digital messenger services, and even health data is experiencing a shift to digital form. Due to the growth of such sensitive digital data, the need for secure transmission of such data has become increasingly important over the past decades."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-08-12T13:09:24+02:00"><meta property="article:modified_time" content="2022-08-12T13:09:24+02:00"><meta property="article:tag" content="Frida"><meta property="article:tag" content="Network"><meta property="article:tag" content="TLS"><meta property="article:tag" content="TLS Decryption"><meta name=twitter:card content="summary"><meta name=twitter:title content="friTap - Decrypting TLS on the fly"><meta name=twitter:description content="Encryption - a curse and a blessing at the same time Digital communication in today’s world has a particularly high status in our society. Financial transactions are conducted via online banking, private communication is increasingly limited to digital messenger services, and even health data is experiencing a shift to digital form. Due to the growth of such sensitive digital data, the need for secure transmission of such data has become increasingly important over the past decades."><link rel=canonical href=https://lolcads.github.io/posts/2022/08/fritap/><link rel="shortcut icon" href=/favicon.ico><link rel=stylesheet href=/css/index.min.c860e17f20d9f258820c02bf7ab3f57c9595d0bc21dede7eda08ccd63ba3f4cc.css></head><body class="flex flex-col min-h-screen w-full bg-slate-50 dark:bg-gray-800"><header class="flex flex-none justify-center z-10"><div class="flex flex-row gap justify-between w-full max-w-4xl lg:max-w-5xl h-12 mt-3"><div class="flex-none ml-2 md:ml-0"><a href=/><img class="h-12 w-12 rounded-full object-cover bg-gray-100" src=/logo.png alt=logo></a></div><div class=flex-1></div><div class=flex-none><nav class="h-full static"><button id=navbar-menu-toggle type=button class="inline-flex items-center p-2 text-sm text-slate-800 dark:text-slate-200 rounded-lg md:hidden" aria-controls=navbar-menu aria-expanded=false>
<span class=sr-only>Open main menu</span>
<i class="w-8 h-8"><svg class="icon icon-tabler icon-tabler-menu-2" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 6h16"/><path d="M4 12h16"/><path d="M4 18h16"/></svg></i></button><div class="absolute md:static top-16 left-0 right-0 z-50 hidden w-full md:block md:w-auto" id=navbar-menu><ul class="flex flex-col mx-2 md:mx-0 md:flex-row md:border-0 rounded-sm md:rounded-full px-3 text-base font-medium text-slate-800 dark:text-slate-200 shadow-lg bg-white dark:bg-gray-600 shadow-slate-800/5 dark:shadow-slate-200/5 ring-1 ring-slate-900/5 dark:ring-slate-100/5"><li id=post><a class="block px-3 py-3 hover:text-emerald-600 text-emerald-600" href=/posts/ title=Blog>Blog</a></li><li id=about><a class="block px-3 py-3 hover:text-emerald-600" href=/about/ title=About>About</a></li><li id=contact><a class="block px-3 py-3 hover:text-emerald-600" href=/contact/ title=Contact>Contact</a></li></ul></div></nav></div><div class="flex-none mx-1"></div><div class="flex-none md:hidden"><a href=/search/ class="inline-flex items-center p-2 text-sm text-slate-800 dark:text-slate-200 rounded-lg" aria-controls=navbar-menu aria-expanded=false><span class=sr-only>Search</span>
<i class="w-8 h-8"><svg class="icon icon-tabler icon-tabler-search" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M10 10m-7 0a7 7 0 1014 0A7 7 0 103 10"/><path d="M21 21l-6-6"/></svg></i></a></div><div class="darkmode-toggle flex flex-none mr-2 md:mr-0"><label for=darkmode-toggle class="flex items-center px-3 cursor-pointer rounded-full bg-gray-100 dark:bg-gray-600" title="Toggle dark mode"><input name=darkmode-toggle id=darkmode-toggle type=checkbox class="sr-only peer" aria-label="Toggle dark mode"><div class="group flex flex-row gap-1 justify-center h-8 px-1 rounded-full bg-white dark:bg-gray-700"><i class="h-6 w-6 flex-none rounded-full bg-yellow-400 place-self-center peer-checked:group-[]:invisible"><svg class="icon icon-tabler icon-tabler-brightness-down" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 12m-3 0a3 3 0 106 0 3 3 0 10-6 0"/><path d="M12 5v.01"/><path d="M17 7v.01"/><path d="M19 12v.01"/><path d="M17 17v.01"/><path d="M12 19v.01"/><path d="M7 17v.01"/><path d="M5 12v.01"/><path d="M7 7v.01"/></svg>
</i><i class="h-6 w-6 flex-none rounded-full place-self-center invisible peer-checked:group-[]:visible"><svg class="icon icon-tabler icon-tabler-moon-stars" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 3c.132.0.263.0.393.0a7.5 7.5.0 007.92 12.446A9 9 0 1112 2.992z"/><path d="M17 4a2 2 0 002 2 2 2 0 00-2 2 2 2 0 00-2-2 2 2 0 002-2"/><path d="M19 11h2m-1-1v2"/></svg></i></div></label></div></div></header><main class="flex flex-auto justify-center"><div class="w-full max-w-4xl lg:max-w-5xl"><div class="flex flex-col mt-6 mx-2 md:mx-0 rounded-lg overflow-hidden shadow-md bg-white dark:bg-gray-700"><div><a href=/posts/2022/08/fritap/></a></div><div class="flex flex-col gap-y-3 p-6"><h1 class="text-4xl font-semibold text-slate-800 dark:text-slate-100"><a href=/posts/2022/08/fritap/>friTap - Decrypting TLS on the fly</a></h1><ul class="flex flex-row flex-wrap text-slate-500 dark:text-slate-300"><li><a href=/tags/frida/ class="flex flex-row text-sm mr-2 py-1"><i class="h-5 w-5 flex-none"><svg class="icon icon-tabler icon-tabler-hash" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 9h14"/><path d="M5 15h14"/><path d="M11 4 7 20"/><path d="M17 4l-4 16"/></svg>
</i><span class=ml-0>Frida</span></a></li><li><a href=/tags/network/ class="flex flex-row text-sm mr-2 py-1"><i class="h-5 w-5 flex-none"><svg class="icon icon-tabler icon-tabler-hash" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 9h14"/><path d="M5 15h14"/><path d="M11 4 7 20"/><path d="M17 4l-4 16"/></svg>
</i><span class=ml-0>Network</span></a></li><li><a href=/tags/tls/ class="flex flex-row text-sm mr-2 py-1"><i class="h-5 w-5 flex-none"><svg class="icon icon-tabler icon-tabler-hash" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 9h14"/><path d="M5 15h14"/><path d="M11 4 7 20"/><path d="M17 4l-4 16"/></svg>
</i><span class=ml-0>TLS</span></a></li><li><a href=/tags/tls-decryption/ class="flex flex-row text-sm mr-2 py-1"><i class="h-5 w-5 flex-none"><svg class="icon icon-tabler icon-tabler-hash" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 9h14"/><path d="M5 15h14"/><path d="M11 4 7 20"/><path d="M17 4l-4 16"/></svg>
</i><span class=ml-0>TLS Decryption</span></a></li></ul><div class="flex flex-col gap-y-1 md:flex-row md:gap-y-0 md:gap-x-4 text-slate-500 dark:text-slate-300"><div class="flex flex-row text-base gap-x-1"><i class="h-6 w-6 flex-none"><svg class="icon icon-tabler icon-tabler-calendar" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 7a2 2 0 012-2h12a2 2 0 012 2v12a2 2 0 01-2 2H6a2 2 0 01-2-2V7z"/><path d="M16 3v4"/><path d="M8 3v4"/><path d="M4 11h16"/><path d="M11 15h1"/><path d="M12 15v3"/></svg>
</i><time datetime=2022-08-12T13:09:24+02:00>2022-08-12</time></div><div class="flex flex-row text-base gap-x-1"><i class="h-6 w-6 flex-none"><svg class="icon icon-tabler icon-tabler-hourglass-high" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M6.5 7h11"/><path d="M6 20v-2a6 6 0 1112 0v2a1 1 0 01-1 1H7a1 1 0 01-1-1z"/><path d="M6 4v2a6 6 0 1012 0V4a1 1 0 00-1-1H7A1 1 0 006 4z"/></svg>
</i><span>16 minutes to read</span></div></div><section class="prose prose-slate dark:prose-invert w-full max-w-4xl lg:max-w-5xl mt-6"><h2>Table of Contents</h2><aside><nav id=TableOfContents><ul><li><a href=#encryption---a-curse-and-a-blessing-at-the-same-time>Encryption - a curse and a blessing at the same time</a></li><li><a href=#man-in-the-middle-proxy-as-a-solution>Man-in-the-middle proxy as a solution</a></li><li><a href=#our-approach>Our approach:</a><ul><li><a href=#abstraction-of-using-a-library>Abstraction of using a library</a></li><li><a href=#fritap-usage>friTap usage</a></li></ul></li><li><a href=#fritap-internals>friTap internals</a><ul><li><a href=#frida>FRIDA</a></li><li><a href=#program-flow>Program flow</a></li><li><a href=#hooking-the-read-function>Hooking the read function</a></li><li><a href=#hooking-the-write-function>Hooking the write function</a></li><li><a href=#key-extraction>Key extraction</a></li></ul></li><li><a href=#special-thanks>Special Thanks</a></li><li><a href=#getting-started>Getting started</a></li></ul></nav></aside></section><article class="mt-6 w-full max-w-4xl lg:max-w-5xl prose prose-slate dark:prose-invert prose-quoteless post-content"><h2 id=encryption---a-curse-and-a-blessing-at-the-same-time>Encryption - a curse and a blessing at the same time</h2><p>Digital communication in today&rsquo;s world has a particularly high status in our society. Financial transactions are conducted via online banking, private communication is increasingly limited to digital messenger services, and even health data is experiencing a shift to digital form. Due to the growth of such sensitive digital data, the need for secure transmission of such data has become increasingly important over the past decades. With the introduction of high-performance and digitally secure cryptographic methods, such as SSL/TLS, today&rsquo;s digital communications are predominantly encrypted. Whereas back then, for example, an attacker could hang himself between the client and the server and read the data traffic without encryption, today all he sees is a jumble of letters.
Encryption is truly a boon for protecting sensitive personal data, but it also has its drawbacks, as with almost everything. Encrypted communications negate the ability to analyze communications, which is very relevant when reverse engineering malware or researching vulnerabilities.</p><h2 id=man-in-the-middle-proxy-as-a-solution>Man-in-the-middle proxy as a solution</h2><p>One of the best known solutions to intercept and decrypt encrypted communications is the so-called &ldquo;man-in-the-middle&rdquo; attack. In this case, the attacker or analyst pretends to be a trustworthy communication partner to the client. However, since the client often does not know how the client&rsquo;s communication partner, referred to hereafter as the server, communicates or behaves, the attacker (or analyst) forwards the communication to the server and pretends to be the client.
To establish encrypted communication via TLS, for example, a certificate is required, which the server sends to the client when the connection is established. So a connection is established between the MitM proxy and the client using a MitM certificate (fake certificate) and a connection is established between the MitM proxy and the server using a server certificate.<div class=not-prose><figure><img src=/2022/08/mitm_proxy_without_cert_pinning.svg alt=MitM loading=lazy></figure></div></p><p>Due to this setup, the communication between client and server is routed through the MitM proxy and can be processed on it without encryption.</p><p>There are some preventive measures that can prevent such an attack, especially on mobile devices. One of the best known measures is the so-called &ldquo;certificate pinning&rdquo;. This involves storing the expected server certificate or a hash of the certificate in the binary of the client itself. If the client subsequently receives a certificate from the alleged server, this is compared with the embedded certificate or verified by means of a hash value. If this verification is not successful, then the connection is aborted.</p><p>A possible solution to this problem would be to modify the pinning code itself:</p><p><div class=not-prose><figure><img src=/2022/08/certpinning_hooking.svg alt=Pinning loading=lazy></figure></div></p><p>This approach is possible, but in many cases it is very time-consuming, since the implementations of the pinning can differ greatly depending on the version and the analysis of the code must be performed again for each new version if the pinning is not used from a well known library. In addition, there are, especially with malware, several different implementations of pinning, which is why a general approach often does not lead to the goal.</p><h2 id=our-approach>Our approach:</h2><p>One thing is certain: in order to get the unencrypted communication, the client application must be &ldquo;attacked&rdquo;. This led us to ask why we don&rsquo;t directly extract the decrypted SSL/TLS stream or the key material from the target appliaction.</p><h3 id=abstraction-of-using-a-library>Abstraction of using a library</h3><p>Most applications that perform encrypted communication use a widely available library to do so, such as OpenSSL and NSS. These libraries try to keep the encryption of the data as abstract as possible, so that the use of the library is very convenient. Among other things, they encapsulate the TLS handshake and the sending and receiving of encrypted data.</p><p>A common program flow utilizing a TLS library looks like this:</p><p>The application wants to establish a secure TLS connection to a server. It uses the TLS library for this purpose, which performs the handshake as shown below:</p><p><div class=not-prose><figure><img src=/2022/08/connection.gif alt="GIF here" loading=lazy></figure></div></p><p>After establishing the TLS connection, data can now be sent and received using the read and write functions of the TLS library as shown in the figure below.</p><p><div class=not-prose><figure><img src=/2022/08/fritap_approach.svg alt="TLS hooking" loading=lazy></figure></div></p><p>Exactly these TLS-read and TLS-write functions are used by the target application to read and write the plaintext from TLS stream, respectively.
Hence our tool, <a href=https://github.com/fkie-cad/friTap target=_blank rel=noopener>friTap</a>
, is hooking them in order to receive the plaintext of the encrypted packets. Beside this friTap is also able to extract the used TLS keys.</p><p><div class=not-prose><figure><img src=/2022/08/hooking_Fritap.svg alt=friTap loading=lazy></figure></div></p><h3 id=fritap-usage>friTap usage</h3><p><a href=https://github.com/fkie-cad/friTap target=_blank rel=noopener>friTap</a>
comes with two operation modes. One is to get the plaintext from the TLS payload as PCAP and the other is to get the used TLS keys.
In order to get the decrypted TLS payload we need the <code>-p</code> parameter:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ ./friTap.py –m –p decryptedTLS.pcap &lt;target_app&gt;
</span></span><span class=line><span class=cl>…
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> BoringSSL.so found <span class=p>&amp;</span> will be hooked on Android!
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> Android dynamic loader hooked.
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> Logging pcap to decryptedTLS.pcap
</span></span></code></pre></div><p>The <code>-m</code> paramter indicates that we are analysing a mobile application in the above example. For extracting the TLS keys from a target application we need the <code>-k</code> parameter:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ ./friTap.py –m –k TLS_keys.log &lt;target_app&gt;
</span></span><span class=line><span class=cl>…
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> BoringSSL.so found <span class=p>&amp;</span> will be hooked on Android!
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> Android dynamic loader hooked.
</span></span><span class=line><span class=cl><span class=o>[</span>*<span class=o>]</span> Logging keylog file to TLS_keys.log
</span></span></code></pre></div><p>As a result friTap writes all TLS keys to the <code>TLS_keys.log</code> file using the <a href=https://firefox-source-docs.mozilla.org/security/nss/legacy/key_log_format/index.html target=_blank rel=noopener>NSS Key Log Format</a>
.</p><h2 id=fritap-internals>friTap internals</h2><p>After understanding the overall approach lets dive into the internals of <a href=https://github.com/fkie-cad/friTap target=_blank rel=noopener>friTap</a>
.</p><h3 id=frida>FRIDA</h3><p><a href=https://github.com/fkie-cad/friTap target=_blank rel=noopener>friTap</a>
is built on the dynamic instrumentation toolkit <a href=https://frida.re/ target=_blank rel=noopener>FRIDA</a>
, which allows developers, reverse engineers and security researchers to dynamically analyze and instrument programs. FRIDA allows you to execute Javascript code within the target program, which gives you the ability to hook functions, read and write program memory, execute custom code, and more. A Python API is provided for using FRIDA, which makes it very user-friendly.</p><p>To accomplish this, FRIDA injects the <a href=https://bellard.org/quickjs/ target=_blank rel=noopener>QuickJS Javascript engine</a>
(can also be changed to the <a href=https://v8.dev/ target=_blank rel=noopener>V8 runtime</a>
) into the target process and an agent that acts as communication interfaces between the instrumentarized process and its own tool later on.
After injection of the engine and the agent, the user is able to execute own Javascript code inside the target process and receive data from it. More on the inner workings of FRIDA can be found <a href=https://frida.re/docs/presentations/ target=_blank rel=noopener>here</a>
.</p><h3 id=program-flow>Program flow</h3><p>A rough overview of the flow of friTap can be seen in the following diagrams, which are explained in more detail in the sections that follow.
The first step after loading the friTap JS script into the target process is to identify the operating system (os) of the target process:</p><p><div class=not-prose><figure><img src=/2022/08/fritap_choose_os_agent_final.svg alt loading=lazy></figure></div></p><p>Then an os specific agent will be loaded. This agent enumerates all loaded libraries/modules from the target process. FRIDA provides a function for this purpose that returns for each loaded module its name, base address, size and path in the file system. Based on the name of the modules friTap can identify a SSL/TLS library. Depending on the version and operating system, the name of the loaded module can vary greatly. friTap tries to cover all potential module names of supported libraries as best as possible using expressive regex. The operating system-specific agent determines which libraries are supported and how its hooking is implemented:</p><p><div class=not-prose><figure><img src=/2022/08/fritap_hook.svg alt loading=lazy></figure></div></p><p>When a supported library is detected, friTap tries to hook the <code>SSL-read()</code>, <code>SSL-write()</code> and <code>SSL-keyexport()</code> functions of the respective library and all other functions required for this. Sometimes the target library doesn&rsquo;t provide a key export function, in those cases friTap have to parse the heap in order to find the keys in the memory of the target process.</p><p>Next we want to dive into the implementation details of the mentioned parts of friTap. As mentioned above friTap checks at first on which plattform our target process is running and invoke than its respective os specific agent:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=kd>function</span> <span class=nx>load_os_specific_agent</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span><span class=p>(</span><span class=nx>isWindows</span><span class=p>()){</span>
</span></span><span class=line><span class=cl>        <span class=nx>load_windows_hooking_agent</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span><span class=k>else</span> <span class=k>if</span><span class=p>(</span><span class=nx>isAndroid</span><span class=p>()){</span>
</span></span><span class=line><span class=cl>        <span class=nx>load_android_hooking_agent</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span><span class=k>else</span> <span class=k>if</span><span class=p>(</span><span class=nx>isLinux</span><span class=p>()){</span>
</span></span><span class=line><span class=cl>        <span class=nx>load_linux_hooking_agent</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span><span class=k>else</span> <span class=k>if</span><span class=p>(</span><span class=nx>isiOS</span><span class=p>()){</span>
</span></span><span class=line><span class=cl>        <span class=nx>load_ios_hooking_agent</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span><span class=k>else</span> <span class=k>if</span><span class=p>(</span><span class=nx>isMacOS</span><span class=p>()){</span>
</span></span><span class=line><span class=cl>        <span class=nx>load_macos_hooking_agent</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span><span class=k>else</span><span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>log</span><span class=p>(</span><span class=s2>&#34;Error: not supported plattform!\nIf you want to have support for this plattform please make an issue at our github page.&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>This agent installs the hooks for the detected libraries. First the enumerations of the supported SSL/TLS libaries are safed (<code>module_library_mapping</code>) and provided for the different hooks. In the following we see how this is done for Android:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=kr>export</span> <span class=kd>function</span> <span class=nx>load_android_hooking_agent</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>module_library_mapping</span><span class=p>[</span><span class=nx>plattform_name</span><span class=p>]</span> <span class=o>=</span> <span class=p>[[</span><span class=sr>/.*libssl_sb.so/</span><span class=p>,</span> <span class=nx>boring_execute</span><span class=p>],[</span><span class=sr>/.*libssl\.so/</span><span class=p>,</span> <span class=nx>boring_execute</span><span class=p>],[</span><span class=sr>/.*libgnutls\.so/</span><span class=p>,</span> <span class=nx>gnutls_execute</span><span class=p>],[</span><span class=sr>/.*libwolfssl\.so/</span><span class=p>,</span> <span class=nx>wolfssl_execute</span><span class=p>],[</span><span class=sr>/.*libnspr[0-9]?\.so/</span><span class=p>,</span><span class=nx>nss_execute</span><span class=p>],</span> <span class=p>[</span><span class=sr>/libmbedtls\.so.*/</span><span class=p>,</span> <span class=nx>mbedTLS_execute</span><span class=p>]];</span>
</span></span><span class=line><span class=cl>    <span class=nx>install_java_hooks</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=nx>hook_native_Android_SSL_Libs</span><span class=p>(</span><span class=nx>module_library_mapping</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>hook_Android_Dynamic_Loader</span><span class=p>(</span><span class=nx>module_library_mapping</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>If supported, friTap installs java based hooks. Right now these java hooks only installed for Android applications. Next the plattform (operating system) specific hooks are installed. After a supported SSL/TLS library has been found, the search for the corresponding functions (read, write, key export) inside the module is started. This is done using the mapped functions from <code>module_library_mapping</code>. When we have a closer look into the enumerations we can see that for each detected library an appropriate so called <code>&lt;libname>-execute</code> function is mapped. This mapped function contains the implementation details of the <code>SSL-read()</code>, <code>SSL-write()</code> and <code>SSL-keyexport()</code> hooks. Strictly speaking, for each identified library, its platform-specific hook (read, write, export) is installed for the corresponding library. Fortunately, the majority of hooking implementations are platform independent, with only a few platforms having differences. This means that the overall hooking implementation for a specific library is provided by an os independent super class. In the following we see the Android OpenSSL hooking implementation with the implementations inherited from its superclass:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=cm>/* from openssl_boringssl_android.ts */</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>OpenSSL_BoringSSL_Android</span> <span class=kr>extends</span> <span class=nx>OpenSSL_BoringSSL</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>constructor</span><span class=p>(</span><span class=kr>public</span> <span class=nx>moduleName</span><span class=o>:</span><span class=nb>String</span><span class=p>,</span> <span class=kr>public</span> <span class=nx>socket_library</span><span class=o>:</span><span class=nb>String</span><span class=p>){</span>
</span></span><span class=line><span class=cl>        <span class=kr>super</span><span class=p>(</span><span class=nx>moduleName</span><span class=p>,</span><span class=nx>socket_library</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>execute_hooks</span><span class=p>(){</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>install_plaintext_read_hook</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>install_plaintext_write_hook</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>install_tls_keys_callback_hook</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kd>function</span> <span class=nx>boring_execute</span><span class=p>(</span><span class=nx>moduleName</span><span class=o>:</span><span class=nb>String</span><span class=p>){</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>boring_ssl</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>OpenSSL_BoringSSL_Android</span><span class=p>(</span><span class=nx>moduleName</span><span class=p>,</span><span class=nx>socket_library</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>boring_ssl</span><span class=p>.</span><span class=nx>execute_hooks</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>The specific functions of the library are only then hooked in the superclass. This is done by library&rsquo;s specific function names (SSL_read, SSL_write&mldr;) which are passed to our <code>readAddresses()</code> function in order to obtain the addresses for hooking.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=cm>/* super class openssl_boringssl.ts */</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kr>class</span> <span class=nx>OpenSSL_BoringSSL</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// global variables
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nx>library_method_mapping</span><span class=o>:</span> <span class=p>{</span> <span class=p>[</span><span class=nx>key</span><span class=o>:</span> <span class=nx>string</span><span class=p>]</span><span class=o>:</span> <span class=nb>Array</span><span class=o>&lt;</span><span class=nb>String</span><span class=o>&gt;</span> <span class=p>}</span> <span class=o>=</span> <span class=p>{};</span>
</span></span><span class=line><span class=cl>    <span class=nx>addresses</span><span class=o>:</span> <span class=p>{</span> <span class=p>[</span><span class=nx>key</span><span class=o>:</span> <span class=nx>string</span><span class=p>]</span><span class=o>:</span> <span class=nx>NativePointer</span> <span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=p>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>constructor</span><span class=p>(</span><span class=kr>public</span> <span class=nx>moduleName</span><span class=o>:</span><span class=nb>String</span><span class=p>,</span> <span class=kr>public</span> <span class=nx>socket_library</span><span class=o>:</span><span class=nb>String</span><span class=p>,</span><span class=kr>public</span> <span class=nx>passed_library_method_mapping</span><span class=o>?:</span> <span class=p>{</span> <span class=p>[</span><span class=nx>key</span><span class=o>:</span> <span class=nx>string</span><span class=p>]</span><span class=o>:</span> <span class=nb>Array</span><span class=o>&lt;</span><span class=nb>String</span><span class=o>&gt;</span> <span class=p>}){</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=p>(</span><span class=k>typeof</span> <span class=nx>passed_library_method_mapping</span> <span class=o>!==</span> <span class=s1>&#39;undefined&#39;</span><span class=p>){</span>
</span></span><span class=line><span class=cl>            <span class=k>this</span><span class=p>.</span><span class=nx>library_method_mapping</span> <span class=o>=</span> <span class=nx>passed_library_method_mapping</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span><span class=k>else</span><span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>this</span><span class=p>.</span><span class=nx>library_method_mapping</span><span class=p>[</span><span class=sb>`*</span><span class=si>${</span><span class=nx>moduleName</span><span class=si>}</span><span class=sb>*`</span><span class=p>]</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;SSL_read&#34;</span><span class=p>,</span> <span class=s2>&#34;SSL_write&#34;</span><span class=p>,</span> <span class=s2>&#34;SSL_get_fd&#34;</span><span class=p>,</span> <span class=s2>&#34;SSL_get_session&#34;</span><span class=p>,</span> <span class=s2>&#34;SSL_SESSION_get_id&#34;</span><span class=p>,</span> <span class=s2>&#34;SSL_new&#34;</span><span class=p>,</span> <span class=s2>&#34;SSL_CTX_set_keylog_callback&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=k>this</span><span class=p>.</span><span class=nx>library_method_mapping</span><span class=p>[</span><span class=sb>`*</span><span class=si>${</span><span class=nx>socket_library</span><span class=si>}</span><span class=sb>*`</span><span class=p>]</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;getpeername&#34;</span><span class=p>,</span> <span class=s2>&#34;getsockname&#34;</span><span class=p>,</span> <span class=s2>&#34;ntohs&#34;</span><span class=p>,</span> <span class=s2>&#34;ntohl&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=k>this</span><span class=p>.</span><span class=nx>addresses</span> <span class=o>=</span> <span class=nx>readAddresses</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>library_method_mapping</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>...</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=p>...</span>
</span></span></code></pre></div><p>FRIDA provides with the <a href=https://frida.re/docs/javascript-api/#apiresolver target=_blank rel=noopener>ApiResolver</a>
a function <code>enumerateMatches("exports:" + library_name + "!" + method)</code>:
This is passed the name of the function, the name of the module and the type (export, import) in a single string. If a match is found, information about this function is returned, of which friTap only needs and stores the address. Below is the whole listing of friTap&rsquo;s <code>readAddresses()</code> function:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=c1>//File: agent/shared/shared_functions.ts
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>* Read the addresses for the given methods from the given modules
</span></span></span><span class=line><span class=cl><span class=cm>* @param {{[key: string]: Array&lt;String&gt; }} library_method_mapping A string indexed list of arrays, mapping modules to methods
</span></span></span><span class=line><span class=cl><span class=cm>* @return {{[key: string]: NativePointer }} A string indexed list of NativePointers, which point to the respective methods
</span></span></span><span class=line><span class=cl><span class=cm>*/</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=kd>function</span> <span class=nx>readAddresses</span><span class=p>(</span><span class=nx>library_method_mapping</span><span class=o>:</span> <span class=p>{</span> <span class=p>[</span><span class=nx>key</span><span class=o>:</span> <span class=nx>string</span><span class=p>]</span><span class=o>:</span> <span class=nb>Array</span><span class=o>&lt;</span><span class=nb>String</span><span class=o>&gt;</span> <span class=p>})</span><span class=o>:</span> <span class=p>{</span> <span class=p>[</span><span class=nx>key</span><span class=o>:</span> <span class=nx>string</span><span class=p>]</span><span class=o>:</span> <span class=nx>NativePointer</span> <span class=p>}</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>resolver</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>ApiResolver</span><span class=p>(</span><span class=s2>&#34;module&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>addresses</span><span class=o>:</span> <span class=p>{</span> <span class=p>[</span><span class=nx>key</span><span class=o>:</span> <span class=nx>string</span><span class=p>]</span><span class=o>:</span> <span class=nx>NativePointer</span> <span class=p>}</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>library_name</span> <span class=k>in</span> <span class=nx>library_method_mapping</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>library_method_mapping</span><span class=p>[</span><span class=nx>library_name</span><span class=p>].</span><span class=nx>forEach</span><span class=p>(</span><span class=kd>function</span> <span class=p>(</span><span class=nx>method</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=kd>var</span> <span class=nx>matches</span> <span class=o>=</span> <span class=nx>resolver</span><span class=p>.</span><span class=nx>enumerateMatches</span><span class=p>(</span><span class=s2>&#34;exports:&#34;</span> <span class=o>+</span> <span class=nx>library_name</span> <span class=o>+</span> <span class=s2>&#34;!&#34;</span> <span class=o>+</span> <span class=nx>method</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=kd>var</span> <span class=nx>match_number</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=kd>var</span> <span class=nx>method_name</span> <span class=o>=</span> <span class=nx>method</span><span class=p>.</span><span class=nx>toString</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>if</span><span class=p>(</span><span class=nx>method_name</span><span class=p>.</span><span class=nx>endsWith</span><span class=p>(</span><span class=s2>&#34;*&#34;</span><span class=p>)){</span>
</span></span><span class=line><span class=cl>             <span class=nx>method_name</span> <span class=o>=</span> <span class=nx>method_name</span><span class=p>.</span><span class=nx>substring</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=nx>method_name</span><span class=p>.</span><span class=nx>length</span><span class=o>-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=nx>matches</span><span class=p>.</span><span class=nx>length</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=s2>&#34;Could not find &#34;</span> <span class=o>+</span> <span class=nx>library_name</span> <span class=o>+</span> <span class=s2>&#34;!&#34;</span> <span class=o>+</span> <span class=nx>method</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nx>matches</span><span class=p>.</span><span class=nx>length</span> <span class=o>==</span> <span class=mi>1</span><span class=p>){</span>
</span></span><span class=line><span class=cl>            <span class=nx>devlog</span><span class=p>(</span><span class=s2>&#34;Found &#34;</span> <span class=o>+</span> <span class=nx>method</span> <span class=o>+</span> <span class=s2>&#34; &#34;</span> <span class=o>+</span> <span class=nx>matches</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=nx>address</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span><span class=k>else</span><span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>for</span> <span class=p>(</span><span class=kd>var</span> <span class=nx>k</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>k</span> <span class=o>&lt;</span> <span class=nx>matches</span><span class=p>.</span><span class=nx>length</span><span class=p>;</span> <span class=nx>k</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span><span class=p>(</span><span class=nx>matches</span><span class=p>[</span><span class=nx>k</span><span class=p>].</span><span class=nx>name</span><span class=p>.</span><span class=nx>endsWith</span><span class=p>(</span><span class=nx>method_name</span><span class=p>)){</span>
</span></span><span class=line><span class=cl>                        <span class=nx>match_number</span> <span class=o>=</span> <span class=nx>k</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                        <span class=nx>devlog</span><span class=p>(</span><span class=s2>&#34;Found &#34;</span> <span class=o>+</span> <span class=nx>method</span> <span class=o>+</span> <span class=s2>&#34; &#34;</span> <span class=o>+</span> <span class=nx>matches</span><span class=p>[</span><span class=nx>match_number</span><span class=p>].</span><span class=nx>address</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                        <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                    <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=nx>addresses</span><span class=p>[</span><span class=nx>method_name</span><span class=p>]</span> <span class=o>=</span> <span class=nx>matches</span><span class=p>[</span><span class=nx>match_number</span><span class=p>].</span><span class=nx>address</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>})</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>addresses</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>After all relevant function addresses are available, friTap finally installs the hooks when entering or leaving the respective functions. More on this later.</p><p>It is possible that a program to be analyzed does not load an SSL/TLS library at program start or loads an SSL/TLS library again at another time. For this case friTap hooks a function in the respective standard library of the operating system. The following is the implementation for Android:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=cm>/* File agent/android/android_agent.ts */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>hook_Android_Dynamic_Loader</span><span class=p>(</span><span class=nx>module_library_mapping</span><span class=o>:</span> <span class=p>{</span> <span class=p>[</span><span class=nx>key</span><span class=o>:</span> <span class=nx>string</span><span class=p>]</span><span class=o>:</span> <span class=nb>Array</span><span class=o>&lt;</span><span class=p>[</span><span class=nx>any</span><span class=p>,</span> <span class=p>(</span><span class=nx>moduleName</span><span class=o>:</span> <span class=nx>string</span><span class=p>)=&gt;</span><span class=k>void</span><span class=p>]</span><span class=o>&gt;</span> <span class=p>})</span><span class=o>:</span> <span class=k>void</span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=p>...</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>regex_libdl</span> <span class=o>=</span> <span class=sr>/.*libdl.*\.so/</span>
</span></span><span class=line><span class=cl>    <span class=kr>const</span> <span class=nx>libdl</span> <span class=o>=</span> <span class=nx>moduleNames</span><span class=p>.</span><span class=nx>find</span><span class=p>(</span><span class=nx>element</span> <span class=p>=&gt;</span> <span class=nx>element</span><span class=p>.</span><span class=nx>match</span><span class=p>(</span><span class=nx>regex_libdl</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>let</span> <span class=nx>dl_exports</span> <span class=o>=</span> <span class=nx>Process</span><span class=p>.</span><span class=nx>getModuleByName</span><span class=p>(</span><span class=nx>libdl</span><span class=p>).</span><span class=nx>enumerateExports</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>dlopen</span> <span class=o>=</span> <span class=s2>&#34;dlopen&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kd>var</span> <span class=nx>ex</span> <span class=k>of</span> <span class=nx>dl_exports</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>ex</span><span class=p>.</span><span class=nx>name</span> <span class=o>===</span> <span class=s2>&#34;android_dlopen_ext&#34;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>dlopen</span> <span class=o>=</span> <span class=s2>&#34;android_dlopen_ext&#34;</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>Interceptor</span><span class=p>.</span><span class=nx>attach</span><span class=p>(</span><span class=nx>Module</span><span class=p>.</span><span class=nx>getExportByName</span><span class=p>(</span><span class=nx>libdl</span><span class=p>,</span> <span class=nx>dlopen</span><span class=p>),</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>onEnter</span><span class=o>:</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>args</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>this</span><span class=p>.</span><span class=nx>moduleName</span> <span class=o>=</span> <span class=nx>args</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=nx>readCString</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=nx>onLeave</span><span class=o>:</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>retval</span><span class=o>:</span> <span class=nx>any</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>moduleName</span> <span class=o>!=</span> <span class=kc>undefined</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>for</span><span class=p>(</span><span class=kd>let</span> <span class=nx>map</span> <span class=k>of</span> <span class=nx>module_library_mapping</span><span class=p>[</span><span class=nx>plattform_name</span><span class=p>]){</span>
</span></span><span class=line><span class=cl>                    <span class=kd>let</span> <span class=nx>regex</span> <span class=o>=</span> <span class=nx>map</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                    <span class=kd>let</span> <span class=nx>func</span> <span class=o>=</span> <span class=nx>map</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=p>(</span><span class=nx>regex</span><span class=p>.</span><span class=nx>test</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>moduleName</span><span class=p>)){</span>
</span></span><span class=line><span class=cl>                        <span class=nx>log</span><span class=p>(</span><span class=sb>`</span><span class=si>${</span><span class=k>this</span><span class=p>.</span><span class=nx>moduleName</span><span class=si>}</span><span class=sb> was loaded &amp; will be hooked on Android!`</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                        <span class=nx>func</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>moduleName</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=p>}</span> 
</span></span><span class=line><span class=cl>                    
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=sb>`[*] Android dynamic loader hooked.`</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Now all functions for extracting the streams or the key material should have been identified so that friTap can use the hooks for extracting the plaintext payload or the TLS keys.</p><p>Lets dive into the hooking implementations itself. The way of instrumentation varies partly between the different supported libraries and plattform, but all follow the same principle.</p><h3 id=hooking-the-read-function>Hooking the read function</h3><p>The read functions of the libraries generally have function signature of the following structure:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=kr>int</span> <span class=nx>read</span> <span class=p>(</span><span class=k>void</span><span class=o>*</span><span class=p>,</span> <span class=k>void</span><span class=o>*</span><span class=p>,</span> <span class=kr>int</span><span class=p>)</span>
</span></span></code></pre></div><p>The first parameter is a pointer to an SSL object that holds all information about the SSL session in use in the background. This object is used to identify the SSL/TLS stream over which data is received. The second parameter is a pointer to a temporary buffer that holds unencrypted data received from the SSL/TLS stream. The third parameter is the maximum number of bytes that can be stored in the buffer for data received from the SSL/TLS stream.</p><p>For friTap, the second parameter, the buffer containing the unencrypted data, is the important one. To read the contents of this buffer, friTap needs the pointer to it and the number of bytes that were received.
FRIDA&rsquo;s interceptor allows to define hooks for function start and end. These callbacks are executed before the execution and after the execution of the function.
The callback function for the hook of the function start is passed all parameters of the hooked function. Thus the callback function is able to extract and manipulate all passed parameters.
friTap takes advantage of this and extracts from the parameters the second pointer of the read function, which points to the buffer that holds the received, unencrypted data. The implementation is here as an example (using OpenSSL) for the other implementations and it looks like this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=nx>Interceptor</span><span class=p>.</span><span class=nx>attach</span><span class=p>(</span><span class=nx>addresses</span><span class=p>[</span><span class=s2>&#34;SSL_read&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>onEnter</span><span class=o>:</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>args</span><span class=o>:</span> <span class=nx>any</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=kd>var</span> <span class=nx>message</span> <span class=o>=</span> <span class=nx>getPortsAndAddresses</span><span class=p>(</span><span class=nx>SSL_get_fd</span><span class=p>(</span><span class=nx>args</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span> <span class=nx>as</span> <span class=nx>number</span><span class=p>,</span> <span class=kc>true</span><span class=p>,</span> <span class=nx>addresses</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nx>message</span><span class=p>[</span><span class=s2>&#34;ssl_session_id&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=nx>getSslSessionId</span><span class=p>(</span><span class=nx>args</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=nx>message</span><span class=p>[</span><span class=s2>&#34;function&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&#34;SSL_read&#34;</span>
</span></span><span class=line><span class=cl>            <span class=k>this</span><span class=p>.</span><span class=nx>message</span> <span class=o>=</span> <span class=nx>message</span>
</span></span><span class=line><span class=cl>            <span class=k>this</span><span class=p>.</span><span class=nx>buf</span> <span class=o>=</span> <span class=nx>args</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>...</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span></code></pre></div><p>The pointer to the buffer is in the paramter array named <code>args</code>, strictly speaking in the second position (it is the second function parameter). This is now saved in the execution context using <code>this.buf = args[1]</code>, since the buffer will only be filled with the received data after the read function has been executed.</p><p>The hook of the function end has exactly one parameter, the return value of the function. In the case of the read function, this is the number of bytes received, which is important for reading the buffer. The hook for the end of the function looks like the following, again demonstrated with OpenSSL as an example:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=nx>Interceptor</span><span class=p>.</span><span class=nx>attach</span><span class=p>(</span><span class=nx>addresses</span><span class=p>[</span><span class=s2>&#34;SSL_read&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>       <span class=p>...</span>
</span></span><span class=line><span class=cl>        <span class=nx>onLeave</span><span class=o>:</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>retval</span><span class=o>:</span> <span class=nx>any</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>retval</span> <span class=o>|=</span> <span class=mi>0</span> <span class=c1>// Cast retval to 32-bit integer.
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>if</span> <span class=p>(</span><span class=nx>retval</span> <span class=o>&lt;=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=kr>const</span> <span class=nx>buffer_content</span> <span class=o>=</span> <span class=k>this</span><span class=p>.</span><span class=nx>buf</span><span class=p>.</span><span class=nx>readByteArray</span><span class=p>(</span><span class=nx>retval</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>this</span><span class=p>.</span><span class=nx>message</span><span class=p>[</span><span class=s2>&#34;contentType&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&#34;datalog&#34;</span>
</span></span><span class=line><span class=cl>            <span class=nx>send</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>message</span><span class=p>,</span> <span class=nx>buffer_content</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>})</span>
</span></span></code></pre></div><p><code>retval</code> is the return value of the read function, i.e. the number of bytes received. The previously saved pointer to the buffer can now be read with <code>readByteArray()</code>. By the return value of the read function friTap knows exactly how many bytes have to be read from the buffer. The extracted bytes are then stored in a dictionary object, which in addition to the data also contains information such as port numbers, sender and receiver addresses, etc. . This is then sent via <code>send()</code> from the target process to the main script (<a href=https://github.com/fkie-cad/friTap/blob/9ba62ad1aecffb3baed812690b74efe99d970d22/friTap.py target=_blank rel=noopener>python script</a>
), which then processes this information.</p><h3 id=hooking-the-write-function>Hooking the write function</h3><p>As with the read functions, the write functions have the same function signature for all libraries supported by friTap:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=kr>int</span> <span class=nx>write</span> <span class=p>(</span><span class=k>void</span><span class=o>*</span><span class=p>,</span> <span class=k>void</span><span class=o>*</span><span class=p>,</span> <span class=kr>int</span><span class=p>)</span>
</span></span></code></pre></div><p>The first parameter is a pointer to an SSL object that holds all information about the SSL session being used in the background. This object is used to identify the SSL/TLS stream over which data is sent.
The second parameter is a pointer to a buffer that holds the data to be transmitted, in unencrypted form.
The third parameter specifies how many bytes from the referenced buffer should be sent over the associated SSL/TLS stream.</p><p>Unlike the read function, all information necessary for friTap is already available before function execution. The implementation is again exemplified with the implementation of OpenSSL:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=nx>Interceptor</span><span class=p>.</span><span class=nx>attach</span><span class=p>(</span><span class=nx>addresses</span><span class=p>[</span><span class=s2>&#34;SSL_write&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>onEnter</span><span class=o>:</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>args</span><span class=o>:</span> <span class=nx>any</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=kd>var</span> <span class=nx>message</span> <span class=o>=</span> <span class=nx>getPortsAndAddresses</span><span class=p>(</span><span class=nx>SSL_get_fd</span><span class=p>(</span><span class=nx>args</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span> <span class=nx>as</span> <span class=nx>number</span><span class=p>,</span> <span class=kc>false</span><span class=p>,</span> <span class=nx>addresses</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nx>message</span><span class=p>[</span><span class=s2>&#34;ssl_session_id&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=nx>getSslSessionId</span><span class=p>(</span><span class=nx>args</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=nx>message</span><span class=p>[</span><span class=s2>&#34;function&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&#34;SSL_write&#34;</span>
</span></span><span class=line><span class=cl>            <span class=nx>message</span><span class=p>[</span><span class=s2>&#34;contentType&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&#34;datalog&#34;</span>
</span></span><span class=line><span class=cl>            <span class=kr>const</span> <span class=nx>bytesToBeSent</span> <span class=o>=</span> <span class=nx>args</span><span class=p>[</span><span class=mi>1</span><span class=p>].</span><span class=nx>readByteArray</span><span class=p>(</span><span class=nb>parseInt</span><span class=p>(</span><span class=nx>args</span><span class=p>[</span><span class=mi>2</span><span class=p>]))</span>
</span></span><span class=line><span class=cl>            <span class=nx>send</span><span class=p>(</span><span class=nx>message</span><span class=p>,</span> <span class=nx>bytesToBeSent</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>})</span>
</span></span></code></pre></div><p><code>args[1]</code> is the pointer to the buffer, <code>args[2]</code> the number of bytes to send. With <code>readByteArray()</code> the bytes to send can be copied from the buffer. The extracted bytes are then stored in a dictionary object, which contains besides the data also information like port numbers, sender and receiver address etc.. This is then sent via <code>send()</code> from the target process to the main script (Python script), which then processes this information.</p><h3 id=key-extraction>Key extraction</h3><p>In addition to hooking the read and write functions, friTap also provides the ability to export all keys created/received during the handshake. These keys can then be used to decrypt encrypted TLS traffic. Wirehsark provides the ability to specify a keylog file that friTap created when the client connected to the server.
The implementation of this functionality varies widely. This is due to the default behavior of the individual libraries, especially depending on the operating system.</p><p>Again, we would like to show an example, based on the implementation of OpenSSL on linux:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=kr>const</span> <span class=nx>SSL_CTX_set_keylog_callback</span> <span class=o>=</span> <span class=nx>ObjC</span><span class=p>.</span><span class=nx>available</span> <span class=o>?</span> <span class=k>new</span> <span class=nx>NativeFunction</span><span class=p>(</span><span class=nx>addresses</span><span class=p>[</span><span class=s2>&#34;SSL_CTX_set_info_callback&#34;</span><span class=p>],</span> <span class=s2>&#34;void&#34;</span><span class=p>,</span> <span class=p>[</span><span class=s2>&#34;pointer&#34;</span><span class=p>,</span> <span class=s2>&#34;pointer&#34;</span><span class=p>])</span> <span class=o>:</span> <span class=k>new</span> <span class=nx>NativeFunction</span><span class=p>(</span><span class=nx>addresses</span><span class=p>[</span><span class=s2>&#34;SSL_CTX_set_keylog_callback&#34;</span><span class=p>],</span> <span class=s2>&#34;void&#34;</span><span class=p>,</span> <span class=p>[</span><span class=s2>&#34;pointer&#34;</span><span class=p>,</span> <span class=s2>&#34;pointer&#34;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>keylog_callback</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>NativeCallback</span><span class=p>(</span><span class=kd>function</span> <span class=p>(</span><span class=nx>ctxPtr</span><span class=p>,</span> <span class=nx>linePtr</span><span class=o>:</span> <span class=nx>NativePointer</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>var</span> <span class=nx>message</span><span class=o>:</span> <span class=p>{</span> <span class=p>[</span><span class=nx>key</span><span class=o>:</span> <span class=nx>string</span><span class=p>]</span><span class=o>:</span> <span class=nx>string</span> <span class=o>|</span> <span class=nx>number</span> <span class=o>|</span> <span class=kc>null</span> <span class=p>}</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>    <span class=nx>message</span><span class=p>[</span><span class=s2>&#34;contentType&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&#34;keylog&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>message</span><span class=p>[</span><span class=s2>&#34;keylog&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=nx>linePtr</span><span class=p>.</span><span class=nx>readCString</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=nx>send</span><span class=p>(</span><span class=nx>message</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>},</span> <span class=s2>&#34;void&#34;</span><span class=p>,</span> <span class=p>[</span><span class=s2>&#34;pointer&#34;</span><span class=p>,</span> <span class=s2>&#34;pointer&#34;</span><span class=p>])</span>
</span></span></code></pre></div><p>If OpenSSL is selected as a dynamically loaded library, many functions are exported by default. Fortunately, the function <code>SSL_CTX_set_keylog_callback</code> (linux desktop) is also exported. This function gives the user the ability to define a callback function that will be called whenever new key material is generated or received. This function is passed two parameters when it is called: An SSL object associated with the connection and the newly generated or received key material in the form of a string. FRIDA allows you to define your own callback functions, which we did for this use case. friTap creates a new callback function that reads the passed string and stores it in a dictionary object, which is sent to the main script (python script) and processed by it (log or write out).</p><p>In order to register the own callback, the function <code>SSL_CTX_set_keylog_callback</code> must be called once, before the handshake, with the callback function as parameter. friTap hooks the <code>SSL_new</code> method for this. This function is called before the handshake, but also after the SSL context has been created, i.e. the binding options have already been set so that the callback function can receive the key material of the subsequent handshake.</p><p>For each operating system, friTap knows the usual library/module and the function that is ultimately responsible for loading the new library. When a new library is loaded into program memory, the name of the new module is checked to see if it matches any of the SSL/TLS library names. If this is the case, the usual read, write and key export functions are hooked.</p><h2 id=special-thanks>Special Thanks</h2><p>We like to thank our colleague Max J. Ufer for his initial work in creating friTap. Further we like to thank Martin Lambertz and Jan-Niclas Hilgert for their feedback while working on friTap. Finally we have to thank Ole André Vadla Ravnås for his tireless efforts in the development of FRIDA.</p><h2 id=getting-started>Getting started</h2><p>friTap can be downloaded here: <a href=https://github.com/fkie-cad/friTap target=_blank rel=noopener>https://github.com/fkie-cad/friTap</a></p></article></div></div></div></main><footer class="flex flex-none justify-center"><section class="flex flex-col md:flex-row mx-2 md:mx-0 gap-2 md:gap-0 justify-between w-full max-w-4xl lg:max-w-5xl py-6 text-slate-500 dark:text-slate-300"><div class="flex flex-row"></div><div class=grow></div><div class="flex flex-row"><i class="h-6 w-6 flex-none"><svg class="icon icon-tabler icon-tabler-copyright" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 12m-9 0a9 9 0 1018 0A9 9 0 103 12"/><path d="M14 9.75a3.016 3.016.0 00-4.163.173 2.993 2.993.0 000 4.154A3.016 3.016.0 0014 14.25"/></svg>
</i>2022 - 2024 lolcads</div><div class="flex flex-row"><span class="ml-0 pl-0 md:ml-2 md:pl-2 border-l-0 md:border-l border-slate-300 dark:border-slate-400">Powered by <a href=https://gohugo.io target=_blank rel=noopener class=underline>Hugo</a> <span class=text-red-600>&#9829;</span> <a href=https://github.com/tomowang/hugo-theme-tailwind target=_blank rel=noopener class=underline>Tailwind</a></span></div></section></footer><script src=/main.min.c6372b6836971865bd94bfde974748aca8415824a2facab6ccd66a87384bfacb.js></script><div class="hidden top-1 right-1" id=code-copy><i class="h-6 w-6 block"><svg class="icon icon-tabler icon-tabler-copy" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M7 7m0 2.667A2.667 2.667.0 019.667 7h8.666A2.667 2.667.0 0121 9.667v8.666A2.667 2.667.0 0118.333 21H9.667A2.667 2.667.0 017 18.333z"/><path d="M4.012 16.737A2.005 2.005.0 013 15V5c0-1.1.9-2 2-2h10c.75.0 1.158.385 1.5 1"/></svg></i></div><div class="hidden top-1 right-1" id=code-copy-done><i class="h-6 w-6 block"><svg class="icon icon-tabler icon-tabler-check" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 12l5 5L20 7"/></svg></i></div><script src=/code-copy.min.e7b2a74adef1ed474c335c8bd5e7832b2316b8842b0f9184d65286c5bd64f51a.js></script></body></html>