<!doctype html><html lang=en dir=ltr><head><title>Diving into the art of userspace exploitation under Android - Introducing E²VA (Part 1) :: lolcads tech blog</title>
<meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Investigating Binary Exploitation for JNI on Android This post aims to be an introduction into a blog series about binary exploitation on Android. It tries to describe how the environment that runs vulnerable modules is set up and how the damnvulnerableapp supports the process of binary exploitation on Android.
Warning The following app is intended to be vulnerable to specific attacks and can result in arbitrary code execution in the context of the app."><meta name=keywords content="Android,Binary Exploitation,JNI,E²VA"><meta name=robots content="noodp"><link rel=manifest href=/manifest.json><meta property="og:url" content="https://lolcads.github.io/posts/2022/11/diving_into_the_art_of_userspace_exploitation_under_android/"><meta property="og:site_name" content="lolcads tech blog"><meta property="og:title" content="Diving into the art of userspace exploitation under Android - Introducing E²VA (Part 1)"><meta property="og:description" content="Investigating Binary Exploitation for JNI on Android This post aims to be an introduction into a blog series about binary exploitation on Android. It tries to describe how the environment that runs vulnerable modules is set up and how the damnvulnerableapp supports the process of binary exploitation on Android.
Warning The following app is intended to be vulnerable to specific attacks and can result in arbitrary code execution in the context of the app."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-11-21T18:54:42+01:00"><meta property="article:modified_time" content="2022-11-21T18:54:42+01:00"><meta property="article:tag" content="Android"><meta property="article:tag" content="Binary Exploitation"><meta property="article:tag" content="JNI"><meta property="article:tag" content="E²VA"><meta name=twitter:card content="summary"><meta name=twitter:title content="Diving into the art of userspace exploitation under Android - Introducing E²VA (Part 1)"><meta name=twitter:description content="Investigating Binary Exploitation for JNI on Android This post aims to be an introduction into a blog series about binary exploitation on Android. It tries to describe how the environment that runs vulnerable modules is set up and how the damnvulnerableapp supports the process of binary exploitation on Android.
Warning The following app is intended to be vulnerable to specific attacks and can result in arbitrary code execution in the context of the app."><link rel=canonical href=https://lolcads.github.io/posts/2022/11/diving_into_the_art_of_userspace_exploitation_under_android/><link rel="shortcut icon" href=/favicon.ico><link rel=stylesheet href=/css/index.min.c860e17f20d9f258820c02bf7ab3f57c9595d0bc21dede7eda08ccd63ba3f4cc.css></head><body class="flex flex-col min-h-screen w-full bg-slate-50 dark:bg-gray-800"><header class="flex flex-none justify-center z-10"><div class="flex flex-row gap justify-between w-full max-w-4xl lg:max-w-5xl h-12 mt-3"><div class="flex-none ml-2 md:ml-0"><a href=/><img class="h-12 w-12 rounded-full object-cover bg-gray-100" src=/logo.png alt=logo></a></div><div class=flex-1></div><div class=flex-none><nav class="h-full static"><button id=navbar-menu-toggle type=button class="inline-flex items-center p-2 text-sm text-slate-800 dark:text-slate-200 rounded-lg md:hidden" aria-controls=navbar-menu aria-expanded=false>
<span class=sr-only>Open main menu</span>
<i class="w-8 h-8"><svg class="icon icon-tabler icon-tabler-menu-2" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 6h16"/><path d="M4 12h16"/><path d="M4 18h16"/></svg></i></button><div class="absolute md:static top-16 left-0 right-0 z-50 hidden w-full md:block md:w-auto" id=navbar-menu><ul class="flex flex-col mx-2 md:mx-0 md:flex-row md:border-0 rounded-sm md:rounded-full px-3 text-base font-medium text-slate-800 dark:text-slate-200 shadow-lg bg-white dark:bg-gray-600 shadow-slate-800/5 dark:shadow-slate-200/5 ring-1 ring-slate-900/5 dark:ring-slate-100/5"><li id=post><a class="block px-3 py-3 hover:text-emerald-600 text-emerald-600" href=/posts/ title=Blog>Blog</a></li><li id=about><a class="block px-3 py-3 hover:text-emerald-600" href=/about/ title=About>About</a></li><li id=contact><a class="block px-3 py-3 hover:text-emerald-600" href=/contact/ title=Contact>Contact</a></li></ul></div></nav></div><div class="flex-none mx-1"></div><div class="flex-none md:hidden"><a href=/search/ class="inline-flex items-center p-2 text-sm text-slate-800 dark:text-slate-200 rounded-lg" aria-controls=navbar-menu aria-expanded=false><span class=sr-only>Search</span>
<i class="w-8 h-8"><svg class="icon icon-tabler icon-tabler-search" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M10 10m-7 0a7 7 0 1014 0A7 7 0 103 10"/><path d="M21 21l-6-6"/></svg></i></a></div><div class="darkmode-toggle flex flex-none mr-2 md:mr-0"><label for=darkmode-toggle class="flex items-center px-3 cursor-pointer rounded-full bg-gray-100 dark:bg-gray-600" title="Toggle dark mode"><input name=darkmode-toggle id=darkmode-toggle type=checkbox class="sr-only peer" aria-label="Toggle dark mode"><div class="group flex flex-row gap-1 justify-center h-8 px-1 rounded-full bg-white dark:bg-gray-700"><i class="h-6 w-6 flex-none rounded-full bg-yellow-400 place-self-center peer-checked:group-[]:invisible"><svg class="icon icon-tabler icon-tabler-brightness-down" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 12m-3 0a3 3 0 106 0 3 3 0 10-6 0"/><path d="M12 5v.01"/><path d="M17 7v.01"/><path d="M19 12v.01"/><path d="M17 17v.01"/><path d="M12 19v.01"/><path d="M7 17v.01"/><path d="M5 12v.01"/><path d="M7 7v.01"/></svg>
</i><i class="h-6 w-6 flex-none rounded-full place-self-center invisible peer-checked:group-[]:visible"><svg class="icon icon-tabler icon-tabler-moon-stars" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 3c.132.0.263.0.393.0a7.5 7.5.0 007.92 12.446A9 9 0 1112 2.992z"/><path d="M17 4a2 2 0 002 2 2 2 0 00-2 2 2 2 0 00-2-2 2 2 0 002-2"/><path d="M19 11h2m-1-1v2"/></svg></i></div></label></div></div></header><main class="flex flex-auto justify-center"><div class="w-full max-w-4xl lg:max-w-5xl"><div class="flex flex-col mt-6 mx-2 md:mx-0 rounded-lg overflow-hidden shadow-md bg-white dark:bg-gray-700"><div><a href=/posts/2022/11/diving_into_the_art_of_userspace_exploitation_under_android/></a></div><div class="flex flex-col gap-y-3 p-6"><h1 class="text-4xl font-semibold text-slate-800 dark:text-slate-100"><a href=/posts/2022/11/diving_into_the_art_of_userspace_exploitation_under_android/>Diving into the art of userspace exploitation under Android - Introducing E²VA (Part 1)</a></h1><ul class="flex flex-row flex-wrap text-slate-500 dark:text-slate-300"><li><a href=/tags/android/ class="flex flex-row text-sm mr-2 py-1"><i class="h-5 w-5 flex-none"><svg class="icon icon-tabler icon-tabler-hash" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 9h14"/><path d="M5 15h14"/><path d="M11 4 7 20"/><path d="M17 4l-4 16"/></svg>
</i><span class=ml-0>Android</span></a></li><li><a href=/tags/binary-exploitation/ class="flex flex-row text-sm mr-2 py-1"><i class="h-5 w-5 flex-none"><svg class="icon icon-tabler icon-tabler-hash" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 9h14"/><path d="M5 15h14"/><path d="M11 4 7 20"/><path d="M17 4l-4 16"/></svg>
</i><span class=ml-0>Binary Exploitation</span></a></li><li><a href=/tags/jni/ class="flex flex-row text-sm mr-2 py-1"><i class="h-5 w-5 flex-none"><svg class="icon icon-tabler icon-tabler-hash" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 9h14"/><path d="M5 15h14"/><path d="M11 4 7 20"/><path d="M17 4l-4 16"/></svg>
</i><span class=ml-0>JNI</span></a></li><li><a href=/tags/eva/ class="flex flex-row text-sm mr-2 py-1"><i class="h-5 w-5 flex-none"><svg class="icon icon-tabler icon-tabler-hash" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 9h14"/><path d="M5 15h14"/><path d="M11 4 7 20"/><path d="M17 4l-4 16"/></svg>
</i><span class=ml-0>E²VA</span></a></li></ul><div class="flex flex-col gap-y-1 md:flex-row md:gap-y-0 md:gap-x-4 text-slate-500 dark:text-slate-300"><div class="flex flex-row text-base gap-x-1"><i class="h-6 w-6 flex-none"><svg class="icon icon-tabler icon-tabler-calendar" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 7a2 2 0 012-2h12a2 2 0 012 2v12a2 2 0 01-2 2H6a2 2 0 01-2-2V7z"/><path d="M16 3v4"/><path d="M8 3v4"/><path d="M4 11h16"/><path d="M11 15h1"/><path d="M12 15v3"/></svg>
</i><time datetime=2022-11-21T18:54:42+01:00>2022-11-21</time></div><div class="flex flex-row text-base gap-x-1"><i class="h-6 w-6 flex-none"><svg class="icon icon-tabler icon-tabler-hourglass-high" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M6.5 7h11"/><path d="M6 20v-2a6 6 0 1112 0v2a1 1 0 01-1 1H7a1 1 0 01-1-1z"/><path d="M6 4v2a6 6 0 1012 0V4a1 1 0 00-1-1H7A1 1 0 006 4z"/></svg>
</i><span>8 minutes to read</span></div></div><section class="prose prose-slate dark:prose-invert w-full max-w-4xl lg:max-w-5xl mt-6"><h2>Table of Contents</h2><aside><nav id=TableOfContents><ul><li><a href=#warning>Warning</a></li><li><a href=#esup2supva-the-damnvulnerableapp><em>E<sup>2</sup>VA</em>, the <em>damnvulnerableapp</em></a><ul><li><a href=#architecture>Architecture</a></li><li><a href=#running-vulnerable-modules>Running Vulnerable Modules</a></li></ul></li></ul><ul><li><a href=#getting-started>Getting started</a></li></ul></nav></aside></section><article class="mt-6 w-full max-w-4xl lg:max-w-5xl prose prose-slate dark:prose-invert prose-quoteless post-content"><h1 id=investigating-binary-exploitation-for-jni-on-android>Investigating Binary Exploitation for JNI on Android</h1><p>This post aims to be an introduction into a blog series about binary exploitation on Android. It tries to describe how the environment that runs vulnerable modules is set up and how the <em>damnvulnerableapp</em> supports the process of binary exploitation on Android.</p><h2 id=warning>Warning</h2><p>The following app is intended to be vulnerable to specific attacks and can result in arbitrary code execution in the context of the app. Therefore, beware of this and do not use this app on a device/emulator that contains personal information whatsoever. Always launch the app in a controlled environment. <strong>No authentication</strong> is necessary to connect to the app and talk to vulnerable modules. Assuming the app is free of bugs, there is a guarantee that only one client can connect at a time.</p><h2 id=esup2supva-the-damnvulnerableapp><em>E<sup>2</sup>VA</em>, the <em>damnvulnerableapp</em></h2><p>In order to properly investigate binary exploitation on Android, an app has been written that allows for running custom vulnerable modules, i.e. Java classes with one entry point, in a separate process. It is remotely controllable and constructed in a way that allows to (re-)run a module multiple times even when it crashed.</p><p>The app is named <strong>E<sup>2</sup>VA</strong>, i.e. <em>Exploitation Experience (with) Vulnerable App</em>. Within this blog series, <em>E<sup>2</sup>VA</em> and <em>damnvulnerableapp</em> will be used interchangably, so do not get confused!</p><p>The core of the <em>damnvulnerableapp</em> is a background service, called <em>manager</em>, that handles communication with external users (only one at a time) and translates the messages received into actions to perform. Among other things, the most important actions are:</p><ol><li>Selecting a vulnerable module to be run in a <strong>separate process</strong>. This has to be done, because it is <strong>very</strong> likely that the vulnerable module will crash in case we mess up with an exploit.</li><li>Exiting a vulnerable module. This will shutdown the process that hosts the vulnerable module and revert back to a selection state.</li><li>Forwarding messages to the vulnerable module. It is possible to forward arbitrary binary data. Of course it is up to the module to accept this or not. E.g. if a vulnerable module internally calls <code>strcpy</code>, sending arbitrary binary data will probably not do the trick.</li><li>Fetching messages from the vulnerable module. When sending a fetch request, the <em>manager</em> will try to read data from the vulnerable module. Depending on the configurations, this can time out or block forever.</li></ol><p>Therefore, the usual steps are:</p><ol><li>Select a module</li><li>Forward and fetch data until done, i.e. either until the process crashes or exits by itself or is instructed by an external user to terminate.</li><li>Optionally, when trying to terminate the hosting process, <em>manager</em> can be instructed to do so.</li></ol><p>As regards selecting a module, the following diagram tries to illustrate this process:<div class=not-prose><figure><img src=/2022/11/eva_0_request_example_2.svg alt="Selecting a module" loading=lazy></figure></div></p><p>Notice that the <em>Zygote</em> process is responsible for creating a new activity by forking. Therefore, the vulnerable process will contain e.g. the same canary as the manager app, which was also forked from <em>Zygote</em>.</p><p>In addition to selecting a module, the next diagram describes how data is fetched from a module and sent to an external user:<div class=not-prose><figure><img src=/2022/11/eva_0_request_example_3.svg alt="Forwarding message to a module" loading=lazy></figure></div></p><p>If a vulnerable module crashes, e.g. due to a failed exploitation attempt, then the <em>manager</em> will detect this and revert back to the selection state. Therefore, one may select a new module immediately after the old module crashed. It is advised to <strong>not</strong> flood <em>manager</em> with commands as it takes time to spawn a process or detect that a process died. The latter heavily depends on the configurations and the module&rsquo;s content.</p><p>Also, the app requires specific privileges in order to avoid being rendered irresponsive after some time (often after 10s). To that end the app requests <a href=https://developer.android.com/reference/android/provider/Settings#ACTION_MANAGE_OVERLAY_PERMISSION target=_blank rel=noopener><code>ACTION_MANAGE_OVERLAY_PERMISSION</code></a>
(which is a runtime permission that can be dangerous, so please run the app on a device/emulator that does not contain personal information whatsoever, just in case <em>damnvulnerableapp</em> gets hijacked by someone other than you). This permission seems to keep the <em>manager</em> alive.</p><h3 id=architecture>Architecture</h3><p><em>damnvulnerableapp</em> is tested on an x86_64 Pixel 3 emulator that runs Android 12.0.0. The build number is <a href=https://source.android.com/docs/setup/about/build-numbers#build-ids-defined target=_blank rel=noopener><code>SE1A.220203.002.A1</code></a>
. Therefore, all exploits that involve shellcode will contain x86_64 assembly.</p><h3 id=running-vulnerable-modules>Running Vulnerable Modules</h3><p>Assuming there is a vulnerable module to be run, the <em>manager</em> can be started from <a href=https://developer.android.com/studio target=_blank rel=noopener><em>Android Studio</em></a>
or via <a href=https://developer.android.com/studio/command-line/adb target=_blank rel=noopener><code>adb</code></a>
. Also <em>damnvulnerableapp</em> should be launched in debug mode. Technically speaking, there is no need to start the app from <em>Android Studio</em> other than being able to attach <em>lldb</em> to the vulnerable module, as well as to adjust configurations to avoid timeouts etc. In order to get to more realistic binary exploitation, one should start with the <code>.apk</code> file, start the app from console and go from there.</p><p>Another thing to consider is that one should <strong>not</strong> try to call e.g. <code>execve</code> in the vulnerable process. This comes from the fact that e.g. <code>execve</code> will &ldquo;destroy&rdquo; the actual vulnerable process, thus shutting down the connection to <em>manager</em>. As <em>manager</em> will assume the process to be dead, because the connection broke, it will attempt to fully kill remnants of the vulnerable process and then revert back to a select state. Thus, calling e.g. <code>execve</code> dooms the vulnerabe process to be destroyed by <em>manager</em>. One may think of this as an additional security mechanism, or just a reminder that stealthy exploits are cooler than loud one - shot exploits.</p><h4 id=types-of-vulnerable-modules>Types of vulnerable modules</h4><p>In order to allow for as many perspectives as possible for binary exploitation on Android, each vulnerable module encapsulates one of the following:</p><ol><li>a completely different vulnerability class than all the other modules. E.g. <em>buffer - overflow</em> vs. <em>use - after - free</em>.</li><li>a slightly modified version of a fixed vulnerability class. E.g. a <em>use - after - free</em> vulnerability can result in a <em>Write - What - Where</em> condition or in an attacker being able to execute a chosen function, depending on the implementation.</li></ol><p>Consider the composition of a vulnerable module:<div class=not-prose><figure><img src=/2022/11/eva_0_composition.svg alt="Composition of vulnerable modules" loading=lazy></figure></div></p><p>As can be seen in the above diagram, every (currently) module uses JNI functions to introduce vulnerabilities to be exploited. This is where binary exploitation becomes applicable to Java, namely due to native function calls.</p><h4 id=communication-with-vulnerable-modules>Communication with vulnerable modules</h4><p><em>damnvulnerableapp</em> will listen for incoming connections on port <code>8080</code>. If it is run on an emulator, an external user may connect through <code>nc 127.0.0.1 8080</code>. Before this is possible, one needs to run</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ adb forward tcp:8080 tcp:8080
</span></span></code></pre></div><p>Otherwise, establishing a connection is refused. When trying to create a callback (or reverse shell etc.) in an emulator, i.e. establishing a connection from the emulator to the host, use <code>nc 10.0.2.2 &lt;port></code>. According to <a href=https://developer.android.com/studio/run/emulator-networking target=_blank rel=noopener>docs</a>
, <code>10.0.2.2</code> is a &ldquo;special alias to your host loopback interface&rdquo;.</p><p>The <em>manager</em> will only react to messages from an external user, i.e. it uses a <em>request - response</em> model to handle communication. Therefore, an external agent must not assume that it will be informed if the vulnerable module has a non - empty output queue. An external user always has to explicitly ask the <em>manager</em> to fetch available output data.</p><p>In order to ease communication with the <em>damnvulnerableapp</em> and therefore the vulnerable modules, a client emerged that wraps the most important functionalities required to interact with the modules. The client is based on <a href=https://docs.pwntools.com/en/stable/ target=_blank rel=noopener><code>pwntools</code></a>
, but can easily be translated to work with plain <a href=https://docs.python.org/3/library/socket.html target=_blank rel=noopener><code>sockets</code></a>
aswell.</p><p>The following is the implementation of the <code>pwntools</code> - based client (no guarantees for correctness and completeness):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=ch>#!/usr/bin/env python3</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>Tuple</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>TIMEOUT</span> <span class=o>=</span> <span class=mi>5</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>PwnClient</span><span class=p>:</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>host</span> <span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>port</span> <span class=p>:</span> <span class=nb>int</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>io</span> <span class=o>=</span> <span class=n>remote</span><span class=p>(</span><span class=n>host</span><span class=p>,</span> <span class=n>port</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>handshake</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>handshake</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;USER&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;INIT&#39;</span><span class=p>,</span> <span class=n>capsule_type</span><span class=o>=</span><span class=sa>b</span><span class=s1>&#39;INIT&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>receive</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>close</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;SHUTDOWN&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>receive</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=n>capsule_type</span><span class=o>=</span><span class=sa>b</span><span class=s1>&#39;ACK&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>io</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>send</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>message</span> <span class=p>:</span> <span class=nb>bytes</span><span class=p>,</span> <span class=n>operation</span><span class=p>,</span> <span class=n>capsule_type</span><span class=o>=</span><span class=sa>b</span><span class=s1>&#39;CONTENT&#39;</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>capsule</span> <span class=o>=</span> <span class=n>capsule_type</span> <span class=o>+</span> <span class=sa>b</span><span class=s1>&#39; &#39;</span> <span class=o>+</span> <span class=n>operation</span> <span class=o>+</span> <span class=sa>b</span><span class=s1>&#39; CONTENT &#39;</span> <span class=o>+</span> <span class=n>message</span>
</span></span><span class=line><span class=cl>        <span class=n>length</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>capsule</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>p32</span><span class=p>(</span><span class=n>length</span><span class=p>,</span> <span class=n>endian</span><span class=o>=</span><span class=s1>&#39;big&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>io</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>capsule</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>block_receive</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>num_bytes</span> <span class=p>:</span> <span class=nb>int</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>bytes</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>message</span> <span class=o>=</span> <span class=sa>b</span><span class=s1>&#39;&#39;</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>message</span><span class=p>)</span> <span class=o>&lt;</span> <span class=n>num_bytes</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>received</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>io</span><span class=o>.</span><span class=n>recv</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=n>timeout</span><span class=o>=</span><span class=n>TIMEOUT</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>received</span> <span class=ow>and</span> <span class=nb>len</span><span class=p>(</span><span class=n>received</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                <span class=n>message</span> <span class=o>+=</span> <span class=n>received</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>message</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>    Returns:
</span></span></span><span class=line><span class=cl><span class=s2>        (length, capsule_type, operation, content)
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>receive</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Tuple</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>bytes</span><span class=p>,</span> <span class=nb>bytes</span><span class=p>,</span> <span class=nb>bytes</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>        <span class=n>length</span> <span class=o>=</span> <span class=n>u32</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>block_receive</span><span class=p>(</span><span class=mi>4</span><span class=p>),</span> <span class=n>endian</span><span class=o>=</span><span class=s1>&#39;big&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>message</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>block_receive</span><span class=p>(</span><span class=n>length</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>split_message</span> <span class=o>=</span> <span class=n>message</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39; &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>operation</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>split_message</span><span class=p>)</span> <span class=o>&gt;=</span> <span class=mi>2</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>operation</span> <span class=o>=</span> <span class=n>split_message</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>content</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>split_message</span><span class=p>)</span> <span class=o>&gt;=</span> <span class=mi>4</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=n>content</span> <span class=o>=</span> <span class=sa>b</span><span class=s1>&#39; &#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>split_message</span><span class=p>[</span><span class=mi>3</span><span class=p>:])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>(</span><span class=n>length</span><span class=p>,</span> <span class=n>split_message</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>operation</span><span class=p>,</span> <span class=n>content</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>select</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>module_name</span> <span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>module_name</span><span class=o>.</span><span class=n>encode</span><span class=p>(</span><span class=s1>&#39;utf-8&#39;</span><span class=p>),</span> <span class=sa>b</span><span class=s1>&#39;SELECT&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>receive</span><span class=p>()[</span><span class=mi>3</span><span class=p>]</span><span class=o>.</span><span class=n>decode</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>forward</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>message</span> <span class=p>:</span> <span class=nb>bytes</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=n>message</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;FORWARD&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>receive</span><span class=p>()[</span><span class=mi>3</span><span class=p>]</span><span class=o>.</span><span class=n>decode</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>fetch</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>bytes</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;FETCH&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>receive</span><span class=p>()[</span><span class=mi>3</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>exit</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>send</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=sa>b</span><span class=s1>&#39;EXIT&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>res</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>receive</span><span class=p>()[</span><span class=mi>3</span><span class=p>]</span><span class=o>.</span><span class=n>decode</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>io</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>res</span>
</span></span></code></pre></div><p>A sample program could look like this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>main</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span> <span class=o>=</span> <span class=n>PwnClient</span><span class=p>(</span><span class=s1>&#39;127.0.0.1&#39;</span><span class=p>,</span> <span class=mi>8080</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>io</span><span class=o>.</span><span class=n>fetch</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>forward</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;test123&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>io</span><span class=o>.</span><span class=n>fetch</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=n>io</span><span class=o>.</span><span class=n>exit</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=vm>__name__</span> <span class=o>==</span> <span class=s1>&#39;__main__&#39;</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>main</span><span class=p>()</span>
</span></span></code></pre></div><h1 id=summary>Summary</h1><p>In this post, <em>damnvulnerableapp</em> aka <em>E<sup>2</sup>VA</em> was presented as an Android app that manages custom vulnerable modules that can be used for vulnerability research on Android OS&rsquo;s. To that end, the modules try to cover different vulnerability classes to allow for discovery of Android - specific difficulities in binary exploitation.
In our next post we dive into the first vulnerability and how to exploit it. Stay tuned.</p><h2 id=getting-started>Getting started</h2><p>E<sup>2</sup>VA can be downloaded here: <a href=https://github.com/fkie-cad/eeva target=_blank rel=noopener>https://github.com/fkie-cad/eeva</a></p></article></div></div></div></main><footer class="flex flex-none justify-center"><section class="flex flex-col md:flex-row mx-2 md:mx-0 gap-2 md:gap-0 justify-between w-full max-w-4xl lg:max-w-5xl py-6 text-slate-500 dark:text-slate-300"><div class="flex flex-row"></div><div class=grow></div><div class="flex flex-row"><i class="h-6 w-6 flex-none"><svg class="icon icon-tabler icon-tabler-copyright" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 12m-9 0a9 9 0 1018 0A9 9 0 103 12"/><path d="M14 9.75a3.016 3.016.0 00-4.163.173 2.993 2.993.0 000 4.154A3.016 3.016.0 0014 14.25"/></svg>
</i>2022 - 2024 lolcads</div><div class="flex flex-row"><span class="ml-0 pl-0 md:ml-2 md:pl-2 border-l-0 md:border-l border-slate-300 dark:border-slate-400">Powered by <a href=https://gohugo.io target=_blank rel=noopener class=underline>Hugo</a> <span class=text-red-600>&#9829;</span> <a href=https://github.com/tomowang/hugo-theme-tailwind target=_blank rel=noopener class=underline>Tailwind</a></span></div></section></footer><script src=/main.min.c6372b6836971865bd94bfde974748aca8415824a2facab6ccd66a87384bfacb.js></script><div class="hidden top-1 right-1" id=code-copy><i class="h-6 w-6 block"><svg class="icon icon-tabler icon-tabler-copy" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M7 7m0 2.667A2.667 2.667.0 019.667 7h8.666A2.667 2.667.0 0121 9.667v8.666A2.667 2.667.0 0118.333 21H9.667A2.667 2.667.0 017 18.333z"/><path d="M4.012 16.737A2.005 2.005.0 013 15V5c0-1.1.9-2 2-2h10c.75.0 1.158.385 1.5 1"/></svg></i></div><div class="hidden top-1 right-1" id=code-copy-done><i class="h-6 w-6 block"><svg class="icon icon-tabler icon-tabler-check" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 12l5 5L20 7"/></svg></i></div><script src=/code-copy.min.e7b2a74adef1ed474c335c8bd5e7832b2316b8842b0f9184d65286c5bd64f51a.js></script></body></html>