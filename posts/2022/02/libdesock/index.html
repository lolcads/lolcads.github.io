<!doctype html><html lang=en dir=ltr><head><title>libdesock :: lolcads tech blog</title>
<meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Fuzzing Network Applications with AFL and libdesock Fuzzing network servers with AFL is challenging since AFL provides its input via stdin or command line arguments while servers get their input over network connections. As the popularity of AFL grew, many attempts have been made of fuzzing popular servers like apache and nginx using different techniques and hacky workarounds. However an off-the-shelf network fuzzing solution for AFL didn&rsquo;t exist for a long time until so-called &ldquo;desocketing&rdquo; tools emerged."><meta name=keywords content="fuzzing,network,sockets,emulation"><meta name=robots content="noodp"><link rel=manifest href=/manifest.json><meta property="og:url" content="https://lolcads.github.io/posts/2022/02/libdesock/"><meta property="og:site_name" content="lolcads tech blog"><meta property="og:title" content="libdesock"><meta property="og:description" content="Fuzzing Network Applications with AFL and libdesock Fuzzing network servers with AFL is challenging since AFL provides its input via stdin or command line arguments while servers get their input over network connections. As the popularity of AFL grew, many attempts have been made of fuzzing popular servers like apache and nginx using different techniques and hacky workarounds. However an off-the-shelf network fuzzing solution for AFL didn’t exist for a long time until so-called “desocketing” tools emerged."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-02-22T14:24:40+01:00"><meta property="article:modified_time" content="2022-02-22T14:24:40+01:00"><meta property="article:tag" content="Fuzzing"><meta property="article:tag" content="Network"><meta property="article:tag" content="Sockets"><meta property="article:tag" content="Emulation"><meta name=twitter:card content="summary"><meta name=twitter:title content="libdesock"><meta name=twitter:description content="Fuzzing Network Applications with AFL and libdesock Fuzzing network servers with AFL is challenging since AFL provides its input via stdin or command line arguments while servers get their input over network connections. As the popularity of AFL grew, many attempts have been made of fuzzing popular servers like apache and nginx using different techniques and hacky workarounds. However an off-the-shelf network fuzzing solution for AFL didn’t exist for a long time until so-called “desocketing” tools emerged."><link rel=canonical href=https://lolcads.github.io/posts/2022/02/libdesock/><link rel="shortcut icon" href=/favicon.ico><link rel=stylesheet href=/css/index.min.c860e17f20d9f258820c02bf7ab3f57c9595d0bc21dede7eda08ccd63ba3f4cc.css></head><body class="flex flex-col min-h-screen w-full bg-slate-50 dark:bg-gray-800"><header class="flex flex-none justify-center z-10"><div class="flex flex-row gap justify-between w-full max-w-4xl lg:max-w-5xl h-12 mt-3"><div class="flex-none ml-2 md:ml-0"><a href=/><img class="h-12 w-12 rounded-full object-cover bg-gray-100" src=/logo.png alt=logo></a></div><div class=flex-1></div><div class=flex-none><nav class="h-full static"><button id=navbar-menu-toggle type=button class="inline-flex items-center p-2 text-sm text-slate-800 dark:text-slate-200 rounded-lg md:hidden" aria-controls=navbar-menu aria-expanded=false>
<span class=sr-only>Open main menu</span>
<i class="w-8 h-8"><svg class="icon icon-tabler icon-tabler-menu-2" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 6h16"/><path d="M4 12h16"/><path d="M4 18h16"/></svg></i></button><div class="absolute md:static top-16 left-0 right-0 z-50 hidden w-full md:block md:w-auto" id=navbar-menu><ul class="flex flex-col mx-2 md:mx-0 md:flex-row md:border-0 rounded-sm md:rounded-full px-3 text-base font-medium text-slate-800 dark:text-slate-200 shadow-lg bg-white dark:bg-gray-600 shadow-slate-800/5 dark:shadow-slate-200/5 ring-1 ring-slate-900/5 dark:ring-slate-100/5"><li id=post><a class="block px-3 py-3 hover:text-emerald-600 text-emerald-600" href=/posts/ title=Blog>Blog</a></li><li id=about><a class="block px-3 py-3 hover:text-emerald-600" href=/about/ title=About>About</a></li><li id=contact><a class="block px-3 py-3 hover:text-emerald-600" href=/contact/ title=Contact>Contact</a></li></ul></div></nav></div><div class="flex-none mx-1"></div><div class="flex-none md:hidden"><a href=/search/ class="inline-flex items-center p-2 text-sm text-slate-800 dark:text-slate-200 rounded-lg" aria-controls=navbar-menu aria-expanded=false><span class=sr-only>Search</span>
<i class="w-8 h-8"><svg class="icon icon-tabler icon-tabler-search" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M10 10m-7 0a7 7 0 1014 0A7 7 0 103 10"/><path d="M21 21l-6-6"/></svg></i></a></div><div class="darkmode-toggle flex flex-none mr-2 md:mr-0"><label for=darkmode-toggle class="flex items-center px-3 cursor-pointer rounded-full bg-gray-100 dark:bg-gray-600" title="Toggle dark mode"><input name=darkmode-toggle id=darkmode-toggle type=checkbox class="sr-only peer" aria-label="Toggle dark mode"><div class="group flex flex-row gap-1 justify-center h-8 px-1 rounded-full bg-white dark:bg-gray-700"><i class="h-6 w-6 flex-none rounded-full bg-yellow-400 place-self-center peer-checked:group-[]:invisible"><svg class="icon icon-tabler icon-tabler-brightness-down" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 12m-3 0a3 3 0 106 0 3 3 0 10-6 0"/><path d="M12 5v.01"/><path d="M17 7v.01"/><path d="M19 12v.01"/><path d="M17 17v.01"/><path d="M12 19v.01"/><path d="M7 17v.01"/><path d="M5 12v.01"/><path d="M7 7v.01"/></svg>
</i><i class="h-6 w-6 flex-none rounded-full place-self-center invisible peer-checked:group-[]:visible"><svg class="icon icon-tabler icon-tabler-moon-stars" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 3c.132.0.263.0.393.0a7.5 7.5.0 007.92 12.446A9 9 0 1112 2.992z"/><path d="M17 4a2 2 0 002 2 2 2 0 00-2 2 2 2 0 00-2-2 2 2 0 002-2"/><path d="M19 11h2m-1-1v2"/></svg></i></div></label></div></div></header><main class="flex flex-auto justify-center"><div class="w-full max-w-4xl lg:max-w-5xl"><div class="flex flex-col mt-6 mx-2 md:mx-0 rounded-lg overflow-hidden shadow-md bg-white dark:bg-gray-700"><div><a href=/posts/2022/02/libdesock/></a></div><div class="flex flex-col gap-y-3 p-6"><h1 class="text-4xl font-semibold text-slate-800 dark:text-slate-100"><a href=/posts/2022/02/libdesock/>libdesock</a></h1><ul class="flex flex-row flex-wrap text-slate-500 dark:text-slate-300"><li><a href=/tags/fuzzing/ class="flex flex-row text-sm mr-2 py-1"><i class="h-5 w-5 flex-none"><svg class="icon icon-tabler icon-tabler-hash" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 9h14"/><path d="M5 15h14"/><path d="M11 4 7 20"/><path d="M17 4l-4 16"/></svg>
</i><span class=ml-0>Fuzzing</span></a></li><li><a href=/tags/network/ class="flex flex-row text-sm mr-2 py-1"><i class="h-5 w-5 flex-none"><svg class="icon icon-tabler icon-tabler-hash" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 9h14"/><path d="M5 15h14"/><path d="M11 4 7 20"/><path d="M17 4l-4 16"/></svg>
</i><span class=ml-0>Network</span></a></li><li><a href=/tags/sockets/ class="flex flex-row text-sm mr-2 py-1"><i class="h-5 w-5 flex-none"><svg class="icon icon-tabler icon-tabler-hash" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 9h14"/><path d="M5 15h14"/><path d="M11 4 7 20"/><path d="M17 4l-4 16"/></svg>
</i><span class=ml-0>Sockets</span></a></li><li><a href=/tags/emulation/ class="flex flex-row text-sm mr-2 py-1"><i class="h-5 w-5 flex-none"><svg class="icon icon-tabler icon-tabler-hash" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 9h14"/><path d="M5 15h14"/><path d="M11 4 7 20"/><path d="M17 4l-4 16"/></svg>
</i><span class=ml-0>Emulation</span></a></li></ul><div class="flex flex-col gap-y-1 md:flex-row md:gap-y-0 md:gap-x-4 text-slate-500 dark:text-slate-300"><div class="flex flex-row text-base gap-x-1"><i class="h-6 w-6 flex-none"><svg class="icon icon-tabler icon-tabler-calendar" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 7a2 2 0 012-2h12a2 2 0 012 2v12a2 2 0 01-2 2H6a2 2 0 01-2-2V7z"/><path d="M16 3v4"/><path d="M8 3v4"/><path d="M4 11h16"/><path d="M11 15h1"/><path d="M12 15v3"/></svg>
</i><time datetime=2022-02-22T14:24:40+01:00>2022-02-22</time></div><div class="flex flex-row text-base gap-x-1"><i class="h-6 w-6 flex-none"><svg class="icon icon-tabler icon-tabler-hourglass-high" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M6.5 7h11"/><path d="M6 20v-2a6 6 0 1112 0v2a1 1 0 01-1 1H7a1 1 0 01-1-1z"/><path d="M6 4v2a6 6 0 1012 0V4a1 1 0 00-1-1H7A1 1 0 006 4z"/></svg>
</i><span>7 minutes to read</span></div></div><div class="flex flex-col gap-y-1 md:flex-row md:gap-y-0 md:gap-x-4 text-slate-500 dark:text-slate-300"><div class="flex flex-row text-base gap-x-1"><i class="h-6 w-6 flex-none"><svg viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-user"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M8 7a4 4 0 108 0A4 4 0 008 7"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
</i><span>Patrick Detering</span></div></div><section class="prose prose-slate dark:prose-invert w-full max-w-4xl lg:max-w-5xl mt-6"><h2>Table of Contents</h2><aside><nav id=TableOfContents><ul><li><a href=#what-is-desocketing>What is &ldquo;desocketing&rdquo;?</a></li><li><a href=#how-desocketing-works>How desocketing works</a></li><li><a href=#using-libdesock>Using libdesock</a></li><li><a href=#fuzzing-vsftpd>Fuzzing vsftpd</a><ul><li><a href=#getting-the-source>Getting the source</a></li><li><a href=#patching-the-source>Patching the source</a></li><li><a href=#build-configuration>Build configuration</a></li><li><a href=#runtime-configuration>Runtime configuration</a></li><li><a href=#start-fuzzing>Start fuzzing</a></li></ul></li></ul></nav></aside></section><article class="mt-6 w-full max-w-4xl lg:max-w-5xl prose prose-slate dark:prose-invert prose-quoteless post-content"><h1 id=fuzzing-network-applications-with-afl-and-libdesock>Fuzzing Network Applications with AFL and libdesock</h1><p>Fuzzing network servers with AFL is challenging since AFL provides its
input via stdin or command line arguments while servers get their input
over network connections.
As the popularity of AFL grew, many attempts have been made of fuzzing
popular servers like apache and nginx using different
techniques and hacky workarounds. However an off-the-shelf network fuzzing
solution for AFL didn&rsquo;t exist for a long time until so-called &ldquo;desocketing&rdquo;
tools emerged.
These desocketing tools enabled network fuzzing without
making a lot of additional modifications to the program under test
and quickly became widely used in combination with AFL.</p><h2 id=what-is-desocketing>What is &ldquo;desocketing&rdquo;?</h2><p>Before desocketing tools were published two common techniques for
network fuzzing were</p><ol><li>Sending fuzz input over real network connections</li><li>Modifying the target source to use stdin instead of sockets</li></ol><p>The first approach is the most prevalent used by popular fuzzers
like <a href=https://github.com/jtpereyda/boofuzz target=_blank rel=noopener>boofuzz</a>
or in academia by <a href=https://github.com/aflnet/aflnet target=_blank rel=noopener>AFLnet</a>
or <a href=https://github.com/stateafl/stateafl target=_blank rel=noopener>StateAFL</a>
.
This however suffers performance- and stability-drawbacks.
Stability is affected because the servers run with all threads and child processes
enabled. Background threads can be scheduled independently from the input being sent
resulting in invalid coverage information.
Performance is affected because of the amount of kernel activity and network overhead involved.</p><p>The second approach solves the network overhead problem but does not reduce the
kernel activity. It also takes a considerable amount of effort that may lead
to changing <a href=https://securitylab.github.com/research/fuzzing-sockets-FTP/ target=_blank rel=noopener>thousands of lines of code</a>
.</p><p>Desocketing aims to reduce kernel activity and the amount of modifications necessary to a program.
It works by building a shared library that implements functions
like <code>socket()</code> and <code>accept()</code> and preloading it via <code>LD_PRELOAD</code>
into the address space of a network application where it replaces
the network stack of the libc.
The desocketing library simulates incoming connections to the server
but every read on a socket is replaced by a read on stdin
and every write on a socket is redirected to stdout.
Strictly speaking the latter isn&rsquo;t necessary for fuzzing but it&rsquo;s useful
for debugging.</p><p>The following figure demonstrates how to desock nginx such that the network
traffic becomes visible on a terminal.</p><p><div class=not-prose><figure><img src=/2022/02/demo.svg alt loading=lazy></figure></div></p><h2 id=how-desocketing-works>How desocketing works</h2><p>Making desocketing libraries has its complexities.
AFLplusplus&rsquo; <a href=https://github.com/AFLplusplus/AFLplusplus/tree/stable/utils/socket_fuzzing target=_blank rel=noopener>socketfuzz</a>
ships a desocketing library that just returns <code>0</code> (stdin) in <code>accept()</code>.
Unfortunately this doesn&rsquo;t quite work because <code>send()</code> and <code>recv()</code> need an
fd that actually refers to a network connection. If you pass them an fd that
refers to a file the kernel will complain.
Thus we need more complicated methods.</p><p>At the time of writing this, there exists only one popular desocketing solution: <a href=https://github.com/zardus/preeny target=_blank rel=noopener>preeny</a>
.
preeny creates a socketpair <code>(a,b)</code> and spawns two threads <code>t1</code> and<code>t2</code> in every call to <code>socket()</code>.</p><ul><li>Thread <code>t1</code> forwards all data from stdin to <code>a</code></li><li>Thread <code>t2</code> forwards all data from <code>a</code> to stdout</li><li>In <code>socket()</code> preeny returns <code>b</code></li><li>When AFL writes input to stdin, thread <code>t1</code> forwards that data to <code>a</code></li><li>Writing to <code>a</code> means that the data will become available in <code>b</code> and the
application can read the request from <code>b</code></li><li>The application writes a response back to <code>b</code>, making the data available
in socket <code>a</code> where <code>t2</code> forwards it to stdout.</li></ul><p><div class=not-prose><figure><img src=/2022/02/preeny.png alt loading=lazy></figure></div></p><p>Unfortunately this design makes preeny unsuitable for fuzzing:</p><ol><li>Spawning threads and joining them introduces additional overhead.</li><li>Each thread realizes busy waiting by calling <code>poll()</code> every 15ms</li><li>Preeny still relies on a lot of kernel interaction. I/O multiplexing (select, poll, epoll)
is left completely to the kernel.</li><li>The threads may introduce additional instability.<br>Normally you want to disable threads when fuzzing with AFL.</li><li>It can handle only single-threaded applications but most of the servers
are multi-threaded</li></ol><p>A better desocketing library is needed that is more resource-efficient and handles the complexities of
modern network applications correctly.
So we created a new desocketing library: &ldquo;libdesock&rdquo;.</p><h2 id=using-libdesock>Using libdesock</h2><p>libdesock fully emulates the network stack of the kernel. The kernel is only queried to obtain file
descriptors and to do I/O on stdin and stdout.
Everything else - handling of connections, I/O multiplexing (select, poll, epoll), handling socket metadata (getsockname, getpeername) - entierly happens in userland.<br>In contrast to preeny, libdesock supports multi-threaded applications and its overall design
makes it more resource efficient and 5x faster than preeny.
This has no effect on AFL&rsquo;s exec/s though, since that primarily depends on the program
and the input.</p><p>We have tested libdesock on common network daemons like</p><ul><li>nginx</li><li>Apache httpd</li><li>OpenSSH</li><li>Exim</li><li>bind9</li><li>OpenVPN</li><li>Redis</li><li>dnsmasq</li><li>cupsd</li><li>curl (clients are supported too)</li></ul><p>and several smaller applications.<br>libdesock also supports event libraries like</p><ul><li>libevent</li><li>libuv</li><li>libapr-2</li></ul><p>Network applications generally are very complex and require modifications to be fuzzable with AFL.<br>They use multiple processes and threads, encryption, compression, checksums, hashes
and sometimes custom allocators that don&rsquo;t work with ASAN.
They also run in an endless loop and have a lot of disk I/O (pidfiles, logfiles, temporary files).
Setting these targets up for fuzzing means to reduce the complexity of the applications.
The following example demonstrates the modifications necessary to fuzz <a href=https://security.appspot.com/vsftpd.html target=_blank rel=noopener>vsftpd</a>
, a popular FTP server on Linux.</p><h2 id=fuzzing-vsftpd>Fuzzing vsftpd</h2><h3 id=getting-the-source>Getting the source</h3><p>Download version 3.0.5 of vsftpd:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>wget https://security.appspot.com/downloads/vsftpd-3.0.5.tar.gz
</span></span><span class=line><span class=cl>tar -xf vsftpd-3.0.5.tar.gz
</span></span><span class=line><span class=cl><span class=nb>cd</span> vsftpd-3.0.5
</span></span></code></pre></div><h3 id=patching-the-source>Patching the source</h3><p>vsftpd creates a new child process for each connection. We prohibit that
by commenting out the code that does the fork in <code>standalone.c</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-diff data-lang=diff><span class=line><span class=cl><span class=gu>@@ -153,6 +153,7 @@ vsf_standalone_main(void)
</span></span></span><span class=line><span class=cl><span class=gu></span>     child_info.num_this_ip = 0;
</span></span><span class=line><span class=cl>     p_raw_addr = vsf_sysutil_sockaddr_get_raw_addr(p_accept_addr);
</span></span><span class=line><span class=cl>     child_info.num_this_ip = handle_ip_count(p_raw_addr);
</span></span><span class=line><span class=cl><span class=gi>+    /*
</span></span></span><span class=line><span class=cl><span class=gi></span>     if (tunable_isolate)
</span></span><span class=line><span class=cl>     {
</span></span><span class=line><span class=cl>       if (tunable_http_enable &amp;&amp; tunable_isolate_network)
</span></span><span class=line><span class=cl><span class=gu>@@ -168,6 +169,8 @@ vsf_standalone_main(void)
</span></span></span><span class=line><span class=cl><span class=gu></span>     {
</span></span><span class=line><span class=cl>       new_child = vsf_sysutil_fork_failok();
</span></span><span class=line><span class=cl>     }
</span></span><span class=line><span class=cl><span class=gi>+    */
</span></span></span><span class=line><span class=cl><span class=gi>+    new_child = 0;
</span></span></span><span class=line><span class=cl><span class=gi></span>     if (new_child != 0)
</span></span><span class=line><span class=cl>     {
</span></span><span class=line><span class=cl>       /* Parent context */
</span></span></code></pre></div><p>vsftpd duplicates the FTP command socket to stdin, stdout and stderr.
This obviously interfers with AFL so we disable that in <code>defs.h</code> &mldr;</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-diff data-lang=diff><span class=line><span class=cl><span class=gu>@@ -3,7 +3,7 @@
</span></span></span><span class=line><span class=cl><span class=gu></span> 
</span></span><span class=line><span class=cl> #define VSFTP_DEFAULT_CONFIG    &#34;/etc/vsftpd.conf&#34;
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl><span class=gd>-#define VSFTP_COMMAND_FD        0
</span></span></span><span class=line><span class=cl><span class=gd></span><span class=gi>+#define VSFTP_COMMAND_FD        29
</span></span></span><span class=line><span class=cl><span class=gi></span> 
</span></span><span class=line><span class=cl> #define VSFTP_PASSWORD_MAX      128
</span></span><span class=line><span class=cl> #define VSFTP_USERNAME_MAX      128
</span></span></code></pre></div><p>&mldr; and in <code>standalone.c</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-diff data-lang=diff><span class=line><span class=cl><span class=gu>@@ -205,9 +205,7 @@ static void
</span></span></span><span class=line><span class=cl><span class=gu></span> prepare_child(int new_client_sock)
</span></span><span class=line><span class=cl> {
</span></span><span class=line><span class=cl>   /* We must satisfy the contract: command socket on fd 0, 1, 2 */
</span></span><span class=line><span class=cl><span class=gd>-  vsf_sysutil_dupfd2(new_client_sock, 0);
</span></span></span><span class=line><span class=cl><span class=gd>-  vsf_sysutil_dupfd2(new_client_sock, 1);
</span></span></span><span class=line><span class=cl><span class=gd>-  vsf_sysutil_dupfd2(new_client_sock, 2);
</span></span></span><span class=line><span class=cl><span class=gd></span><span class=gi>+  vsf_sysutil_dupfd2(new_client_sock, VSFTP_COMMAND_FD);
</span></span></span><span class=line><span class=cl><span class=gi></span>   if (new_client_sock &gt; 2)
</span></span><span class=line><span class=cl>   {
</span></span><span class=line><span class=cl>     vsf_sysutil_close(new_client_sock);
</span></span></code></pre></div><p>Next, vsftpd enforces a custom memory limit that interfers with ASAN.
We disable the memory limit in <code>sysutil.c</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-diff data-lang=diff><span class=line><span class=cl><span class=gu>@@ -2793,6 +2793,7 @@ void
</span></span></span><span class=line><span class=cl><span class=gu></span> vsf_sysutil_set_address_space_limit(unsigned long bytes)
</span></span><span class=line><span class=cl> {
</span></span><span class=line><span class=cl>   /* Unfortunately, OpenBSD is missing RLIMIT_AS. */
</span></span><span class=line><span class=cl><span class=gi>+  return;
</span></span></span><span class=line><span class=cl><span class=gi></span> #ifdef RLIMIT_AS
</span></span><span class=line><span class=cl>   int ret;
</span></span><span class=line><span class=cl>   struct rlimit rlim;
</span></span></code></pre></div><p>Then we add a forkserver to vsftpd in <code>prelogin.c</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-diff data-lang=diff><span class=line><span class=cl><span class=gu>@@ -59,6 +59,7 @@ init_connection(struct vsf_session* p_sess)
</span></span></span><span class=line><span class=cl><span class=gu></span>   {
</span></span><span class=line><span class=cl>     emit_greeting(p_sess);
</span></span><span class=line><span class=cl>   }
</span></span><span class=line><span class=cl><span class=gi>+  __AFL_INIT();
</span></span></span><span class=line><span class=cl><span class=gi></span>   parse_username_password(p_sess);
</span></span><span class=line><span class=cl> }
</span></span></code></pre></div><p>vsftpd registers a <code>SIGCHLD</code> handler that interfers with the forkserver
so we have to disable that too in <code>standalone.c</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-diff data-lang=diff><span class=line><span class=cl><span class=gu>@@ -74,7 +74,7 @@ vsf_standalone_main(void)
</span></span></span><span class=line><span class=cl><span class=gu></span>   {
</span></span><span class=line><span class=cl>     vsf_sysutil_setproctitle(&#34;LISTENER&#34;);
</span></span><span class=line><span class=cl>   }
</span></span><span class=line><span class=cl><span class=gd>-  vsf_sysutil_install_sighandler(kVSFSysUtilSigCHLD, handle_sigchld, 0, 1);
</span></span></span><span class=line><span class=cl><span class=gd></span><span class=gi>+  //vsf_sysutil_install_sighandler(kVSFSysUtilSigCHLD, handle_sigchld, 0, 1);
</span></span></span><span class=line><span class=cl><span class=gi></span>   vsf_sysutil_install_sighandler(kVSFSysUtilSigHUP, handle_sighup, 0, 1);
</span></span><span class=line><span class=cl>   if (tunable_listen)
</span></span><span class=line><span class=cl>   {
</span></span></code></pre></div><p>Last but not least we disable the <code>bug()</code> function in <code>utility.c</code>. This function does a failing <code>fcntl()</code>
on an fd returned by the desocketing library since the fd is not a real socket. vsftpd handles the <code>fcntl()</code> failure by calling <code>bug()</code> again
leading to an infinite loop.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-diff data-lang=diff><span class=line><span class=cl><span class=gu>@@ -40,6 +40,7 @@ die2(const char* p_text1, const char* p_text2)
</span></span></span><span class=line><span class=cl><span class=gu></span> void
</span></span><span class=line><span class=cl> bug(const char* p_text)
</span></span><span class=line><span class=cl> {
</span></span><span class=line><span class=cl><span class=gi>+  return;
</span></span></span><span class=line><span class=cl><span class=gi></span>   /* Rats. Try and write the reason to the network for diagnostics */
</span></span><span class=line><span class=cl>   vsf_sysutil_activate_noblock(VSFTP_COMMAND_FD);
</span></span><span class=line><span class=cl>   (void) vsf_sysutil_write_loop(VSFTP_COMMAND_FD, &#34;500 OOPS: &#34;, 10);
</span></span></code></pre></div><h3 id=build-configuration>Build configuration</h3><p>In the <code>Makefile</code> replace:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-diff data-lang=diff><span class=line><span class=cl><span class=gu>@@ -1,16 +1,16 @@
</span></span></span><span class=line><span class=cl><span class=gu></span> # Makefile for systems with GNU tools
</span></span><span class=line><span class=cl><span class=gd>-CC 	=	gcc
</span></span></span><span class=line><span class=cl><span class=gd></span><span class=gi>+CC 	=	afl-clang-fast
</span></span></span><span class=line><span class=cl><span class=gi></span> INSTALL	=	install
</span></span><span class=line><span class=cl> IFLAGS  = -idirafter dummyinc
</span></span><span class=line><span class=cl> #CFLAGS = -g
</span></span><span class=line><span class=cl><span class=gd>-CFLAGS	=	-O2 -fPIE -fstack-protector --param=ssp-buffer-size=4 \
</span></span></span><span class=line><span class=cl><span class=gd>-	-Wall -W -Wshadow -Werror -Wformat-security \
</span></span></span><span class=line><span class=cl><span class=gd></span><span class=gi>+CFLAGS	=	-fsanitize=address -g -Og -fPIE -fstack-protector \
</span></span></span><span class=line><span class=cl><span class=gi>+	-Wall -W -Wshadow -Wformat-security \
</span></span></span><span class=line><span class=cl><span class=gi></span>     -D_FORTIFY_SOURCE=2 \
</span></span><span class=line><span class=cl>     #-pedantic -Wconversion
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> LIBS	=	`./vsf_findlibs.sh`
</span></span><span class=line><span class=cl><span class=gd>-LINK	=	-Wl,-s
</span></span></span><span class=line><span class=cl><span class=gd>-LDFLAGS	=	-fPIE -pie -Wl,-z,relro -Wl,-z,now
</span></span></span><span class=line><span class=cl><span class=gd></span><span class=gi>+LINK	=	
</span></span></span><span class=line><span class=cl><span class=gi>+LDFLAGS	=	-fPIE -pie -Wl,-z,relro -Wl,-z,now -fsanitize=address
</span></span></span><span class=line><span class=cl><span class=gi></span> 
</span></span><span class=line><span class=cl> OBJS	=	main.o utility.o prelogin.o ftpcmdio.o postlogin.o privsock.o \
</span></span><span class=line><span class=cl>         tunables.o ftpdataio.o secbuf.o ls.o \
</span></span></code></pre></div><h3 id=runtime-configuration>Runtime configuration</h3><p>Like most other servers, vsftpd needs a config file. Create<code>fuzz.conf</code> with the following contents:</p><pre tabindex=0><code>listen=YES
seccomp_sandbox=NO
one_process_model=YES

# User management
anonymous_enable=YES
no_anon_password=YES
nopriv_user=nobody

# Permissions
connect_from_port_20=NO
run_as_launching_user=YES
listen_port=2121
listen_address=127.0.0.1
pasv_address=127.0.0.1

# Filesystem interactions
write_enable=NO
download_enable=NO
</code></pre><h3 id=start-fuzzing>Start fuzzing</h3><p>To use the desocketing library with AFL we need to set the <code>AFL_PRELOAD</code>
variable.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=nb>export</span> <span class=nv>AFL_PRELOAD</span><span class=o>=</span>libdesock.so
</span></span><span class=line><span class=cl>afl-fuzz -i corpus -o findings -m none -- ./vsftpd fuzz.conf
</span></span></code></pre></div><p><div class=not-prose><figure><img src=/2022/02/afl.svg alt loading=lazy></figure></div></p><p>Now it&rsquo;s only a matter of high-quality custom mutators and time to find some bugs.</p><p>libdesock can be downloaded here: <a href=https://github.com/fkie-cad/libdesock target=_blank rel=noopener>https://github.com/fkie-cad/libdesock</a></p></article></div></div></div></main><footer class="flex flex-none justify-center"><section class="flex flex-col md:flex-row mx-2 md:mx-0 gap-2 md:gap-0 justify-between w-full max-w-4xl lg:max-w-5xl py-6 text-slate-500 dark:text-slate-300"><div class="flex flex-row"></div><div class=grow></div><div class="flex flex-row"><i class="h-6 w-6 flex-none"><svg class="icon icon-tabler icon-tabler-copyright" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 12m-9 0a9 9 0 1018 0A9 9 0 103 12"/><path d="M14 9.75a3.016 3.016.0 00-4.163.173 2.993 2.993.0 000 4.154A3.016 3.016.0 0014 14.25"/></svg>
</i>2022 - 2024 lolcads</div><div class="flex flex-row"><span class="ml-0 pl-0 md:ml-2 md:pl-2 border-l-0 md:border-l border-slate-300 dark:border-slate-400">Powered by <a href=https://gohugo.io target=_blank rel=noopener class=underline>Hugo</a> <span class=text-red-600>&#9829;</span> <a href=https://github.com/tomowang/hugo-theme-tailwind target=_blank rel=noopener class=underline>Tailwind</a></span></div></section></footer><script src=/main.min.c6372b6836971865bd94bfde974748aca8415824a2facab6ccd66a87384bfacb.js></script><div class="hidden top-1 right-1" id=code-copy><i class="h-6 w-6 block"><svg class="icon icon-tabler icon-tabler-copy" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M7 7m0 2.667A2.667 2.667.0 019.667 7h8.666A2.667 2.667.0 0121 9.667v8.666A2.667 2.667.0 0118.333 21H9.667A2.667 2.667.0 017 18.333z"/><path d="M4.012 16.737A2.005 2.005.0 013 15V5c0-1.1.9-2 2-2h10c.75.0 1.158.385 1.5 1"/></svg></i></div><div class="hidden top-1 right-1" id=code-copy-done><i class="h-6 w-6 block"><svg class="icon icon-tabler icon-tabler-check" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 12l5 5L20 7"/></svg></i></div><script src=/code-copy.min.e7b2a74adef1ed474c335c8bd5e7832b2316b8842b0f9184d65286c5bd64f51a.js></script></body></html>